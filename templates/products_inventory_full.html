{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="StockWise">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>StockWise - Inventory Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/modern-inventory.css' %}">
    <!-- Select2 CSS for searchable selects -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #f8fafc;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --sidebar-width: 280px;
            --header-height: 80px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Same as dashboard */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            color: white;
        }

        .sidebar-brand i {
            font-size: 2rem;
            margin-right: 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            border-radius: 12px;
        }

        .sidebar-nav {
            padding: 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-400);
            padding: 0 1.5rem;
            margin-bottom: 0.75rem;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: 0;
            font-weight: 500;
            position: relative;
        }

        .nav-link:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-link.active {
            color: var(--primary);
            background: var(--primary-light);
            border-right: 3px solid var(--primary);
        }

        .nav-link i {
            font-size: 1.25rem;
            margin-right: 0.75rem;
            width: 1.5rem;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: var(--gray-50);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            height: var(--header-height);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-left h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        .header-subtitle {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            border: 2px solid var(--primary-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-avatar:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        /* Content Area */
        .content-area {
            padding: 2rem;
        }

        /* Modern Cards */
        .modern-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .modern-card:hover {
            box-shadow: var(--shadow-lg);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.primary::before { background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .stat-card.success::before { background: linear-gradient(90deg, var(--success), #059669); }
        .stat-card.warning::before { background: linear-gradient(90deg, var(--warning), #d97706); }
        .stat-card.danger::before { background: linear-gradient(90deg, var(--danger), #dc2626); }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
            margin-bottom: 0.75rem;
        }

        .stat-icon.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .stat-icon.success { background: linear-gradient(135deg, var(--success), #059669); }
        .stat-icon.warning { background: linear-gradient(135deg, var(--warning), #d97706); }
        .stat-icon.danger { background: linear-gradient(135deg, var(--danger), #dc2626); }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
        }

        .stat-label {
            color: var(--gray-500);
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.25rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }


        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-modern.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-modern.success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-modern.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        /* Filters Card */
        .filters-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            margin-bottom: 1.5rem;
        }

        .filters-row {
            display: grid;
            grid-template-columns: 1fr 200px 120px;
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control, .form-select {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .input-group {
            position: relative;
        }

        .input-group-text {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            z-index: 2;
            background: none;
            border: none;
            padding: 0;
        }

        .input-group .form-control {
            padding-left: 2.5rem;
        }

        /* Table */
        .table-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background: var(--gray-50);
            border: none;
            border-bottom: 2px solid var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
            padding: 1rem;
            font-size: 0.875rem;
        }

        .table tbody td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background: var(--gray-50);
        }

        /* Status Badges */
        .badge {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .badge.bg-success {
            background: var(--success) !important;
        }

        .badge.bg-danger {
            background: var(--danger) !important;
        }

        /* Stock Indicators */
        .stock-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stock-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stock-dot.high { background: var(--success); }
        .stock-dot.medium { background: var(--warning); }
        .stock-dot.low { background: var(--danger); }

        /* Action Buttons in Table */
        .btn-group .btn {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            margin-right: 0.25rem;
            transition: all 0.2s ease;
        }

        .btn-group .btn:hover {
            transform: translateY(-1px);
        }

        /* Modals */
        .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            border-radius: 16px 16px 0 0;
            padding: 1.5rem;
        }

        .modal-title {
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-body {
            padding: 1.5rem;
        }
        
        #stockQRScanner {
            min-height: 300px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }
        
        #stockQRScanner video {
            border-radius: 8px;
        }

        .modal-footer {
            border-top: 1px solid var(--gray-200);
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: 0 0 16px 16px;
        }

        /* Tabs Styling */
        .nav-tabs {
            border-bottom: 2px solid var(--gray-200);
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 8px 8px 0 0;
            margin-right: 0.5rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--gray-600);
            background: transparent;
            transition: all 0.2s ease;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            background: var(--primary-light);
            border-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background: white;
            border-color: var(--gray-200) var(--gray-200) white;
            font-weight: 600;
        }

        .nav-tabs .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 0 1rem;
            }

            /* Mobile menu toggle button - SHOW ON MOBILE */
            #mobileMenuToggle {
                display: flex !important;
                background: #007bff !important;
                border: 2px solid #000000 !important;
                color: #ffffff !important;
                min-width: 44px !important;
                min-height: 44px !important;
                position: relative !important;
                z-index: 9999 !important;
            }

            .content-area {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters-row {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tabs .nav-link {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
                margin-right: 0.25rem;
                margin-bottom: 0.25rem;
            }
        }

        /* Desktop - Hide mobile menu button */
        @media (min-width: 769px) {
            #mobileMenuToggle {
                display: none !important;
            }
        }
    </style>
    <style>
      /* Ensure scrollable modal-body occupies most of viewport */
      .modal-dialog-scrollable .modal-body {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }

      /* Record Sale Modal Styles */
      .sale-steps {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 2rem;
          margin-bottom: 2rem;
          padding: 1rem;
          background: #f8f9fa;
          border-radius: 12px;
      }

      .sale-step {
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
          min-width: 80px;
      }

      .sale-step i {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: #e9ecef;
          color: #6c757d;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 0.5rem;
          font-size: 1.2rem;
      }

      .sale-step.active i {
          background: var(--primary);
          color: white;
      }

      .sale-step-label {
          font-size: 0.875rem;
          font-weight: 500;
          color: #6c757d;
      }

      .sale-step.active .sale-step-label {
          color: var(--primary);
          font-weight: 600;
      }

      /* Payment Summary Table Styles */
      .payment-summary-table {
          width: 100%;
          max-width: 500px;
          margin: 0 auto 2rem;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          background: #fff;
      }

      .payment-summary-table tr {
          transition: background-color 0.2s ease;
      }

      .payment-summary-table tr:hover {
          background-color: rgba(211, 47, 47, 0.02);
      }

      .payment-summary-table th {
          background: #f8f9fa;
          color: #212529;
          font-weight: 600;
          padding: 1rem;
          text-align: left;
          border-bottom: 2px solid rgba(211, 47, 47, 0.1);
          width: 40%;
      }

      .payment-summary-table td {
          padding: 1rem;
          border-bottom: 1px solid rgba(0,0,0,0.05);
          font-weight: 500;
      }

      .payment-summary-table .amount {
          text-align: right;
          font-weight: 600;
          color: var(--primary);
      }

      .payment-summary-table .total-row th,
      .payment-summary-table .total-row td {
          background: rgba(211, 47, 47, 0.05);
          font-weight: 700;
          font-size: 1.1rem;
      }

      .payment-summary-table .amount-tendered th,
      .payment-summary-table .amount-tendered td {
          background: rgba(40, 167, 69, 0.05);
      }

      .payment-summary-table .change-row th,
      .payment-summary-table .change-row td {
          background: rgba(255, 193, 7, 0.05);
      }

      /* Receipt Styles */
      .receipt-container {
          max-width: 300px;
          margin: 0 auto;
          background: white;
          padding: 20px;
          border: 1px solid #ddd;
          font-family: 'Courier New', monospace;
          font-size: 12px;
      }

      .receipt-header {
          text-align: center;
          margin-bottom: 15px;
      }

      .company-name {
          font-weight: bold;
          font-size: 14px;
          margin-bottom: 5px;
      }

      .company-details {
          font-size: 10px;
          margin-bottom: 2px;
      }

      .receipt-title {
          text-align: center;
          font-weight: bold;
          font-size: 14px;
          margin-bottom: 10px;
          text-transform: uppercase;
      }

      .receipt-divider {
          border-top: 1px dashed #000;
          margin: 10px 0;
      }

      .receipt-info {
          margin-bottom: 3px;
          font-size: 11px;
      }

      .receipt-table {
          width: 100%;
          margin: 10px 0;
      }

      .receipt-table th,
      .receipt-table td {
          padding: 2px 5px;
          font-size: 11px;
      }

      .receipt-table th {
          border-bottom: 1px solid #000;
          font-weight: bold;
      }

      .align-right {
          text-align: right;
      }

      .receipt-summary {
          margin-top: 10px;
      }

      .receipt-summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 3px;
          font-size: 11px;
      }

      .receipt-summary-row.total {
          font-weight: bold;
          font-size: 12px;
          border-top: 1px solid #000;
          padding-top: 5px;
          margin-top: 5px;
      }

      .receipt-footer {
          text-align: center;
          margin-top: 15px;
          font-size: 10px;
      }

      .receipt-footer p {
          margin-bottom: 2px;
      }

      /* Item Row Styles */
      .item-row {
          background: #f8f9fa;
          border: 1px solid #e9ecef !important;
      }

      .stock-info {
          font-size: 0.75rem;
      }

      /* Button States */
      #nextToStep2:disabled {
          cursor: not-allowed;
          opacity: 0.7;
      }

      #nextToStep2:disabled:hover {
          background-color: var(--bs-secondary);
          border-color: var(--bs-secondary);
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
          .sale-steps {
              gap: 1rem;
              padding: 0.5rem;
          }
          
          .sale-step {
              min-width: 60px;
          }
          
          .sale-step i {
              width: 32px;
              height: 32px;
              font-size: 1rem;
          }
          
          .sale-step-label {
              font-size: 0.75rem;
          }
          
          .payment-summary-table {
              margin: 0 0 1rem 0;
          }
          
          .receipt-container {
              max-width: 280px;
              padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="{% url 'dashboard' %}" class="sidebar-brand">
                    <i class="bi bi-basket-fill"></i>
                    StockWise
                </a>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item">
                        <a href="{% url 'dashboard' %}" class="nav-link">
                            <i class="bi bi-speedometer2"></i>
                            Dashboard
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="{% url 'products_inventory' %}" class="nav-link active">
                            <i class="bi bi-basket"></i>
                            Inventory
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="{% url 'sales' %}" class="nav-link">
                            <i class="bi bi-cart"></i>
                            Sales
                        </a>
                    </div>
                </div>

                {% if app_role == 'admin' %}
                <div class="nav-section">
                    <div class="nav-section-title">Analytics</div>
                    <div class="nav-item">
                        <a href="{% url 'reports' %}" class="nav-link">
                            <i class="bi bi-graph-up"></i>
                            Reports
                        </a>
                    </div>
                </div>
                {% endif %}

                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <div class="nav-item">
                        <a href="{% url 'profile' %}" class="nav-link">
                            <i class="bi bi-person"></i>
                            Profile
                        </a>
                    </div>
                    {% if app_role == 'admin' %}
                    <div class="nav-item">
                        <a href="{% url 'sms_settings' %}" class="nav-link">
                            <i class="bi bi-chat-dots"></i>
                            SMS Settings
                        </a>
                    </div>
                    {% endif %}
                    <div class="nav-item">
                        <a href="{% url 'logout' %}" class="nav-link">
                            <i class="bi bi-box-arrow-right"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1>Inventory Management</h1>
                    <p class="header-subtitle">Manage your product inventory and track stock levels</p>
                </div>
                <div class="header-right">
                    <!-- Mobile Menu Toggle Button -->
                    <button id="mobileMenuToggle" class="btn btn-outline-secondary btn-sm me-3 mobile-menu-btn" style="min-width: 44px; min-height: 44px; display: flex !important; align-items: center; justify-content: center; background: #007bff !important; border: 2px solid #000000 !important; color: #ffffff !important; position: relative; z-index: 9999;">
                        <i class="bi bi-list" style="font-size: 1.2rem;"></i>
                        <span class="ms-1">Menu</span>
                    </button>

                    <div class="dropdown">
                        <img src="{{ user_obj.profile_picture|default:'https://via.placeholder.com/40' }}" alt="User" class="user-avatar" data-bs-toggle="dropdown">
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon primary">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="stat-value">{{ total_fruits }}</div>
                        <div class="stat-label">Total Boxes</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon success">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="stat-value">{{ active_fruits }}</div>
                        <div class="stat-label">Active Products</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon warning">
                            <i class="bi bi-boxes"></i>
                        </div>
                        <div class="stat-value">{{ total_stock }}</div>
                        <div class="stat-label">Total Stock</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-icon danger">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <div class="stat-value">{{ restock_alerts }}</div>
                        <div class="stat-label">Restock Alerts</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a href="{% url 'add_product_page' %}" class="btn-modern primary">
                        <i class="bi bi-plus-lg"></i>
                        Add Product
                    </a>
                    <a href="{% url 'record_sale_page' %}" class="btn-modern success">
                        <i class="bi bi-cart-plus"></i>
                        Record Sale
                    </a>
                    <a href="{% url 'add_stock_page' %}" class="btn-modern warning">
                        <i class="bi bi-box-arrow-in-down"></i>
                        Add Stock
                    </a>
                </div>

                <!-- Filters -->
                <div class="filters-card">
                    <div class="filters-row">
                        <div class="form-group">
                            <label class="form-label">Search</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search products..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filter</label>
                            <select class="form-select" id="filterSelect">
                                <option value="All Products">All Products</option>
                                <option value="Active">Active Only</option>
                                <option value="Discontinued">Discontinued</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-modern primary" id="refreshTable" aria-label="Refresh table">
                                <i class="bi bi-arrow-clockwise"></i>
                                <span class="d-none d-md-inline">Refresh</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="table-card">
                    <div class="table-header">
                        <ul class="nav nav-tabs border-0" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-products-tab" data-bs-toggle="tab" data-bs-target="#all-products" type="button" role="tab" aria-controls="all-products" aria-selected="true">All Products</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="low-stock-tab" data-bs-toggle="tab" data-bs-target="#low-stock" type="button" role="tab" aria-controls="low-stock" aria-selected="false">Low Stock</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="out-of-stock-tab" data-bs-toggle="tab" data-bs-target="#out-of-stock" type="button" role="tab" aria-controls="out-of-stock" aria-selected="false">Out of Stock</button>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-content p-3 pt-0">
                        <div class="tab-pane fade show active" id="all-products" role="tabpanel" aria-labelledby="all-products-tab">
                            <div class="table-responsive">
                                <table class="table" id="allProductsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px">Product ID</th>
                                            <th>Fruit</th>
                                            <th>Variant</th>
                                            <th>Size</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th style="width: 150px">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Filled by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>


                        <div class="tab-pane fade" id="low-stock" role="tabpanel" aria-labelledby="low-stock-tab">
                            <div class="table-responsive">
                                <table class="table" id="lowStockTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px">Product ID</th>
                                            <th>Fruit</th>
                                            <th>Variant</th>
                                            <th>Size</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th style="width: 150px">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Low stock products will be loaded dynamically -->
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">Loading low stock products...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="out-of-stock" role="tabpanel" aria-labelledby="out-of-stock-tab">
                            <div class="table-responsive">
                                <table class="table" id="outOfStockTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px">Product ID</th>
                                            <th>Fruit</th>
                                            <th>Variant</th>
                                            <th>Size</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th style="width: 150px">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Out of stock products will be loaded dynamically -->
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">Loading out of stock products...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="config" data-show-cost="{{ show_cost|yesno:'true,false' }}" style="display: none;"></div>

    

    <!-- Generate Stock QR Modal -->
    <div class="modal fade" id="generateStockQRModal" tabindex="-1" aria-labelledby="generateStockQRModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateStockQRModalLabel">Scan to Add Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3" id="stockQRContainer"></div>
                    <div class="small text-muted" id="stockQRLinkWrap" style="word-break: break-all;"></div>
                    <div class="alert alert-info mt-3" role="alert">
                        Open your phone camera or QR app and scan this code. The link will securely add the stock items you prepared.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-primary" id="copyStockQRLinkBtn">Copy Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan Stock QR Modal (webcam) -->
    <div class="modal fade" id="scanStockQRModal" tabindex="-1" aria-labelledby="scanStockQRModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scanStockQRModalLabel">Scan QR (Webcam)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="stockQRScanner" style="width: 100%">
                        <div class="text-center text-muted">
                            <i class="bi bi-camera" style="font-size: 2rem;"></i>
                            <p class="mt-2">Initializing camera...</p>
                        </div>
                    </div>
                    <div id="stockQRScanResult" class="mt-2 small text-muted"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="closeScanQRBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Change Confirmation Modal -->
    <div class="modal fade" id="discontinueModal" tabindex="-1" aria-labelledby="discontinueModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title" id="discontinueModalLabel">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                        <span id="modalTitle">Discontinue Product</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i id="modalIcon" class="bi bi-x-circle-fill text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <p class="mb-0" id="modalMessage">Are you sure you want to discontinue this product?</p>
                    <small class="text-muted" id="modalSubtext">This will change the product status to "Discontinued"</small>
                </div>
                <div class="modal-footer border-0 pt-0 justify-content-center">
                    <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn" id="confirmDiscontinue">
                        <i id="confirmIcon" class="bi bi-x-circle me-1"></i> <span id="confirmText">Discontinue</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal (Add/Edit) -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Add New Fruit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="productFormAlert"></div>
                    <form id="productForm" enctype="multipart/form-data" novalidate>
                        <input type="hidden" id="formAction" name="action" value="add">
                        <input type="hidden" id="productId" name="productId">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="productName" class="form-label">Fruit Name</label>
                                <input type="text" class="form-control" id="productName" name="productName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="variant" class="form-label">Variant (Optional)</label>
                                <input type="text" class="form-control" id="variant" name="variant" placeholder="e.g., Red, Green, Organic">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="size" class="form-label">Size/Weight</label>
                                <input type="text" class="form-control" id="size" name="size" required placeholder="e.g., Large, 1kg, 500g">
                            </div>
                            <div class="col-md-6">
                                <label for="initialStock" class="form-label">Initial Stock</label>
                                <input type="number" class="form-control" id="initialStock" name="initialStock" min="0" required>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="cost" class="form-label">Cost</label>
                                <div class="input-group">
                                    <span class="input-group-text">₱</span>
                                    <input type="number" class="form-control" id="cost" name="cost" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="price" class="form-label">Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">₱</span>
                                    <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="dateAdded" class="form-label">Date Added</label>
                                <input type="date" class="form-control" id="dateAdded" name="dateAdded" required>
                            </div>
                            <div class="col-md-6">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="Active">Active</option>
                                    <option value="Discontinued">Discontinued</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productImage" class="form-label">Fruit Image (Optional)</label>
                            <input type="file" class="form-control w-auto" style="max-width: 400px;" id="productImage" name="productImage" accept="image/jpeg,image/png" aria-describedby="productImageFeedback" title="Upload an image (JPG/PNG, max 2MB)">
                            <div id="productImageFeedback" class="invalid-feedback">Please upload a valid image (JPG/PNG, max 2MB).</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" title="Close without saving">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn" title="Save the fruit details">Add Fruit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Stock modal removed in favor of dedicated page -->

    <!-- Record Sale modal removed in favor of dedicated page -->

    <!-- Print QR Code Stickers modal removed; use dedicated page -->


    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger me-2"></i>Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this fruit? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery and Bootstrap Bundle -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="{% static 'js/modern-inventory.js' %}"></script>

    <script>
        // CSRF token setup for AJAX
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        $.ajaxSetup({
            headers: {
                'X-CSRFToken': csrftoken
            }
        });

        // Expose cost-visibility flag for JS logic
        window.showCost = document.getElementById('config').dataset.showCost === 'true';

        // Global variables
        let currentProductId = null;
        let saleItems = [];
        let products = [];

        // Alert function
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            // Remove existing alerts
            $('.alert').remove();
            // Add new alert at the top of the content area
            $('.content-area').prepend(alertHtml);
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 5000);
        }

        // Mobile-specific optimizations
        function initMobileOptimizations() {
            // Prevent iOS zoom on input focus
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                $('input[type="text"], input[type="number"], select').each(function() {
                    if ($(this).attr('type') !== 'search') {
                        $(this).css('font-size', '16px');
                    }
                });
            }
            
            // Add touch-friendly dropdown behavior
            $(document).on('touchstart', '.dropdown-toggle', function(e) {
                const $this = $(this);
                setTimeout(function() {
                    $this.dropdown('toggle');
                }, 10);
            });
            
            // Improve table scrolling on mobile
            $('.table-responsive').on('touchstart touchmove', function(e) {
                e.stopPropagation();
            });
            
            // Add haptic feedback for iOS (if available)
            if ('vibrate' in navigator) {
                $(document).on('click', '.btn:not(.dropdown-toggle), .dropdown-item', function() {
                    navigator.vibrate(10);
                });
            }
            
            // Handle mobile dropdown better
            $(document).on('click', '.btn-icon', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const dropdown = $(this).next('.dropdown-menu');
                $('.dropdown-menu').not(dropdown).removeClass('show');
                dropdown.toggleClass('show');
            });
            
            // Close dropdowns when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.dropdown').length) {
                    $('.dropdown-menu').removeClass('show');
                }
            });
        }

        // Load products on page load
        $(document).ready(function() {
            loadProducts('allProductsTable', 'all');
            loadActiveProducts();
            setupEventHandlers();
            initMobileOptimizations();
            $('#addStockForm [name="date_added"]').val(new Date().toISOString().split('T')[0]);
        });

        

        function setupEventHandlers() {
            // Search and filter
            $('#searchInput').on('input', loadCurrentTab);
            $('#filterSelect').on('change', loadCurrentTab);
            $('#refreshTable').on('click', loadCurrentTab);

            // Tab event listeners
            $('#all-products-tab').on('shown.bs.tab', () => loadProducts('allProductsTable', 'all'));
            $('#low-stock-tab').on('shown.bs.tab', () => loadProducts('lowStockTable', 'Low Stock'));
            $('#out-of-stock-tab').on('shown.bs.tab', () => loadProducts('outOfStockTable', 'Out of Stock'));

            function loadCurrentTab() {
                const activeTab = document.querySelector('.nav-link.active');
                if (!activeTab) return;
                
                const tabId = activeTab.id;
                switch(tabId) {
                    case 'all-products-tab': 
                        loadProducts('allProductsTable', 'all'); 
                        break;
                    case 'low-stock-tab': 
                        loadProducts('lowStockTable', 'Low Stock'); 
                        break;
                    case 'out-of-stock-tab': 
                        loadProducts('outOfStockTable', 'Out of Stock'); 
                        break;
                    default: 
                        loadProducts('allProductsTable', 'all');
                }
            }

            // Product Modal (Add/Edit) - Initialize
            $('#productModal').on('show.bs.modal', function() {
                // Reset form for add mode
                $('#productForm')[0].reset();
                $('#formAction').val('add');
                $('#productId').val('');
                $('#productModalLabel').text('Add New Fruit');
                $('#saveProductBtn').text('Add Fruit').attr('title', 'Save the fruit details');
                $('#productFormAlert').empty();
                
                // Set today's date as default
                $('#dateAdded').val(new Date().toISOString().split('T')[0]);
            });

            // Handle Edit button from dropdown
            $(document).on('click', '.edit-btn', function() {
                const productId = $(this).data('id');
                // Find the product in the products array and populate the form
                const product = products.find(p => p.product_id == productId);
                if (product) {
                    // Parse name and variant
                    let productName = product.name;
                    let variant = '';
                    if (productName.includes('(') && productName.includes(')')) {
                        const match = productName.match(/^(.*?)\s*\((.*?)\)$/);
                        if (match) {
                            productName = match[1].trim();
                            variant = match[2].trim();
                        }
                    }
                    
                    // Set edit mode
                    $('#formAction').val('edit');
                    $('#productId').val(productId);
                    $('#productModalLabel').text('Edit Fruit');
                    $('#saveProductBtn').text('Save Changes').attr('title', 'Save the fruit details');
                    
                    // Populate form fields
                    $('#productName').val(productName);
                    $('#variant').val(variant);
                    $('#size').val(product.size);
                    $('#cost').val(product.cost || 0);
                    $('#price').val(product.price);
                    $('#initialStock').val(product.stock || 0);
                    $('#status').val(product.status);
                    $('#dateAdded').val(product.date_added || new Date().toISOString().split('T')[0]);
                    $('#productImage').val(''); // Clear file input
                    
                    $('#productFormAlert').empty();
                }
            });

            // Handle save button click
            $('#saveProductBtn').on('click', function() {
                const formData = new FormData($('#productForm')[0]);
                
                $.ajax({
                    url: "{% url 'handle_product_post' %}",
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#productModal').modal('hide');
                            loadProducts();
                        }
                        showAlert(response.message, response.success ? 'success' : 'danger');
                    },
                    error: function() {
                        showAlert('Error saving product. Please try again.', 'danger');
                    }
                });
            });

            // Add Stock Modal functionality
            let stockItems = [];

            // Function to validate stock items
            function validateStockItems() {
                let isValid = true;
                $('.stock-item').each(function() {
                    const productSelect = $(this).find('.stock-product-select');
                    const quantity = $(this).find('.stock-quantity');
                    const supplier = $(this).find('.stock-supplier');
                    
                    if (!productSelect.val() || !quantity.val() || quantity.val() < 1) {
                        isValid = false;
                        return false;
                    }
                });
                
                const dateAdded = $('#stockDate').val();
                if (!dateAdded) {
                    isValid = false;
                }
                
                $('#saveStockBtn').prop('disabled', !isValid);
                return isValid;
            }

            // Function to update current stock display
            function updateCurrentStock(selectElement) {
                const productId = $(selectElement).val();
                const stockItem = $(selectElement).closest('.stock-item');
                const stockDisplay = stockItem.find('.stock-indicator');
                
                if (productId) {
                    // Find the product in the products array
                    const product = products.find(p => p.product_id == productId);
                    if (product) {
                        stockDisplay.text(`Current Stock: ${product.stock || 0} boxes`);
                    }
                } else {
                    stockDisplay.text('');
                }
            }

            // Function to populate product select
            function populateProductSelect(selectElement) {
                const $select = $(selectElement);
                $select.html('<option value="">Select a fruit</option>');
                products.forEach(product => {
                    const variant = product.variant ? `(${product.variant})` : '';
                    const size = product.size ? `(${product.size})` : '';
                    const option = $(`<option 
                        value="${product.product_id}"
                        data-name="${product.name}"
                        data-variant="${product.variant || ''}"
                        data-size="${product.size || ''}"
                        data-price="${product.price || 0}"
                        data-stock="${product.stock || 0}"
                    >${product.name} ${variant} ${size}</option>`);
                    $select.append(option);
                });

                // Initialize Select2 for stock selects as well
                if (!$select.hasClass('select2-hidden-accessible')) {
                    $select.select2({
                        placeholder: 'Search and select a fruit...',
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $select.closest('.modal'),
                        templateResult: function(option) {
                            if (!option.id) return option.text;
                            const $opt = $(option.element);
                            const name = $opt.data('name') || '';
                            const variant = $opt.data('variant') ? ` (${$opt.data('variant')})` : '';
                            const size = $opt.data('size') ? ` (${$opt.data('size')})` : '';
                            const price = $opt.data('price') ? ` - ₱${parseFloat($opt.data('price')).toFixed(2)}` : '';
                            const stock = $opt.data('stock') ? ` - Stock: ${$opt.data('stock')}` : '';
                            return $(`<div><strong>${name}${variant}${size}</strong>${price}${stock}</div>`);
                        },
                        templateSelection: function(option) {
                            if (!option.id) return option.text;
                            const $opt = $(option.element);
                            const name = $opt.data('name') || '';
                            const variant = $opt.data('variant') ? ` (${$opt.data('variant')})` : '';
                            const size = $opt.data('size') ? ` (${$opt.data('size')})` : '';
                            const price = $opt.data('price') ? ` - ₱${parseFloat($opt.data('price')).toFixed(2)}` : '';
                            return `${name}${variant}${size}${price}`;
                        }
                    });
                } else {
                    $select.trigger('change.select2');
                }
            }



            // Handle Status Change button from dropdown
            let currentStatusChangeProductId = null;
            let currentStatusChangeAction = null;
            
            $(document).on('click', '.discontinue-btn', function() {
                currentStatusChangeProductId = $(this).data('id');
                const currentStatus = $(this).data('status');
                const isDiscontinued = currentStatus === 'Discontinued';
                
                if (isDiscontinued) {
                    // Continue/Reactivate mode
                    currentStatusChangeAction = 'continue';
                    $('#modalTitle').text('Continue Product');
                    $('#modalIcon').removeClass('bi-x-circle-fill text-danger').addClass('bi-arrow-counterclockwise text-success');
                    $('#modalMessage').text('Are you sure you want to continue this product?');
                    $('#modalSubtext').text('This will change the product status to "Active"');
                    $('#confirmDiscontinue').removeClass('btn-danger').addClass('btn-success');
                    $('#confirmIcon').removeClass('bi-x-circle').addClass('bi-arrow-counterclockwise');
                    $('#confirmText').text('Continue');
                } else {
                    // Discontinue mode
                    currentStatusChangeAction = 'discontinue';
                    $('#modalTitle').text('Discontinue Product');
                    $('#modalIcon').removeClass('bi-arrow-counterclockwise text-success').addClass('bi-x-circle-fill text-danger');
                    $('#modalMessage').text('Are you sure you want to discontinue this product?');
                    $('#modalSubtext').text('This will change the product status to "Discontinued"');
                    $('#confirmDiscontinue').removeClass('btn-success').addClass('btn-danger');
                    $('#confirmIcon').removeClass('bi-arrow-counterclockwise').addClass('bi-x-circle');
                    $('#confirmText').text('Discontinue');
                }
                
                $('#discontinueModal').modal('show');
            });

            // Handle confirm button
            $('#confirmDiscontinue').on('click', function() {
                if (currentStatusChangeProductId && currentStatusChangeAction) {
                    const newStatus = currentStatusChangeAction === 'continue' ? 'Active' : 'Discontinued';
                    const actionText = currentStatusChangeAction === 'continue' ? 'continued' : 'discontinued';
                    
                    $.ajax({
                        url: "{% url 'handle_product_post' %}",
                        method: 'POST',
                        data: {
                            action: 'update_status',
                            product_id: currentStatusChangeProductId,
                            status: newStatus
                        },
                        success: function(response) {
                            if (response.success) {
                                $('#discontinueModal').modal('hide');
                                loadProducts();
                                showAlert(`Product ${actionText} successfully`, 'success');
                            } else {
                                showAlert(response.message, 'danger');
                            }
                        },
                        error: function() {
                            showAlert(`Error ${actionText} product. Please try again.`, 'danger');
                        }
                    });
                    currentStatusChangeProductId = null;
                    currentStatusChangeAction = null;
                }
            });

            // Initialize stock modal
            $('#addStockModal').on('show.bs.modal', function() {
                // Reset form
                $('#stockItemsContainer').html(`
                    <div class="stock-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Fruit</label>
                                <select class="form-select stock-product-select" required>
                                    <option value="">Select a fruit</option>
                                </select>
                                <div class="stock-indicator text-muted small mt-1"></div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Boxes to Add</label>
                                <input type="number" class="form-control stock-quantity" min="1" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Supplier</label>
                                <input type="text" class="form-control stock-supplier" placeholder="Enter supplier name">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <!-- No delete button for the first row -->
                            </div>
                        </div>
                    </div>
                `);
                
                // Set today's date
                $('#stockDateDisplay').val(new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }));
                $('#stockDate').val(new Date().toISOString().split('T')[0]);
                
                // Populate product selects
                populateProductSelect('.stock-product-select');

                // Force Select2 init/update on all current stock selects
                $('.stock-product-select').each(function(){
                    const $sel = $(this);
                    if (!$sel.hasClass('select2-hidden-accessible')) {
                        $sel.select2({
                            placeholder: 'Search and select a fruit...',
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $sel.closest('.modal'),
                            templateResult: function(option){
                                if (!option.id) return option.text;
                                const $opt = $(option.element);
                                const name = $opt.data('name') || '';
                                const variant = $opt.data('variant') ? ` (${$opt.data('variant')})` : '';
                                const size = $opt.data('size') ? ` (${$opt.data('size')})` : '';
                                const price = $opt.data('price') ? ` - ₱${parseFloat($opt.data('price')).toFixed(2)}` : '';
                                const stock = $opt.data('stock') ? ` - Stock: ${$opt.data('stock')}` : '';
                                return $(`<div><strong>${name}${variant}${size}</strong>${price}${stock}</div>`);
                            },
                            templateSelection: function(option){
                                if (!option.id) return option.text;
                                const $opt = $(option.element);
                                const name = $opt.data('name') || '';
                                const variant = $opt.data('variant') ? ` (${$opt.data('variant')})` : '';
                                const size = $opt.data('size') ? ` (${$opt.data('size')})` : '';
                                const price = $opt.data('price') ? ` - ₱${parseFloat($opt.data('price')).toFixed(2)}` : '';
                                return `${name}${variant}${size}${price}`;
                            }
                        });
                    } else {
                        $sel.trigger('change.select2');
                    }
                });

                // Reset validation
                validateStockItems();
            });

            // Add new stock item
            $('#addStockItemBtn').on('click', function() {
                const newItem = $(
                    `<div class="stock-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">Fruit</label>
                                <select class="form-select stock-product-select" required>
                                    <option value="">Select a fruit</option>
                                </select>
                                <div class="stock-indicator text-muted small mt-1"></div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">Boxes to Add</label>
                                <input type="number" class="form-control stock-quantity" min="1" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">Supplier</label>
                                <input type="text" class="form-control stock-supplier" placeholder="Enter supplier name">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-danger btn-sm d-block w-100 remove-stock-item">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>`
                );
                $('#stockItemsContainer').append(newItem);
                populateProductSelect(newItem.find('.stock-product-select'));
                // Show remove buttons only for additional rows
                $('.remove-stock-item').show();
                validateStockItems();
            });

            // Remove stock item
            $(document).on('click', '.remove-stock-item', function() {
                $(this).closest('.stock-item').remove();
                // Hide remove buttons if only one item left
                if ($('.stock-item').length === 1) {
                    $('.remove-stock-item').hide();
                }
                validateStockItems();
            });

            // Handle product selection change
            $(document).on('change', '.stock-product-select', function() {
                updateCurrentStock(this);
                validateStockItems();
            });

            // Handle quantity change
            $(document).on('input', '.stock-quantity', function() {
                validateStockItems();
            });

            // Supplier is optional; no validation needed

            // Save stock button handler (kept for backwards compatibility but not used now)
            $('#saveStockBtn').on('click', function() {
                if (!validateStockItems()) {
                    $('#addStockFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Please fill in all required fields.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                    return;
                }

                // Collect stock items
                const stockItems = [];
                $('.stock-item').each(function() {
                    const productSelect = $(this).find('.stock-product-select');
                    const quantity = $(this).find('.stock-quantity');
                    const supplier = $(this).find('.stock-supplier');
                    
                    if (productSelect.val() && quantity.val()) {
                        stockItems.push({
                            product_id: productSelect.val(),
                            quantity: parseInt(quantity.val()),
                            supplier: supplier.val().trim() || ''
                        });
                    }
                });

                const data = {
                    action: 'add_stock',
                    items: JSON.stringify(stockItems),
                    date_added: $('#stockDate').val(),
                    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                };

                $.ajax({
                    url: "{% url 'handle_product_post' %}",
                    method: 'POST',
                    data: data,
                    success: function(response) {
                        if (response.success) {
                            loadProducts();
                            $('#addStockFormAlert').html('<div class="alert alert-success alert-dismissible fade show" role="alert"><i class="bi bi-check-circle-fill text-success me-2"></i>Stock added successfully!<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                        } else {
                            $('#addStockFormAlert').html(`<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>${response.message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`);
                        }
                    },
                    error: function() {
                        $('#addStockFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Error adding stock. Please try again.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                    }
                });
            });

            // Generate per-delivery QR (product + date) via Django QR service
            $('#generateStockQRBtn').off('click.qr').on('click.qr', function () {
                const $row = $('#stockItemsContainer .stock-item').first();
                const productId = $row.find('.stock-product-select').val();
                const dateISO = $('#stockDate').val(); // YYYY-MM-DD
                if (!productId || !dateISO) {
                    $('#addStockFormAlert').html('<div class="alert alert-warning alert-dismissible fade show" role="alert">Please select a fruit and ensure the date is set before generating a QR.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                    return;
                }
                const url = `/qr/generate/${productId}/?date=${encodeURIComponent(dateISO)}`;
                // Show QR in existing modal so you can copy/print
                const absolute = window.location.origin + url;
                $('#stockQRContainer').html(`<img src="${url}" alt="QR" style="max-width:100%"/>`);
                $('#stockQRLinkWrap').text(absolute);
                const m = new bootstrap.Modal(document.getElementById('generateStockQRModal'));
                m.show();
            });

            // Copy QR link
            $('#copyStockQRLinkBtn').on('click', function(){
                const text = $('#stockQRLinkWrap').text();
                navigator.clipboard.writeText(text).then(function(){
                    $('#stockQRLinkWrap').append('<div class="text-success"> Copied!</div>');
                });
            });

            // Scan QR with webcam (uses html5-qrcode if available)
            let html5QrcodeInstance = null;
            $('#scanStockQRBtn').on('click', function(){
                const modalEl = document.getElementById('scanStockQRModal');
                const m = new bootstrap.Modal(modalEl);
                m.show();
                
                // Reset the scanner area
                $('#stockQRScanner').html(`
                    <div class="text-center text-muted">
                        <i class="bi bi-camera" style="font-size: 2rem;"></i>
                        <p class="mt-2">Initializing camera...</p>
                    </div>
                `);
                $('#stockQRScanResult').text('');
                
                setTimeout(function(){
                    try {
                        if (window.Html5Qrcode) {
                            html5QrcodeInstance = new Html5Qrcode('stockQRScanner');
                            
                            const config = {
                                fps: 10,
                                qrbox: { width: 250, height: 250 },
                                aspectRatio: 1.0
                            };
                            
                            // Try back camera first, then front camera
                            const cameraConfigs = [
                                { facingMode: "environment" }, // Back camera
                                { facingMode: "user" },         // Front camera
                                "auto"                          // Auto-select
                            ];
                            
                            let cameraIndex = 0;
                            
                            function tryNextCamera() {
                                if (cameraIndex >= cameraConfigs.length) {
                                    $('#stockQRScanner').html(`
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            Unable to access camera. Please ensure camera permissions are granted and try again.
                                        </div>
                                    `);
                                    return;
                                }
                                
                                html5QrcodeInstance.start(
                                    cameraConfigs[cameraIndex],
                                    config,
                                    function(decodedText, decodedResult) {
                                        $('#stockQRScanResult').html(`
                                            <div class="alert alert-success">
                                                <i class="bi bi-check-circle me-2"></i>
                                                QR Code detected! Opening link...
                                            </div>
                                        `);
                                        // Stop scanning after successful scan
                                        html5QrcodeInstance.stop().then(() => {
                                            try { 
                                                window.open(decodedText, '_blank'); 
                                                m.hide(); // Close modal after opening link
                                            } catch(e) {
                                                console.log("Error opening link:", e);
                                            }
                                        }).catch(err => {
                                            console.log("Error stopping scanner:", err);
                                        });
                                    },
                                    function(errorMessage) {
                                        // Handle scan errors silently - this is normal during scanning
                                    }
                                ).catch(err => {
                                    console.log(`Camera ${cameraIndex} failed:`, err);
                                    cameraIndex++;
                                    tryNextCamera();
                                });
                            }
                            
                            tryNextCamera();
                        } else {
                            $('#stockQRScanner').html(`
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Webcam scanner library not found. You can scan using your phone after generating the QR.
                                </div>
                            `);
                        }
                    } catch (e) {
                        $('#stockQRScanner').html(`
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-circle me-2"></i>
                                Unable to start scanner: ${e.message}
                            </div>
                        `);
                    }
                }, 200);
            });

            $('#closeScanQRBtn').on('click', function(){
                if (html5QrcodeInstance) {
                    html5QrcodeInstance.stop().then(() => {
                        html5QrcodeInstance.clear();
                    }).catch(err => {
                        console.log("Error stopping scanner:", err);
                    });
                }
            });

            // Clean up scanner when modal is closed
            $('#scanStockQRModal').on('hidden.bs.modal', function(){
                if (html5QrcodeInstance) {
                    html5QrcodeInstance.stop().then(() => {
                        html5QrcodeInstance.clear();
                    }).catch(err => {
                        console.log("Error stopping scanner:", err);
                    });
                }
            });

            // Record sale form
            $('#recordSaleForm').on('submit', function(e) {
                e.preventDefault();
                if (saleItems.length === 0) {
                    showAlert('Please add at least one item to the sale.', 'danger');
                    return;
                }
                const data = {
                    action: 'buy',
                    items: JSON.stringify(saleItems),
                    amount_paid: parseFloat($('#recordSaleForm [name="amount_paid"]').val()),
                    purchase_date: new Date().toISOString().split('T')[0],
                    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                };
                $.ajax({
                    url: "{% url 'handle_product_post' %}",
                    method: 'POST',
                    data: data,
                    success: function(response) {
                        if (response.success) {
                            $('#recordSaleModal').modal('hide');
                            loadProducts();
                            saleItems = [];
                            updateSaleTable();
                        }
                        showAlert(response.message, response.success ? 'success' : 'danger');
                    }
                });
            });

            // Sale item selection
            $('#recordSaleForm [name="product"]').on('change', function() {
                const productId = $(this).val();
                if (!productId) return;
                const product = products.find(p => p.product_id == productId);
                if (product) {
                    $(this).val(productId); // Set the value to the product ID
                    $(this).trigger('change'); // Trigger change to update price
                }
            });

            // Add item to sale
            $('#recordSaleForm').on('submit', function(e) {
                e.preventDefault();
                const productId = $(this).find('[name="product"]').val();
                const quantity = parseInt($(this).find('[name="quantity"]').val());
                const product = products.find(p => p.product_id == productId);
                
                if (!product || quantity <= 0) return;
                
                saleItems.push({
                    product_id: product.product_id,
                    name: product.name,
                    size: product.size,
                    quantity: quantity,
                    price: product.price
                });
                
                updateSaleTable();
                $(this).find('[name="product"]').val('').trigger('change');
                $(this).find('[name="quantity"]').val('');
            });

            // Calculate change
            $('#recordSaleForm [name="amount_paid"]').on('input', function() {
                const amountPaid = parseFloat($(this).val()) || 0;
                const total = calculateTotal();
                const change = amountPaid - total;
                $('#recordSaleForm [name="change"]').val(change.toFixed(2));
            });

            // Delete confirmation
            $('#confirmDelete').on('click', function() {
                if (!currentProductId) return;
                $.ajax({
                    url: `/api/products/${currentProductId}/delete/`,
                    method: 'POST',
                    success: function(response) {
                        if (response.success) {
                            $('#deleteConfirmModal').modal('hide');
                            loadProducts();
                        }
                        showAlert(response.message, response.success ? 'success' : 'danger');
                    }
                });
            });
        }

        function loadProducts(tableId = 'allProductsTable', filter = 'all') {
            const search = $('#searchInput').val();
            const currentFilter = $('#filterSelect').val();
            console.log('Fetching products with:', { search, filter: filter, currentFilter });
            
            fetch("{% url 'fetch_products' %}?" + new URLSearchParams({
                search: search || '',
                filter: filter === 'all' ? (currentFilter || 'All Products') : filter
            }))
            .then(response => response.json())
            .then(response => {
                console.log('Products API response:', response);
                
                if (!response.success) {
                    const tbody = $(`#${tableId} tbody`).empty();
                    tbody.append('<tr><td colspan="8" class="text-center text-muted py-4">No products found</td></tr>');
                    return;
                }
                
                if (!response.data || !Array.isArray(response.data)) {
                    console.error('Invalid data format from API:', response);
                    return;
                }
                
                const tbody = $(`#${tableId} tbody`).empty();
                console.log('Rendering products:', response.data.length);
                if (response.data.length === 0) {
                    tbody.append('<tr><td colspan="8" class="text-center text-muted py-4">No product yet</td></tr>');
                    return;
                }
                    
                    response.data.forEach((product, idx) => {
                        const row = $('<tr>');
                        row.append(`<td>${product.product_id}</td>`);
                        
                        // Extract variant from product name if it contains parentheses
                        let productName = product.name;
                        let variant = product.variant || '-';
                        
                        // Check if product name contains variant in parentheses
                        const variantMatch = productName.match(/^(.+?)\s*\(([^)]+)\)$/);
                        if (variantMatch) {
                            productName = variantMatch[1].trim();
                            variant = variantMatch[2].trim();
                        }
                        
                        row.append(`<td>${productName}</td>`);
                        row.append(`<td>${variant}</td>`);
                        row.append(`<td>${product.size}</td>`);
                        row.append(`<td>₱${product.price.toFixed(2)}</td>`);
                        
                        // Stock column with color indicator
                        const stockClass = product.stock <= 10 ? 'text-danger' : 
                                        product.stock <= 30 ? 'text-warning' : 'text-success';
                        row.append(`
                            <td>
                                <i class="bi bi-circle-fill ${stockClass} me-1" style="font-size: 0.5rem"></i>
                                <a href="/stock_details/?product_id=${product.product_id}">${parseInt(product.stock) || 0}</a>
                            </td>
                        `);
                        
                        // Status badge
                        row.append(`
                            <td>
                                <span class="badge ${product.status === 'Active' ? 'bg-success' : 'bg-danger'}">
                                    ${product.status}
                                </span>
                            </td>
                        `);
                        
                        // Options - 3 dots dropdown
                        let optionsHtml = `
                            <div class="dropdown">
                                <button class="btn btn-sm btn-icon" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="More options">
                                    <i class="bi bi-three-dots-vertical"></i>
                                    <span class="visually-hidden">More options for ${product.name}</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">`;
                        
                        if (window.showCost) {
                            const isDiscontinued = product.status === 'Discontinued';
                            const actionText = isDiscontinued ? 'Continue' : 'Discontinue';
                            const actionIcon = isDiscontinued ? 'arrow-counterclockwise' : 'x-circle';
                            const actionTitle = isDiscontinued ? 'Continue this product' : 'Discontinue this product';
                            
                            optionsHtml += `
                                    <li>
                                        <button class="dropdown-item edit-btn" data-id="${product.product_id}" data-bs-toggle="modal" data-bs-target="#productModal" title="Edit this product">
                                            <i class="bi bi-pencil me-2"></i> Edit
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item discontinue-btn ${isDiscontinued ? 'continue-btn' : ''}" data-id="${product.product_id}" data-status="${product.status}" title="${actionTitle}">
                                            <i class="bi bi-${actionIcon} me-2"></i> ${actionText}
                                        </button>
                                    </li>`;
                        }
                        
                        optionsHtml += `
                                </ul>
                            </div>`;
                        const actions = $('<td>').html(optionsHtml);
                        row.append(actions);
                        tbody.append(row);
                    });
                })
                .catch(function(error){
                    console.error('Failed to fetch products:', error);
                    const tbody = $('#inventoryTable tbody').empty();
                    tbody.append('<tr><td colspan="8" class="text-center text-muted py-4">No product yet</td></tr>');
                });
        }


        function loadActiveProducts() {
            return fetch("{% url 'get_active_products' %}")
                .then(response => response.json())
                .then(response => {
                console.log('Active products response:', response);  // debug
                if (!response.success) {
                    console.error('Failed to load products:', response.error);
                    return;
                }
                // Ensure numeric price to avoid toFixed error
                products = response.data.map(function(p){
                    p.price = parseFloat(p.price) || 0;
                    return p;
                });
                // Update all existing dropdowns
                document.querySelectorAll('.product-select').forEach(select => {
                    select.innerHTML = '<option value="">Select a fruit</option>' + 
                        products.map(function(p){ return `<option value="${p.product_id}" data-price="${p.price}" data-name="${p.name}" data-variant="${p.variant || ''}" data-size="${p.size || ''}" data-stock="${p.stock || 0}">${p.name} (${p.size}) - ₱${p.price.toFixed(2)}</option>`; }).join('');
                });
                return products; // Return products for Promise chain
            });
        }

        // Record Sale handlers
        let currentStep = 1;
        const totalSteps = 3;

        // Global functions for Record Sale modal
            function addItemRow() {
            const itemCount = $('.item-row').length;
            const rowHtml = `
                <div class="item-row mb-3 p-3 border rounded">
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label">Fruit</label>
                            <select class="form-select product-select" required>
                                <option value="">Select a fruit</option>
                        </select>
                            <div class="stock-info text-muted small mt-1"></div>
                    </div>
                        <div class="col-md-4">
                            <label class="form-label">Boxes</label>
                            <input type="number" class="form-control quantity-input stock-quantity" min="1" required>
                    </div>
                    <div class="col-md-3">
                            <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">&nbsp;</label>
                            ${itemCount > 0 ? '<button type="button" class="btn btn-outline-danger btn-sm remove-item"><i class="bi bi-trash"></i></button>' : ''}
                    </div>
                    </div>
                    </div>
                `;
            $('#itemsContainer').append(rowHtml);
            updateProductSelects();
        }

        function updateProductSelects() {
            $('.product-select').each(function() {
                const $this = $(this);
                if ($this.find('option').length <= 1) { // Only has default option
                    let options = '<option value="">Select a fruit</option>';
                    products.forEach(product => {
                        options += `<option value="${product.product_id}" data-price="${product.price}" data-name="${product.name}" data-variant="${product.variant || ''}" data-size="${product.size || ''}" data-stock="${product.stock || 0}">${product.name} (${product.size || 'N/A'}) - ₱${product.price.toFixed(2)}</option>`;
                    });
                    $this.html(options);
                    
                    // Initialize Select2 if not already initialized
                    if (!$this.hasClass('select2-hidden-accessible')) {
                        $this.select2({
                            placeholder: 'Search and select a fruit...',
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $this.closest('.modal'),
                            templateResult: function(option) {
                                if (!option.id) return option.text;
                                const $option = $(option.element);
                                const name = $option.data('name') || '';
                                const variant = $option.data('variant') ? ` (${$option.data('variant')})` : '';
                                const size = $option.data('size') ? ` (${$option.data('size')})` : '';
                                const price = $option.data('price') ? ` - ₱${parseFloat($option.data('price')).toFixed(2)}` : '';
                                const stock = $option.data('stock') ? ` - Stock: ${$option.data('stock')}` : '';
                                return $(`<div><strong>${name}${variant}${size}</strong>${price}${stock}</div>`);
                            },
                            templateSelection: function(option) {
                                if (!option.id) return option.text;
                                const $option = $(option.element);
                                const name = $option.data('name') || '';
                                const variant = $option.data('variant') ? ` (${$option.data('variant')})` : '';
                                const size = $option.data('size') ? ` (${$option.data('size')})` : '';
                                const price = $option.data('price') ? ` - ₱${parseFloat($option.data('price')).toFixed(2)}` : '';
                                return `${name}${variant}${size}${price}`;
                            }
                        });
                    } else {
                        // Refresh Select2 if already initialized
                        $this.trigger('change.select2');
                    }
                }
            });
        }

        function updateTotal() {
            let total = 0;
            $('.item-row').each(function() {
                const $select = $(this).find('.product-select option:selected');
                const $quantity = $(this).find('.quantity-input');
                if ($select.val() && $quantity.val()) {
                    const price = parseFloat($select.data('price')) || 0;
                    const quantity = parseInt($quantity.val()) || 0;
                    total += price * quantity;
                }
            });
            $('#liveSaleTotalWithVATText').text(total.toFixed(2));
        }

        function showStep(step) {
            // Hide all steps
            // The following helpers were for the removed sale modal; harmless but not used
            $('#saleStep1, #saleStep2, #saleStep3').hide();
            $('#step1Buttons, #step2Buttons, #step3Buttons').hide();
            
            // Show current step
            $(`#saleStep${step}`).show();
            $(`#step${step}Buttons`).show();
            
            // Update step indicators
            $('.sale-step').removeClass('active');
            $(`#stepIndicator${step}`).addClass('active');
            
            currentStep = step;
        }

        function generateReceipt() {
            const items = window.saleItems || [];
            const subtotal = parseFloat($('#paymentSubtotal').text()) || 0;
            const vat = parseFloat($('#paymentVAT').text()) || 0;
            const totalAmount = parseFloat($('#paymentTotalWithVAT').text()) || 0;
            const amountPaid = parseFloat($('#paymentTendered').val()) || 0;
            const change = parseFloat($('#paymentChange').text()) || 0;

            // Get customer information
            const customerName = $('#customerName').val() || 'Walk-in Customer';
            const customerContact = $('#customerContact').val() || '';
            const customerAddress = $('#customerAddress').val() || '';

            // Generate receipt items
            let receiptItemsHtml = '';
            items.forEach(item => {
                let description = `${item.name}`;
                if (item.variant) description += ` (${item.variant})`;
                if (item.size) description += ` (${item.size})`;
                receiptItemsHtml += `
                    <tr>
                        <td>${description}</td>
                        <td class="align-right">${item.quantity}</td>
                        <td class="align-right">₱${item.price.toFixed(2)}</td>
                        <td class="align-right">₱${item.amount.toFixed(2)}</td>
                    </tr>
                `;
            });
            $('#receiptTableItems').html(receiptItemsHtml);

            // Update receipt summary
            $('#receiptSubtotal').text(subtotal.toFixed(2));
            $('#receiptVAT').text(vat.toFixed(2));
            $('#receiptTotalAmount').text(totalAmount.toFixed(2));
            $('#receiptAmountPaid').text(amountPaid.toFixed(2));
            $('#receiptChange').text(change.toFixed(2));

            // Generate transaction number and OR number
            const transactionNumber = 'TXN' + Date.now().toString().slice(-6);
            const orNumber = 'OR' + Date.now().toString().slice(-6);
            $('#transactionNumber').text(transactionNumber);
            $('#orNumber').text(orNumber);
            $('#receiptDate').text(new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }));

            // Add customer information to receipt
            let customerInfoHtml = '';
            if (customerName && customerName !== 'Walk-in Customer') {
                customerInfoHtml += `<div class="receipt-info"><span>Customer: ${customerName}</span></div>`;
            }
            if (customerContact) {
                customerInfoHtml += `<div class="receipt-info"><span>Contact: ${customerContact}</span></div>`;
            }
            if (customerAddress) {
                customerInfoHtml += `<div class="receipt-info"><span>Address: ${customerAddress}</span></div>`;
            }
            
            // Insert customer info after transaction number
            if (customerInfoHtml) {
                $('#transactionNumber').parent().after(customerInfoHtml);
            }
        }

        function recordSale() {
            const items = window.saleItems || [];
            const amountPaid = parseFloat($('#paymentTendered').val()) || 0;
            
            const saleData = {
                action: 'buy',
                items: JSON.stringify(items),
                amount_paid: amountPaid,
                purchase_date: new Date().toISOString().split('T')[0],
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            };

            $.ajax({
                url: "{% url 'handle_product_post' %}",
                method: 'POST',
                data: saleData,
                success: function(response) {
                    if (response.success) {
                        $('#saleSuccessMessage').show();
                        $('#printReceiptBtn').hide();
                        $('#printReceiptAfterBtn').show();
                        $('#doneBtn').show();
                        loadProducts(); // Refresh product list
                    } else {
                        $('#buyFormAlert').html(`<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>${response.message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`);
                    }
                },
                error: function() {
                    $('#buyFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Error recording sale. Please try again.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                }
            });
        }

        function printReceipt() {
            const printWindow = window.open('', '_blank');
            const receiptContent = $('.receipt-container').html();
            let html = '<html>';
            html += '<head>';
            html += '<style>';
            html += 'body { font-family: "Courier New", monospace; font-size: 12px; margin: 0; padding: 20px; }';
            html += '.receipt-container { max-width: 300px; margin: 0 auto; }';
            html += '.receipt-header { text-align: center; margin-bottom: 15px; }';
            html += '.company-name { font-weight: bold; font-size: 14px; margin-bottom: 5px; }';
            html += '.company-details { font-size: 10px; margin-bottom: 2px; }';
            html += '.receipt-title { text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }';
            html += '.receipt-divider { border-top: 1px dashed #000; margin: 10px 0; }';
            html += '.receipt-info { margin-bottom: 3px; font-size: 11px; }';
            html += '.receipt-table { width: 100%; margin: 10px 0; }';
            html += '.receipt-table th, .receipt-table td { padding: 2px 5px; font-size: 11px; }';
            html += '.receipt-table th { border-bottom: 1px solid #000; font-weight: bold; }';
            html += '.align-right { text-align: right; }';
            html += '.receipt-summary { margin-top: 10px; }';
            html += '.receipt-summary-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 11px; }';
            html += '.receipt-summary-row.total { font-weight: bold; font-size: 12px; border-top: 1px solid #000; padding-top: 5px; margin-top: 5px; }';
            html += '.receipt-footer { text-align: center; margin-top: 15px; font-size: 10px; }';
            html += '.receipt-footer p { margin-bottom: 2px; }';
            html += '@media print { body { width: 302px; } }';
            html += '</style>';
            html += '</head>';
            html += '<body>';
            html += '<div class="receipt-container">';
            html += receiptContent;
            html += '</div>';
            html += '</body>';
            html += '</html>';
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        function resetSaleModal() {
            // Reset to step 1
            showStep(1);
            
            // Clear customer information
            $('#customerName').val('');
            $('#customerContact').val('');
            $('#customerAddress').val('');
            
            // Clear form - keep only the first item row from HTML template
            $('#itemsContainer').html(`
                <div class="item-row mb-3 p-3 border rounded">
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label">Fruit</label>
                            <select class="form-select product-select" id="productSelect0" required>
                                <option value="">Select a fruit</option>
                            </select>
                            <div class="stock-info text-muted small mt-1"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Boxes</label>
                            <input type="number" class="form-control quantity-input stock-quantity" id="quantityInput0" min="1" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">&nbsp;</label>
                            <!-- No remove button for the first row -->
                        </div>
                    </div>
                </div>
            `);
            
            // Clear totals
            $('#liveSaleTotalWithVATText').text('0.00');
            $('#paymentSubtotal').text('0.00');
            $('#paymentVAT').text('0.00');
            $('#paymentTotalWithVAT').text('0.00');
            $('#paymentTendered').val('');
            $('#paymentChange').text('0.00');
            
            // Clear alerts
            $('#buyFormAlert').html('');
            $('#saleSuccessMessage').hide();
            
            // Reset buttons
            $('#printReceiptBtn').show();
            $('#printReceiptAfterBtn').hide();
            $('#doneBtn').hide();
            
            // Clear stored items
            window.saleItems = [];
        }

        // Record Sale modal removed; keep only sticker modal logic
        $(document).ready(function() {
            // Set today's date
            $('#purchaseDate').val(new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }));

            // Add input validation for size fields to only allow numbers
            $('input[name="size"], #stickerSizeSelect').on('input', function() {
                let value = $(this).val();
                // Remove any non-numeric characters except decimal point
                value = value.replace(/[^0-9.]/g, '');
                // Ensure only one decimal point
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                $(this).val(value);
            });

            // Prevent non-numeric characters from being typed
            $('input[name="size"], #stickerSizeSelect').on('keypress', function(e) {
                const char = String.fromCharCode(e.which);
                // Allow: backspace, delete, tab, escape, enter, decimal point
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true)) {
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105) && e.keyCode !== 190) {
                    e.preventDefault();
                }
            });

            // Removed sale modal logic. Standalone page handles sale flow.
        });

        // Sticker modal logic removed; use dedicated page instead

        // Mobile sidebar toggle functionality
        const sidebar = document.querySelector('.sidebar');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');

        function toggleMobileMenu() {
            if (sidebar) {
                sidebar.classList.toggle('active');
                console.log('Mobile sidebar toggled:', sidebar.classList.contains('active'));
                // Prevent body scroll when sidebar is open on mobile
                if (sidebar.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }

        // Handle mobile menu toggle click
        if (mobileMenuToggle) {
            console.log('Mobile menu button found in products_inventory_full');
            mobileMenuToggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Mobile menu button clicked in products_inventory_full');
                toggleMobileMenu();
            });
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768 && sidebar && sidebar.classList.contains('active')) {
                if (!sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                    document.body.style.overflow = '';
                    console.log('Mobile sidebar closed from outside click');
                }
            }
        });

        // Close sidebar when clicking on navigation links
        if (sidebar) {
            const navLinks = sidebar.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                        document.body.style.overflow = '';
                        console.log('Mobile sidebar closed from nav link click');
                    }
                });
            });
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768 && sidebar) {
                sidebar.classList.remove('active');
                document.body.style.overflow = '';
                console.log('Mobile sidebar closed on resize');
            }
        });

        // Handle escape key to close sidebar
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                document.body.style.overflow = '';
                console.log('Mobile sidebar closed from escape key');
            }
        });
    </script>
    <script>
  $(document).ready(function() {
      // Calculate VAT-inclusive price (12%) dynamically
      $('#priceInput').on('input', function() {
          const price = parseFloat($(this).val()) || 0;
          const vatPrice = price * 1.12;
          $('#vatInclusive').text(vatPrice.toFixed(2));
      });
  });
</script>
</body>
</html> 