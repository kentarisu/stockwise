{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockWise - Add Stock</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/modern-inventory.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .page-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem 1rem}
    .card-modern{width:100%;max-width:900px;background:#fff;border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 1px 3px 0 rgb(0 0 0/0.1),0 1px 2px -1px rgb(0 0 0/0.1);overflow:hidden}
    .card-header-modern{background:#f3f4f6;padding:1rem 1.25rem;display:flex;align-items:center;justify-content:space-between}
    .stock-item{background:#f8f9fa;border:1px solid #e9ecef!important}
  </style>
</head>
<body>
<div class="page-container">
  <div class="card-modern">
    <div class="card-header-modern">
      <h5 class="m-0"><i class="bi bi-box-arrow-in-down me-2"></i>Add Stock</h5>
      <div>
        <a href="{% url 'products_inventory' %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Back to Inventory</a>
        <a href="{% url 'print_stickers_page' %}" class="btn btn-outline-primary btn-sm ms-2"><i class="bi bi-printer"></i> Print QR Code Stickers</a>
      </div>
    </div>
    <div class="p-3">
      <div id="addStockFormAlert"></div>
      <div id="stockItemsContainer">
        <div class="stock-item mb-3 p-3 border rounded">
          <div class="row">
            <div class="col-md-4">
              <label class="form-label">Fruit</label>
              <select class="form-select stock-product-select" required>
                <option value="">Select a fruit</option>
              </select>
              <div class="stock-indicator text-muted small mt-1"></div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Boxes to Add</label>
              <input type="number" class="form-control stock-quantity" min="1" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Supplier</label>
              <input type="text" class="form-control stock-supplier" placeholder="Enter supplier name">
            </div>
            <div class="col-md-2">
              <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">&nbsp;</label>
            </div>
          </div>
        </div>
      </div>
      <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addStockItemBtn"><i class="bi bi-plus-circle"></i> Add Another Item</button>
      <div class="mt-3 d-flex align-items-center gap-2">
        <label class="form-label mb-0">Date Added:</label>
        <input type="text" class="form-control form-control-sm w-auto" id="stockDateDisplay" readonly>
        <input type="hidden" id="stockDate" value="{{ today|date:'Y-m-d' }}">
      </div>
      <small class="form-text text-muted ms-2">Set to today and cannot be changed.</small>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <a href="{% url 'products_inventory' %}" class="btn btn-outline-secondary">Cancel</a>
        <button type="button" class="btn btn-primary" id="saveStockBtn" disabled>Add Stock</button>
      </div>
      
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/modern-inventory.js' %}"></script>
<script>
function getCookie(name){let v=null;if(document.cookie&&document.cookie!==''){const cs=document.cookie.split(';');for(let i=0;i<cs.length;i++){const c=cs[i].trim();if(c.substring(0,name.length+1)===(name+'=')){v=decodeURIComponent(c.substring(name.length+1));break;}}}return v;}
const csrftoken=getCookie('csrftoken');
$.ajaxSetup({headers:{'X-CSRFToken':csrftoken}});

let products=[];
function loadProducts(){
  return fetch("{% url 'get_active_products' %}").then(r=>r.json()).then(resp=>{ if(!resp.success) return []; products=resp.data.map(p=>{p.price=parseFloat(p.price)||0; return p;}); populateProductSelect('.stock-product-select'); return products;});
}
function populateProductSelect(sel){
  const $select=$(sel);
  $select.html('<option value="">Select a fruit</option>');
  products.forEach(product=>{
    const variant=product.variant?`(${product.variant})`:''; const size=product.size?`(${product.size})`:'';
    const option=$(`<option value="${product.product_id}" data-name="${product.name}" data-variant="${product.variant||''}" data-size="${product.size||''}" data-price="${product.price||0}" data-stock="${product.stock||0}">${product.name} ${variant} ${size}</option>`);
    $select.append(option);
  });
  if(!$select.hasClass('select2-hidden-accessible')){
    $select.select2({placeholder:'Search and select a fruit...',allowClear:true,width:'100%',dropdownParent:$select.closest('.card-modern')});
  } else { $select.trigger('change.select2'); }
}
function validateStockItems(){ let ok=true; $('.stock-item').each(function(){ const p=$(this).find('.stock-product-select').val(); const q=$(this).find('.stock-quantity').val(); if(!p||!q||q<1){ ok=false; return false; } }); $('#saveStockBtn').prop('disabled', !ok); return ok; }
function updateCurrentStock(selectEl){ const pid=$(selectEl).val(); const $item=$(selectEl).closest('.stock-item'); const $disp=$item.find('.stock-indicator'); if(pid){ const product=products.find(p=>p.product_id==pid); if(product){ $disp.text(`Current Stock: ${product.stock||0} boxes`);} } else { $disp.text(''); } }

$(document).ready(function(){
  $('#stockDateDisplay').val(new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}));
  $('#stockDate').val(new Date().toISOString().split('T')[0]);
  loadProducts();

  $(document).on('change','.stock-product-select', function(){ updateCurrentStock(this); validateStockItems(); });
  $(document).on('input','.stock-quantity', validateStockItems);

  $('#addStockItemBtn').on('click', function(){
    const html=`<div class="stock-item mb-3 p-3 border rounded"><div class="row"><div class="col-md-4"><label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">Fruit</label><select class="form-select stock-product-select" required><option value="">Select a fruit</option></select><div class="stock-indicator text-muted small mt-1"></div></div><div class="col-md-3"><label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">Boxes to Add</label><input type="number" class="form-control stock-quantity" min="1" required></div><div class="col-md-3"><label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">Supplier</label><input type="text" class="form-control stock-supplier" placeholder="Enter supplier name"></div><div class="col-md-2"><label class="form-label">&nbsp;</label><button type="button" class="btn btn-danger btn-sm d-block w-100 remove-stock-item"><i class="bi bi-trash"></i> Remove</button></div></div></div>`;
    $('#stockItemsContainer').append(html); populateProductSelect($('#stockItemsContainer .stock-item:last .stock-product-select'));
  });
  $(document).on('click','.remove-stock-item', function(){ $(this).closest('.stock-item').remove(); if($('.stock-item').length===1){ $('.remove-stock-item').hide(); } validateStockItems(); });

  $('#saveStockBtn').on('click', function(){
    if(!validateStockItems()){
      $('#addStockFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert">Please fill in all required fields.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
      return;
    }
    const items=[];
    $('.stock-item').each(function(){
      const p=$(this).find('.stock-product-select');
      const q=$(this).find('.stock-quantity');
      const s=$(this).find('.stock-supplier');
      if(p.val()&&q.val()){
        items.push({product_id:p.val(), quantity:parseInt(q.val()), supplier:s.val().trim()||''});
      }
    });
    const data={ action:'add_stock', items: JSON.stringify(items), date_added: $('#stockDate').val(), csrfmiddlewaretoken: csrftoken };
    $.ajax({
      url: "{% url 'handle_product_post' %}", method:'POST', data:data,
      success:function(resp){
        if(resp.success){
          $('#addStockFormAlert').html('<div class="alert alert-success alert-dismissible fade show" role="alert">Stock added successfully!<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
          const redirectUrl = "{% url 'products_inventory' %}";
          setTimeout(function(){ window.location.href = redirectUrl; }, 800);
        } else {
          $('#addStockFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert">'+resp.message+'<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
        }
      },
      error:function(){
        $('#addStockFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error adding stock. Please try again.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
      }
    });
  });

  // Stickers section logic
  let allProducts=[];
  async function loadAllProducts(){ try{ const resp=await fetch('/api/products/active/',{headers:{'X-Requested-With':'XMLHttpRequest'}}); if(!resp.ok) throw new Error('Network error'); const data=await resp.json(); if(data.success){ allProducts=data.data; populateFruitList(); } }catch(e){ console.error('Load products error:', e); } }
  // Stickers helpers removed from this page
  loadAllProducts();
});
</script>
</body>
</html>


