{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockWise - Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/modern-inventory.css' %}">

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #f8fafc;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --sidebar-width: 280px;
            --header-height: 80px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Sidebar - Same as other pages */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            color: white;
        }

        .sidebar-brand i {
            font-size: 2rem;
            margin-right: 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            border-radius: 12px;
        }

        .sidebar-nav {
            padding: 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-400);
            padding: 0 1.5rem;
            margin-bottom: 0.75rem;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: 0;
            font-weight: 500;
            position: relative;
        }

        .nav-link:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-link.active {
            color: var(--primary);
            background: var(--primary-light);
            border-right: 3px solid var(--primary);
        }

        .nav-link i {
            font-size: 1.25rem;
            margin-right: 0.75rem;
            width: 1.5rem;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: var(--gray-50);
            padding: 1rem;
            overflow-x: auto;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            height: var(--header-height);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-left h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        .header-subtitle {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            border: 2px solid var(--primary-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-avatar:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        /* Content Area */
        .content-area {
            padding: 2rem;
        }

        /* Report Filters */
        .filters-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            margin-bottom: 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control, .form-select {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        /* Inventory Reports Section */
        .inventory-reports-section {
            margin-bottom: 3rem;
            display: none; /* Hidden for now */
        }

        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .section-header h3 {
            color: var(--gray-800);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .section-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-item {
            background: white;
            border: 2px solid var(--gray-100);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .report-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .report-item.comprehensive {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%);
            border-color: var(--primary);
        }

        .report-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.75rem;
            color: white;
            box-shadow: var(--shadow-md);
        }

        .stock-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .movement-icon { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .batch-icon { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .turnover-icon { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .supplier-icon { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .comprehensive-icon { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }

        .report-content h6 {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .report-content p {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .report-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-report {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            flex: 1;
            justify-content: center;
            text-decoration: none;
        }

        .btn-report:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-report.view {
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn-report.view:hover {
            background: var(--primary);
            color: white;
        }

        .btn-report.pdf {
            color: var(--danger);
            border-color: var(--danger);
        }

        .btn-report.pdf:hover {
            background: var(--danger);
            color: white;
        }

        .btn-report.comprehensive-btn {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: 700;
        }

        .btn-report.comprehensive-btn:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-2px) scale(1.02);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.primary::before { background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .stat-card.success::before { background: linear-gradient(90deg, var(--success), #059669); }
        .stat-card.warning::before { background: linear-gradient(90deg, var(--warning), #d97706); }
        .stat-card.danger::before { background: linear-gradient(90deg, var(--danger), #dc2626); }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-icon.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .stat-icon.success { background: linear-gradient(135deg, var(--success), #059669); }
        .stat-icon.warning { background: linear-gradient(135deg, var(--warning), #d97706); }
        .stat-icon.danger { background: linear-gradient(135deg, var(--danger), #dc2626); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
        }

        .stat-label {
            color: var(--gray-500);
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        /* Enhanced Chart Styling */
        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .chart-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }

        .chart-subtitle {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            margin-bottom: 0;
        }

        /* Professional Stats Cards */
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 16px 16px 0 0;
        }

        .stat-card.primary::before { background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .stat-card.success::before { background: linear-gradient(90deg, var(--success), #059669); }
        .stat-card.warning::before { background: linear-gradient(90deg, var(--warning), #d97706); }
        .stat-card.danger::before { background: linear-gradient(90deg, var(--danger), #dc2626); }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-icon.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .stat-icon.success { background: linear-gradient(135deg, var(--success), #059669); }
        .stat-icon.warning { background: linear-gradient(135deg, var(--warning), #d97706); }
        .stat-icon.danger { background: linear-gradient(135deg, var(--danger), #dc2626); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
        }

        .stat-label {
            color: var(--gray-500);
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        /* Professional Filters */
        .filters-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            margin-bottom: 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control, .form-select {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        /* Professional Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
            align-items: center;
            justify-content: flex-end;
        }

        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-modern.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-modern.success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-modern.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-modern.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        /* Professional Tab Styling */
        .nav-tabs {
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 0;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 0;
            color: var(--gray-600);
            font-weight: 500;
            padding: 1rem 1.5rem;
            transition: all 0.2s ease;
            background: transparent;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            background: var(--primary-light);
            border-bottom-color: var(--primary-light);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background: var(--primary-light);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .nav-tabs .nav-link i {
            font-size: 1rem;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 16px 16px;
        }

        .tab-pane {
            padding: 0;
        }

        /* Enhanced Table Styling */
        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
            font-weight: 600;
            color: var(--gray-700);
            padding: 1rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .table tbody td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
            font-weight: 500;
        }

        .table tbody tr:hover {
            background: var(--gray-50);
        }

        /* Cashbook Report Styles */
        .cashbook-header {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }

        .cashbook-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .cashbook-account-info {
            flex: 1;
        }

        .account-details {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .cashbook-logo-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 2;
            justify-content: center;
        }

        .cashbook-logo {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-circle {
            width: 80px;
            height: 80px;
            border: 3px solid var(--primary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-light) 0%, white 100%);
        }

        .logo-text {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            line-height: 1;
        }

        .logo-year {
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-top: 2px;
        }

        .cashbook-title {
            text-align: center;
        }

        .main-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--dark);
            margin: 0;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-top: 0.5rem;
        }

        .organization {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        .cashbook-actions {
            flex: 1;
            display: flex;
            justify-content: flex-end;
        }

        .btn-print-cashbook {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn-print-cashbook:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .cashbook-header-bottom {
            padding: 1.5rem 2rem;
            background: var(--gray-50);
        }

        .report-info {
            display: flex;
            gap: 2rem;
            justify-content: center;
        }

        .info-item {
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        .info-item strong {
            color: var(--gray-800);
        }

        /* Professional Table Styles */
        .cashbook-table-container {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 100%;
        }

        .cashbook-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .cashbook-table thead th {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            padding: 1rem 0.75rem;
            font-weight: 700;
            color: var(--gray-800);
            text-align: left;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cashbook-table tbody td {
            border: 1px solid var(--gray-200);
            padding: 0.75rem;
            vertical-align: middle;
            color: var(--gray-700);
        }

        .cashbook-table tbody tr:nth-child(even) {
            background: var(--gray-50);
        }

        .cashbook-table tbody tr:hover {
            background: var(--primary-light);
            cursor: pointer;
        }

        .cashbook-table tbody tr.clickable {
            cursor: pointer;
        }

        .cashbook-table tbody tr.clickable:hover {
            background: var(--primary-light);
        }

        /* Modal Styles */
        .report-modal .modal-dialog {
            max-width: 800px;
        }

        .report-modal .modal-header {
            background: var(--primary);
            color: white;
        }

        .report-modal .modal-body {
            padding: 2rem;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h6 {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 0.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .detail-label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .detail-value {
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Financial columns alignment */
        .cashbook-table .amount-col {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .cashbook-table .date-col {
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .cashbook-table .reference-col {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        /* Currency formatting */
        .currency {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .currency::before {
            content: "â‚±";
            margin-right: 2px;
        }

        /* Detailed Transactions Styles */
        .detailed-transactions-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }

        .transaction-summary-card {
            background: linear-gradient(135deg, var(--primary-light) 0%, white 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .transaction-summary-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .transaction-summary-card .card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 1rem;
        }

        .transaction-summary-card .card-header i {
            font-size: 1.2rem;
            color: var(--primary);
        }

        .transaction-summary-card .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .itemized-details-section {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .section-title {
            color: var(--gray-800);
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary);
        }

        /* Enhanced table styling for detailed views */
        .cashbook-table .batch-ids {
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            color: var(--gray-600);
            max-width: 120px;
            word-break: break-all;
            line-height: 1.2;
        }

        .cashbook-table .customer-info {
            max-width: 100px;
            word-break: break-word;
            font-size: 0.85rem;
        }

        .cashbook-table .address-info {
            max-width: 120px;
            word-break: break-word;
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .cashbook-table .date-col {
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .cashbook-table .reference-col {
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .cashbook-table .amount-col {
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* Compact table styling */
        .cashbook-table {
            font-size: 0.8rem;
        }

        .cashbook-table thead th {
            padding: 0.5rem 0.3rem;
            font-size: 0.75rem;
        }

        .cashbook-table tbody td {
            padding: 0.4rem 0.3rem;
            font-size: 0.8rem;
        }

        /* Remove horizontal scroll */
        .cashbook-table-container {
            overflow-x: visible;
        }

        /* Ensure table fits in viewport */
        .cashbook-table {
            min-width: auto;
            width: 100%;
        }

        /* Status badges for detailed transactions */
        .status-completed {
            background: var(--success);
            color: white;
        }

        .status-pending {
            background: var(--warning);
            color: white;
        }

        .status-cancelled {
            background: var(--danger);
            color: white;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .main-content {
                padding: 0.5rem;
            }
            
            .reports-container {
                padding: 1.5rem;
            }
            
            .reports-controls-section {
                padding: 1rem;
            }
            
            .summary-card {
                padding: 1rem;
            }
            
            .summary-card .card-icon {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .summary-card .card-value {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 0.5rem;
            }

            .header {
                padding: 0 1rem;
            }

            .reports-container {
                padding: 1rem;
            }

            .reports-controls-section {
                padding: 1rem;
            }

            .reports-controls-section .row {
                flex-direction: column;
                gap: 1rem;
            }

            .date-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .action-buttons {
                justify-content: center;
            }

            .summary-card {
                margin-bottom: 1rem;
                padding: 1rem;
            }

            .summary-card .card-icon {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }

            .summary-card .card-value {
                font-size: 1.3rem;
            }

            .tabs-section .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            /* Make table even more compact on mobile */
            .cashbook-table {
                font-size: 0.7rem;
            }

            .cashbook-table thead th {
                padding: 0.3rem 0.2rem;
                font-size: 0.65rem;
            }

            .cashbook-table tbody td {
                padding: 0.3rem 0.2rem;
                font-size: 0.7rem;
            }

            .cashbook-table .batch-ids {
                font-size: 0.6rem;
                max-width: 80px;
            }

            .cashbook-table .customer-info {
                max-width: 80px;
                font-size: 0.7rem;
            }

            .cashbook-table .address-info {
                max-width: 80px;
                font-size: 0.65rem;
            }

            /* Stack summary cards vertically on mobile */
            .row.mb-4 {
                margin-bottom: 1rem !important;
            }

            .col-md-3 {
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 0.25rem;
            }
            
            .cashbook-header-top {
                padding: 0.5rem;
            }
            
            .cashbook-header-bottom {
                padding: 0.5rem;
            }
            
            .detailed-transactions-container {
                padding: 0.25rem;
            }
            
            .main-title {
                font-size: 1.5rem;
            }
            
            .transaction-summary-card {
                padding: 1rem;
            }
            
            .transaction-summary-card .card-value {
                font-size: 1rem;
            }
        }

        /* Reports Container Styling */
        .reports-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
        }

        /* Reports Controls Section */
        .reports-controls-section {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--gray-200);
        }

        .date-range-section .form-label {
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .date-input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .date-input-group .form-select {
            flex: 1;
            max-width: 200px;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            align-items: center;
        }

        /* Summary Cards Section */
        .summary-cards-section {
            margin-bottom: 2rem;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            height: 100%;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .summary-card .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .revenue-card .card-icon {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .transactions-card .card-icon {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .items-card .card-icon {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .average-card .card-icon {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .summary-card .card-content {
            flex: 1;
        }

        .summary-card .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
            font-family: 'Courier New', monospace;
        }

        .summary-card .card-label {
            font-size: 0.85rem;
            color: var(--gray-600);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Charts Section */
        .charts-section {
            margin-bottom: 2rem;
        }

        /* Tabs Section */
        .tabs-section {
            margin-bottom: 2rem;
        }

        .tabs-section .nav-tabs {
            border-bottom: 2px solid var(--gray-200);
        }

        .tabs-section .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--gray-600);
            font-weight: 600;
            padding: 1rem 1.5rem;
            transition: all 0.3s ease;
        }

        .tabs-section .nav-link:hover {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tabs-section .nav-link.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            background: none;
        }

        /* Chart Preview Styling */
        .chart-previews {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chart-preview-item {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .chart-preview-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .preview-header h5 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .preview-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .preview-chart {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .preview-description {
            margin: 0;
            font-size: 0.8rem;
            color: var(--gray-600);
            text-align: center;
        }


        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-modern.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-modern.success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-modern.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 0 1rem;
            }

            /* Mobile menu toggle button - SHOW ON MOBILE */
            #mobileMenuToggle {
                display: flex !important;
                background: #007bff !important;
                border: 2px solid #000000 !important;
                color: #ffffff !important;
                min-width: 44px !important;
                min-height: 44px !important;
                position: relative !important;
                z-index: 9999 !important;
            }

            .content-area {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
        }

        /* Desktop - Hide mobile menu button */
        @media (min-width: 769px) {
            #mobileMenuToggle {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="{% url 'dashboard' %}" class="sidebar-brand">
                    <i class="bi bi-basket-fill"></i>
                    StockWise
                </a>
        </div>

            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item">
                        <a href="{% url 'dashboard' %}" class="nav-link">
                            <i class="bi bi-speedometer2"></i>
                            Dashboard
                        </a>
                </div>
                    <div class="nav-item">
                        <a href="{% url 'products_inventory' %}" class="nav-link">
                            <i class="bi bi-basket"></i>
                            Inventory
                        </a>
                </div>
                    <div class="nav-item">
                        <a href="{% url 'sales' %}" class="nav-link">
                            <i class="bi bi-cart"></i>
                            Sales
                        </a>
            </div>
        </div>

                <div class="nav-section">
                    <div class="nav-section-title">Reports</div>
                    <div class="nav-item">
                        <a href="{% url 'reports' %}" class="nav-link active">
                            <i class="bi bi-table"></i>
                            Reports
                        </a>
            </div>
        </div>

                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <div class="nav-item">
                        <a href="{% url 'profile' %}" class="nav-link">
                            <i class="bi bi-person"></i>
                            Profile
                        </a>
                    </div>
                    {% if app_role == 'admin' %}
                    <div class="nav-item">
                        <a href="{% url 'sms_settings' %}" class="nav-link">
                            <i class="bi bi-chat-dots"></i>
                            SMS Settings
                        </a>
                    </div>
                    {% endif %}
                    <div class="nav-item">
                        <a href="{% url 'logout' %}" class="nav-link">
                            <i class="bi bi-box-arrow-right"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1>Reports</h1>
                    <p class="header-subtitle">Sales and inventory data analysis</p>
                </div>
                <div class="header-right">
                    <!-- Mobile Menu Toggle Button -->
                    <button id="mobileMenuToggle" class="btn btn-outline-secondary btn-sm me-3 mobile-menu-btn" style="min-width: 44px; min-height: 44px; display: flex !important; align-items: center; justify-content: center; background: #007bff !important; border: 2px solid #000000 !important; color: #ffffff !important; position: relative; z-index: 9999;">
                        <i class="bi bi-list" style="font-size: 1.2rem;"></i>
                        <span class="ms-1">Menu</span>
                    </button>

                    <div class="dropdown">
                        <img src="https://via.placeholder.com/40" alt="User" class="user-avatar" data-bs-toggle="dropdown">
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Main Content Layout -->

                <!-- Inventory Reports Section -->
                <div class="inventory-reports-section">
                    <div class="section-header">
                        <h3><i class="bi bi-file-earmark-bar-graph me-2"></i>Inventory Reports</h3>
                        <p class="section-subtitle">Comprehensive inventory analysis and insights</p>
                    </div>
                    
                    <div class="reports-grid">
                        <!-- Stock Snapshot Report -->
                        <div class="report-item">
                            <div class="report-icon stock-icon">
                                <i class="bi bi-clipboard-data"></i>
                            </div>
                            <div class="report-content">
                                <h6>Stock Snapshot</h6>
                                <p>Current stock levels, values, and low stock alerts</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('stock')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('stock')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Movement Report -->
                        <div class="report-item">
                            <div class="report-icon movement-icon">
                                <i class="bi bi-arrow-left-right"></i>
                            </div>
                            <div class="report-content">
                                <h6>Stock Movement</h6>
                                <p>Stock additions and sales history with FIFO tracking</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('movement')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('movement')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Batch Report -->
                        <div class="report-item">
                            <div class="report-icon batch-icon">
                                <i class="bi bi-layers"></i>
                            </div>
                            <div class="report-content">
                                <h6>Active Batches</h6>
                                <p>Individual batch tracking, aging analysis, and expiry alerts</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('batches')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('batches')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Turnover Report -->
                        <div class="report-item">
                            <div class="report-icon turnover-icon">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            <div class="report-content">
                                <h6>Inventory Turnover</h6>
                                <p>Sales velocity, days of cover, and stock optimization</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('turnover')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('turnover')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Supplier Report -->
                        <div class="report-item">
                            <div class="report-icon supplier-icon">
                                <i class="bi bi-truck"></i>
                            </div>
                            <div class="report-content">
                                <h6>Supplier Analysis</h6>
                                <p>Supplier performance, delivery frequency, and reliability</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('suppliers')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('suppliers')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Comprehensive PDF -->
                        <div class="report-item comprehensive">
                            <div class="report-icon comprehensive-icon">
                                <i class="bi bi-file-earmark-text"></i>
                            </div>
                            <div class="report-content">
                                <h6>Complete Inventory Report</h6>
                                <p>All reports combined in a comprehensive PDF document</p>
                                <div class="report-actions">
                                    <button class="btn-report pdf comprehensive-btn" onclick="downloadInventoryPDF('comprehensive')">
                                        <i class="bi bi-download"></i> Download Complete PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Custom Date Range Modal -->
                <div class="modal fade" id="customRangeModal" tabindex="-1" aria-labelledby="customRangeModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="customRangeModalLabel">Select Custom Date Range</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customStart" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="customStart">
                                </div>
                                <div class="mb-3">
                                    <label for="customEnd" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="customEnd">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="applyCustomRange">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>

                

                <!-- Main Content Layout -->
                <div class="reports-container">
                    <!-- Controls Section -->
                    <div class="reports-controls-section">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="date-range-section">
                                    <label class="form-label fw-bold">DATE RANGE</label>
                                    <div class="date-input-group">
                                        <select class="form-select" id="dateRange">
                                            <option value="today">Today</option>
                                            <option value="week">This Week</option>
                                            <option value="month">This Month</option>
                                            <option value="custom">Custom Range</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-modern primary" id="generateReport">
                                        <i class="bi bi-bar-chart"></i> Generate Report
                                    </button>
                                    <a href="{% url 'charts' %}" class="btn btn-info me-2">
                                        <i class="bi bi-bar-chart"></i> View Charts
                                    </a>
                                    <button type="button" class="btn btn-success me-2" onclick="exportCompletePDF()">
                                        <i class="bi bi-file-pdf"></i> Export PDF
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="window.print()">
                                        <i class="bi bi-printer"></i> Print Report
                                    </button>
                            </div>
                            </div>
                        </div>
                            </div>


                    <!-- Summary Cards Section -->
                    <div class="summary-cards-section">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="summary-card revenue-card">
                                    <div class="card-icon">
                                        <i class="bi bi-currency-dollar"></i>
                                    </div>
                                    <div class="card-content">
                                        <div class="card-value" id="statTotalRevenue">â‚±0.00</div>
                                        <div class="card-label">TOTAL REVENUE</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-card transactions-card">
                                    <div class="card-icon">
                                        <i class="bi bi-cart"></i>
                                    </div>
                                    <div class="card-content">
                                        <div class="card-value" id="statTransactions">0</div>
                                        <div class="card-label">TOTAL TRANSACTIONS</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-card items-card">
                                    <div class="card-icon">
                                        <i class="bi bi-boxes"></i>
                                    </div>
                                    <div class="card-content">
                                        <div class="card-value" id="statItemsSold">0</div>
                                        <div class="card-label">ITEMS SOLD</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-card average-card">
                                    <div class="card-icon">
                                        <i class="bi bi-graph-up"></i>
                                    </div>
                                    <div class="card-content">
                                        <div class="card-value" id="statAvgOrder">â‚±0.00</div>
                                        <div class="card-label">AVERAGE SALE</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                            
                            <!-- Tab Navigation -->
                    <div class="tabs-section">
                            <ul class="nav nav-tabs" id="reportsTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab" aria-controls="sales" aria-selected="true">
                                        <i class="bi bi-graph-up me-2"></i>Sales Summary
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">
                                        <i class="bi bi-star me-2"></i>Top Products
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab" aria-controls="inventory" aria-selected="false">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Low Stock
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab" aria-controls="transactions" aria-selected="false">
                                        <i class="bi bi-receipt me-2"></i>Transactions
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                                        <i class="bi bi-graph-up me-2"></i>Product Performance
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="inventory-reports-tab" data-bs-toggle="tab" data-bs-target="#inventory-reports" type="button" role="tab" aria-controls="inventory-reports" aria-selected="false">
                                        <i class="bi bi-boxes me-2"></i>Inventory Reports
                                    </button>
                                </li>
                            </ul>
                    </div>

                            <!-- Tab Content -->
                            <div class="tab-content" id="reportsTabContent">
                                <!-- Sales Summary Tab -->
                                <div class="tab-pane fade show active" id="sales" role="tabpanel" aria-labelledby="sales-tab">
                                    <div class="cashbook-table-container table-responsive-wrapper mt-3">
                                        <table class="cashbook-table table-mobile-card">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Product</th>
                                                    <th>Particulars</th>
                                                    <th>Reference</th>
                                                    <th>Quantity</th>
                                                    <th>Revenue</th>
                                                    <th>Profit</th>
                                                    <th>Balance</th>
                                                </tr>
                                            </thead>
                                            <tbody id="summaryBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Top Products Tab -->
                                <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                                    <div class="cashbook-table-container table-responsive-wrapper mt-3">
                                        <table class="cashbook-table table-mobile-card">
                                            <thead>
                                                <tr>
                                                    <th>Rank</th>
                                                    <th>Product</th>
                                                    <th>Size</th>
                                                    <th>Particulars</th>
                                                    <th>Boxes Sold</th>
                                                    <th>Revenue</th>
                                                    <th>Performance</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Low Stock Tab -->
                                <div class="tab-pane fade" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
                                    <div class="cashbook-table-container table-responsive-wrapper mt-3">
                                        <table class="cashbook-table table-mobile-card">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Product</th>
                                                    <th>Size</th>
                                                    <th>Particulars</th>
                                                    <th>Current Stock</th>
                                                    <th>Price</th>
                                                    <th>Status</th>
                                                    <th>Action Required</th>
                                                </tr>
                                            </thead>
                                            <tbody id="lowBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Transactions Tab -->
                                <div class="tab-pane fade" id="transactions" role="tabpanel" aria-labelledby="transactions-tab">
                                    <div class="detailed-transactions-container mt-3">
                                        <!-- Transaction Summary Cards -->
                                        <div class="stats-grid mb-4">
                                            <div class="stat-card">
                                                <div class="card-header">
                                                    <i class="bi bi-receipt"></i>
                                                    <span>Total Transactions</span>
                                                </div>
                                                <div class="card-value" id="totalTransactionsCount">0</div>
                                            </div>
                                            <div class="stat-card">
                                                <div class="card-header">
                                                    <i class="bi bi-currency-dollar"></i>
                                                    <span>Total Revenue</span>
                                                </div>
                                                <div class="card-value" id="totalRevenueAmount">â‚±0.00</div>
                                            </div>
                                            <div class="stat-card">
                                                <div class="card-header">
                                                    <i class="bi bi-percent"></i>
                                                    <span>Total VAT</span>
                                                </div>
                                                <div class="card-value" id="totalVATAmount">â‚±0.00</div>
                                            </div>
                                            <div class="stat-card">
                                                <div class="card-header">
                                                    <i class="bi bi-people"></i>
                                                    <span>Unique Customers</span>
                                                </div>
                                                <div class="card-value" id="uniqueCustomersCount">0</div>
                                            </div>
                                        </div>

                                        <!-- Main Transactions Table -->
                                        <div class="cashbook-table-container table-responsive-wrapper">
                                            <table class="cashbook-table table-mobile-card">
                                            <thead>
                                                <tr>
                                                        <th>Sale ID</th>
                                                        <th>Transaction No.</th>
                                                        <th>OR No.</th>
                                                        <th>Date & Time</th>
                                                        <th>Customer</th>
                                                        <th>Contact</th>
                                                        <th>Address</th>
                                                        <th>Processed By</th>
                                                        <th>Fruits</th>
                                                        <th>Size</th>
                                                        <th>Items</th>
                                                    <th>Boxes</th>
                                                        <th>Subtotal</th>
                                                        <th>VAT (12%)</th>
                                                    <th>Total</th>
                                                        <th>Amount Paid</th>
                                                        <th>Change</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="txBody"></tbody>
                                        </table>
                                        </div>

                                        <!-- Itemized Details Section -->
                                        <div class="itemized-details-section mt-4">
                                            <h5 class="section-title">Itemized Transaction Details</h5>
                                            <div class="cashbook-table-container table-responsive-wrapper">
                                                <table class="cashbook-table table-mobile-card">
                                                    <thead>
                                                        <tr>
                                                            <th>Sale ID</th>
                                                            <th>Description</th>
                                                            <th>Qty</th>
                                                            <th>Batch ID(s)</th>
                                                            <th>Price</th>
                                                            <th>Amount</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="itemizedDetailsBody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Product Performance Tab -->
                                <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                                    <div class="cashbook-table-container mt-3">
                                        <table class="cashbook-table">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Product</th>
                                                    <th>Particulars</th>
                                                    <th>Period</th>
                                                    <th>Opening Qty</th>
                                                    <th>Added Qty</th>
                                                    <th>Sold Qty</th>
                                                    <th>Closing Qty</th>
                                                    <th>Revenue</th>
                                                    <th>COGS</th>
                                                    <th>Gross Profit</th>
                                                    <th>Margin %</th>
                                                    <th>Performance</th>
                                                </tr>
                                            </thead>
                                            <tbody id="summaryReportsBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Inventory Reports Tab -->
                                <div class="tab-pane fade" id="inventory-reports" role="tabpanel" aria-labelledby="inventory-reports-tab">
                                    <div class="cashbook-table-container mt-3">
                                        <table class="cashbook-table">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Product</th>
                                                    <th>Particulars</th>
                                                    <th>Last Price</th>
                                                    <th>Suggested Price</th>
                                                    <th>Price Action</th>
                                                    <th>Demand Level</th>
                                                    <th>First Sale</th>
                                                    <th>Last Sale</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inventoryReportsBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                            </div>
                            
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="{% static 'js/modern-inventory.js' %}"></script>
    <script>
        // Initialize date inputs with current date
        const today = new Date().toISOString().split('T')[0];

        // Custom range state/labeling like Sales page
        let customStart = '';
        let customEnd = '';
        const dateRangeSelect = document.getElementById('dateRange');
        function updateRangeLabels(){
            const fmt = (d)=> new Date(d).toLocaleDateString(undefined,{month:'short',day:'numeric'});
            const todayDate = new Date();
            const weekStart = new Date(todayDate); weekStart.setDate(weekStart.getDate()-7);
            const monthStart = new Date(todayDate); monthStart.setDate(monthStart.getDate()-30);
            if(dateRangeSelect){
                const optW = dateRangeSelect.querySelector('option[value="week"]');
                const optM = dateRangeSelect.querySelector('option[value="month"]');
                const optT = dateRangeSelect.querySelector('option[value="today"]');
                const optC = dateRangeSelect.querySelector('option[value="custom"]');
                if(optT) optT.textContent = `Today (${todayDate.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'})})`;
                if(optW) optW.textContent = `This Week (${fmt(weekStart)} â€“ ${fmt(todayDate)})`;
                if(optM) optM.textContent = `This Month (${fmt(monthStart)} â€“ ${fmt(todayDate)})`;
                if(optC) optC.textContent = customStart ? `Custom (${fmt(customStart)} â€“ ${fmt(customEnd||customStart)})` : 'Custom Range';
            }
        }
        updateRangeLabels();


        // Helper function to update stat cards with visual feedback
        function updateStatCard(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                element.style.backgroundColor = '#e8f5e8'; // Light green highlight
                setTimeout(() => element.style.backgroundColor = '', 1000);
            }
        }

        // Prevent multiple simultaneous calls
        let isLoadingReports = false;

        async function loadReports() {
            // Prevent multiple simultaneous calls
            if (isLoadingReports) {
                console.log('Reports already loading, skipping...');
                return;
            }
            
            isLoadingReports = true;
            
            // Show loading state
            const generateBtn = document.getElementById('generateReport');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
            generateBtn.disabled = true;

            try {
            const dateRangeValue = document.getElementById('dateRange')?.value || 'today';
            let startDate = today;
            let endDate = today;

            // Calculate date range based on selection
            if (dateRangeValue === 'today') {
                startDate = today;
                endDate = today;
            } else if (dateRangeValue === 'yesterday') {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                startDate = yesterday.toISOString().split('T')[0];
                endDate = startDate;
            } else if (dateRangeValue === 'week') {
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - 7);
                startDate = weekStart.toISOString().split('T')[0];
                endDate = today;
            } else if (dateRangeValue === 'month') {
                const monthStart = new Date();
                monthStart.setDate(monthStart.getDate() - 30);
                startDate = monthStart.toISOString().split('T')[0];
                endDate = today;
            } else if (dateRangeValue === 'custom' && customStart && customEnd) {
                startDate = customStart;
                endDate = customEnd;
            }

            const params = new URLSearchParams({
                filter: dateRangeValue.toLowerCase(),
                start_date: startDate,
                end_date: endDate
            });
            console.log('Fetching reports with params:', params.toString());
            const res = await fetch("{% url 'fetch_reports' %}?"+params.toString());
            
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const json = await res.json();
            console.log('=== API RESPONSE DEBUG ===');
            console.log('Date range:', dateRangeValue, 'from', startDate, 'to', endDate);
            console.log('Success:', json.success);
            console.log('Data keys:', Object.keys(json.data || {}));
            console.log('Transactions count:', (json.data?.transactions || []).length);
            console.log('Sample transaction:', (json.data?.transactions || [])[0]);
            console.log('Top fruits count:', (json.data?.top_fruits || []).length);
            console.log('Low stock count:', (json.data?.low_stock || []).length);
            console.log('Summary reports count:', (json.data?.summary_reports || []).length);
            console.log('========================');

            if (!json.success || !json.data) {
                console.log('No data received from API:', json);
                // Clear UI to explicit empty state
                updateStatCard('statTotalRevenue', 'â‚±0.00');
                updateStatCard('statTransactions', '0');
                updateStatCard('statItemsSold', '0');
                updateStatCard('statAvgOrder', 'â‚±0.00');
                document.getElementById('summaryBody').innerHTML = '<tr><td colspan="8" class="text-center text-muted"><i class="bi bi-info-circle me-2"></i>No sales data for selected range.</td></tr>';
                document.getElementById('topBody').innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-graph-up me-2"></i>No top products data available.</td></tr>';
                document.getElementById('lowBody').innerHTML = '<tr><td colspan="8" class="text-center text-muted"><i class="bi bi-exclamation-triangle me-2"></i>No low stock items.</td></tr>';
                document.getElementById('txBody').innerHTML = '<tr><td colspan="18" class="text-center text-muted"><i class="bi bi-receipt me-2"></i>No transactions found.</td></tr>';
                const srb = document.getElementById('summaryReportsBody'); if(srb) srb.innerHTML = '<tr><td colspan="13" class="text-center text-muted"><i class="bi bi-bar-chart me-2"></i>No product performance data yet.</td></tr>';
                return;
            }
            const d = json.data || {};
            
            // Update stats cards
            const ss = d.sales_summary || {};

            // Update with visual feedback
            updateStatCard('statTotalRevenue', 'â‚±'+Number(ss.total_revenue||0).toFixed(2));
            updateStatCard('statTransactions', ss.transaction_count||0);
            updateStatCard('statItemsSold', ss.total_items_sold||0);
            updateStatCard('statAvgOrder', 'â‚±'+Number(ss.avg_order_value||0).toFixed(2));

            // Populate data tables with date range context
            try {
                const dateContext = {
                    startDate: startDate,
                    endDate: endDate,
                    dateRange: dateRangeValue
                };
                
                console.log('Populating tables with data:', {
                    fruit_summary: (d.fruit_summary||[]).length,
                    top_fruits: (d.top_fruits||[]).length,
                    low_stock: (d.low_stock||[]).length,
                    transactions: (d.transactions||[]).length,
                    summary_reports: (d.summary_reports||[]).length
                });
                
                populateSummaryTable(d || {fruit_summary:[]}, dateContext);
                populateTopProductsTable(d || {top_fruits:[]}, dateContext);
                populateLowStockTable(d || {low_stock:[]}, dateContext);
                populateTransactionsTable(d || {transactions:[]}, dateContext);
                populateSummaryReportsTable(d || {summary_reports:[]}, dateContext);
                populateInventoryReportsTable(d || {summary_reports:[]}, dateContext);
                console.log('All tables populated successfully');
            } catch (populateError) {
                console.error('Error populating tables:', populateError);
            }

            // Show success feedback
            generateBtn.innerHTML = '<i class="bi bi-check-circle"></i> Report Generated';
            setTimeout(() => {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
                isLoadingReports = false; // Reset loading flag
            }, 2000);

            } catch (error) {
                console.error('Error generating report:', error);
                generateBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error';
                setTimeout(() => {
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                    isLoadingReports = false; // Reset loading flag
                }, 3000);

                // Show more specific error message to user
                let errorMessage = 'Error generating report. Please try again.';
                if (error.message.includes('fetch_reports')) {
                    errorMessage = 'Unable to connect to reports server. Please check your connection.';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = 'Server error occurred. Please try again later.';
                } else if (error.message.includes('JSON')) {
                    errorMessage = 'Invalid response from server. Please refresh the page.';
                }
                alert(errorMessage);
            }
        }



        function populateSummaryTable(data, dateContext = {}) {
            const summaryBody = document.getElementById('summaryBody');
            const rows = (data.fruit_summary||[]);
            if(!rows.length){ 
                summaryBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data for selected range.</td></tr>'; 
                return; 
            }
            
            let runningBalance = 0;
            summaryBody.innerHTML = rows.map((r, index) => {
                // Use actual transaction date if available, otherwise use current date
                const transactionDate = r.date || r.created_at || new Date();
                const date = new Date(transactionDate).toLocaleDateString('en-US', { 
                    month: '2-digit', 
                    day: '2-digit', 
                    year: 'numeric' 
                });
                const revenue = Number(r.revenue||0);
                runningBalance += revenue;
                
                return `
                    <tr class="clickable" onclick="showReportDetails('sales', ${index}, ${JSON.stringify(r).replace(/"/g, '&quot;')})">
                        <td class="date-col">${date}</td>
                        <td><strong>${r.name}</strong></td>
                        <td>Sales Transaction</td>
                        <td class="reference-col">SALE-${String(index + 1).padStart(3, '0')}</td>
                        <td class="amount-col">${r.boxes_sold ?? 0}</td>
                        <td class="amount-col currency">${revenue.toFixed(2)}</td>
                        <td class="amount-col currency">${(revenue * 0.3).toFixed(2)}</td>
                        <td class="amount-col currency">${runningBalance.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            // Update entries count (optional - element may not exist)
            const entriesCountEl = document.getElementById('entriesCount');
            if (entriesCountEl) {
                entriesCountEl.textContent = rows.length;
            }
        }

        function populateTopProductsTable(data, dateContext = {}) {
            const topBody = document.getElementById('topBody');
            const rows = (data.top_fruits||[]);
            if(!rows.length){ 
                topBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No data for selected range.</td></tr>'; 
                return; 
            }
            
            topBody.innerHTML = rows.map((t, index) => {
                // Use actual transaction date if available, otherwise use current date
                const transactionDate = t.date || t.created_at || new Date();
                const date = new Date(transactionDate).toLocaleDateString('en-US', { 
                    month: '2-digit', 
                    day: '2-digit', 
                    year: 'numeric' 
                });
                const revenue = Number(t.revenue||0);
                const performance = revenue > 1000 ? 'High' : revenue > 500 ? 'Medium' : 'Low';
                
                return `
                    <tr class="clickable" onclick="showReportDetails('top_products', ${index}, ${JSON.stringify(t).replace(/"/g, '&quot;')})">
                        <td class="amount-col">#${index + 1}</td>
                        <td><strong>${t.name}</strong></td>
                        <td><span class="badge bg-secondary">${t.size||''}</span></td>
                        <td>Top Product Performance</td>
                        <td class="amount-col">${t.boxes_sold??0}</td>
                        <td class="amount-col currency">${revenue.toFixed(2)}</td>
                        <td><span class="badge ${performance === 'High' ? 'bg-success' : performance === 'Medium' ? 'bg-warning' : 'bg-secondary'}">${performance}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function populateLowStockTable(data, dateContext = {}) {
            const lowBody = document.getElementById('lowBody');
            const rows = (data.low_stock||[]);
            if(!rows.length){ 
                lowBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No low stock items.</td></tr>'; 
                return; 
            }
            
            lowBody.innerHTML = rows.map(i => {
                // Use actual inventory date if available, otherwise use current date
                const inventoryDate = i.date || i.last_updated || new Date();
                const date = new Date(inventoryDate).toLocaleDateString('en-US', { 
                    month: '2-digit', 
                    day: '2-digit', 
                    year: 'numeric' 
                });
                const stock = Number(i.stock||0);
                const status = stock === 0 ? 'Out of Stock' : stock <= 5 ? 'Critical' : 'Low';
                const action = stock === 0 ? 'Restock Immediately' : stock <= 5 ? 'Order Soon' : 'Monitor';
                
                return `
                    <tr class="clickable" onclick="showReportDetails('low_stock', ${rows.indexOf(i)}, ${JSON.stringify(i).replace(/"/g, '&quot;')})">
                        <td class="date-col">${date}</td>
                        <td><strong>${i.name}</strong></td>
                        <td><span class="badge bg-secondary">${i.size||''}</span></td>
                        <td>Low Stock Alert</td>
                        <td class="amount-col"><span class="badge bg-danger">${stock}</span></td>
                        <td class="amount-col currency">${Number(i.price||0).toFixed(2)}</td>
                        <td><span class="badge ${status === 'Out of Stock' ? 'bg-danger' : status === 'Critical' ? 'bg-warning' : 'bg-info'}">${status}</span></td>
                        <td><span class="badge bg-primary">${action}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function populateTransactionsTable(data, dateContext = {}) {
            const txBody = document.getElementById('txBody');
            const itemizedBody = document.getElementById('itemizedDetailsBody');
            const rows = (data.transactions||[]);
            
            if(!rows.length){ 
                txBody.innerHTML = '<tr><td colspan="18" class="text-center text-muted">No transactions found.</td></tr>';
                itemizedBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No itemized details available.</td></tr>';
                return; 
            }

            // Calculate summary statistics
            let totalTransactions = rows.length;
            let totalRevenue = 0;
            let totalVAT = 0;
            let uniqueCustomers = new Set();

            // Populate main transactions table with all details
            txBody.innerHTML = rows.map(x => {
                // Format date/time properly (backend already sends formatted string)
                const formattedDateTime = x.recorded_at || 'N/A';
                
                // Use backend-calculated values
                const subtotal = Number(x.subtotal||0);
                const vat = Number(x.vat||0);
                const total = Number(x.total||0);
                const amountPaid = Number(x.amount_paid||0);
                const change = amountPaid - total;
                
                // Get proper field names from backend
                const customer = x.customer_name || 'N/A';
                const contact = x.contact_number || 'N/A';
                const address = x.address || 'N/A';
                const transactionNo = x.transaction_number || `ORD${String(x.sale_id).padStart(6, '0')}`;
                const orNumber = x.or_number || 'N/A';
                const items = x.items || x.fruit_count || 1;
                
                // Add to totals
                totalRevenue += total;
                totalVAT += vat;
                if (customer && customer !== 'N/A') {
                    uniqueCustomers.add(customer);
                }
                
                return `
                    <tr class="clickable" onclick="showReportDetails('transactions', ${rows.indexOf(x)}, ${JSON.stringify(x).replace(/"/g, '&quot;')})">
                        <td class="reference-col"><strong>${x.sale_id}</strong></td>
                        <td class="reference-col">${transactionNo}</td>
                        <td class="reference-col">${orNumber}</td>
                        <td class="date-col">${formattedDateTime}</td>
                        <td class="customer-info">${customer}</td>
                        <td class="reference-col">${contact}</td>
                        <td class="address-info">${address}</td>
                        <td>${x.processed_by || 'admin'}</td>
                        <td>${x.fruits || 'N/A'}</td>
                        <td class="reference-col">${x.sizes || ''}</td>
                        <td class="amount-col">${items}</td>
                        <td class="amount-col">${x.boxes || x.total_boxes || 0}</td>
                        <td class="amount-col currency">${subtotal.toFixed(2)}</td>
                        <td class="amount-col currency">${vat.toFixed(2)}</td>
                        <td class="amount-col currency">${total.toFixed(2)}</td>
                        <td class="amount-col currency">${amountPaid.toFixed(2)}</td>
                        <td class="amount-col currency">${change.toFixed(2)}</td>
                        <td><span class="badge status-${x.status}">${x.status}</span></td>
                    </tr>
                `;
            }).join('');

            // Populate itemized details table
            itemizedBody.innerHTML = rows.map(x => {
                const fruits = x.fruits || '';
                const sizes = x.sizes || '';
                const quantity = x.total_boxes || 0;
                const price = (Number(x.total||0) / quantity).toFixed(2);
                const amount = Number(x.total||0);
                
                // Generate sample batch IDs (in real implementation, this would come from the database)
                const batchIds = generateBatchIds(x.sale_id, fruits, quantity);
                
                return `
                    <tr>
                        <td class="reference-col"><strong>${x.sale_id}</strong></td>
                        <td>#${x.sale_id} ${fruits} (${sizes})</td>
                        <td class="amount-col">${quantity}</td>
                        <td class="batch-ids">${batchIds}</td>
                        <td class="amount-col currency">${price}</td>
                        <td class="amount-col currency">${amount.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');

            // Update summary cards
            document.getElementById('totalTransactionsCount').textContent = totalTransactions;
            document.getElementById('totalRevenueAmount').textContent = `â‚±${totalRevenue.toFixed(2)}`;
            document.getElementById('totalVATAmount').textContent = `â‚±${totalVAT.toFixed(2)}`;
            document.getElementById('uniqueCustomersCount').textContent = uniqueCustomers.size;
        }

        function populateSummaryReportsTable(data, dateContext = {}) {
            const summaryReportsBody = document.getElementById('summaryReportsBody');
            const rows = (data.summary_reports||[]);
            if(!rows.length){ 
                summaryReportsBody.innerHTML = '<tr><td colspan="13" class="text-center text-muted">No product performance data yet.</td></tr>'; 
                return; 
            }
            
            summaryReportsBody.innerHTML = rows.map(r => {
                // Use actual performance date if available, otherwise use current date
                const performanceDate = r.date || r.created_at || new Date();
                const date = new Date(performanceDate).toLocaleDateString('en-US', { 
                    month: '2-digit', 
                    day: '2-digit', 
                    year: 'numeric' 
                });
                const revenue = Number(r.revenue||0);
                const profit = Number(r.gross_profit||0);
                const margin = revenue > 0 ? ((profit / revenue) * 100) : 0;
                const performance = margin > 30 ? 'Excellent' : margin > 20 ? 'Good' : margin > 10 ? 'Fair' : 'Poor';
                
                return `
                    <tr>
                        <td class="date-col">${date}</td>
                    <td><strong>${r.product_name}</strong></td>
                        <td>Performance Analysis</td>
                        <td><small class="text-muted">${r.period_start} to ${r.period_end}</small></td>
                        <td class="amount-col">${Number(r.opening_qty||0).toFixed(2)}</td>
                        <td class="amount-col"><span class="badge bg-success">${Number(r.added_qty||0).toFixed(2)}</span></td>
                        <td class="amount-col"><span class="badge bg-primary">${Number(r.sold_qty||0).toFixed(2)}</span></td>
                        <td class="amount-col">${Number(r.closing_qty||0).toFixed(2)}</td>
                        <td class="amount-col currency">${revenue.toFixed(2)}</td>
                        <td class="amount-col currency">${Number(r.cogs||0).toFixed(2)}</td>
                        <td class="amount-col currency">${profit.toFixed(2)}</td>
                        <td class="amount-col">${margin.toFixed(1)}%</td>
                        <td><span class="badge ${performance === 'Excellent' ? 'bg-success' : performance === 'Good' ? 'bg-info' : performance === 'Fair' ? 'bg-warning' : 'bg-danger'}">${performance}</span></td>
                </tr>
                `;
            }).join('');
        }

        function populateInventoryReportsTable(data, dateContext = {}) {
            const inventoryReportsBody = document.getElementById('inventoryReportsBody');
            const rows = (data.summary_reports||[]);
            if(!rows.length){ 
                inventoryReportsBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No inventory reports data available.</td></tr>'; 
                return; 
            }
            
            inventoryReportsBody.innerHTML = rows.map(r => {
                // Use actual inventory analysis date if available, otherwise use current date
                const analysisDate = r.date || r.last_updated || new Date();
                const date = new Date(analysisDate).toLocaleDateString('en-US', { 
                    month: '2-digit', 
                    day: '2-digit', 
                    year: 'numeric' 
                });
                const lastPrice = Number(r.last_price||0);
                const suggestedPrice = Number(r.suggested_price||0);
                const status = r.low_stock_flag ? 'Low Stock' : 'Normal';
                
                return `
                    <tr>
                        <td class="date-col">${date}</td>
                    <td><strong>${r.product_name}</strong></td>
                        <td>Inventory Analysis</td>
                        <td class="amount-col currency">${lastPrice.toFixed(2)}</td>
                        <td class="amount-col currency">${suggestedPrice.toFixed(2)}</td>
                    <td><span class="badge ${r.price_action === 'Increase' ? 'bg-success' : r.price_action === 'Decrease' ? 'bg-danger' : 'bg-secondary'}">${r.price_action || 'N/A'}</span></td>
                    <td><span class="badge ${r.demand_level === 'High' ? 'bg-success' : r.demand_level === 'Mid' ? 'bg-warning' : 'bg-secondary'}">${r.demand_level || 'N/A'}</span></td>
                        <td class="date-col">${r.first_sale || 'N/A'}</td>
                        <td class="date-col">${r.last_sale || 'N/A'}</td>
                        <td><span class="badge ${status === 'Low Stock' ? 'bg-warning' : 'bg-success'}">${status}</span></td>
                </tr>
                `;
            }).join('');
        }


        // Helper function to generate batch IDs (sample implementation)
        function generateBatchIds(saleId, fruit, quantity) {
            if (!fruit || !quantity) return 'N/A';
            
            const fruitCode = fruit.includes('Cherry') ? 'CR' : fruit.includes('Apple') ? 'AP' : 'OT';
            const sizeCode = '120'; // Default size code
            const dateCode = new Date().toISOString().slice(2, 10).replace(/-/g, '');
            
            if (quantity <= 2) {
                return `${fruitCode}${sizeCode}${dateCode}${String(saleId).padStart(2, '0')}`;
            } else {
                const startId = `${fruitCode}${sizeCode}${dateCode}${String(saleId).padStart(2, '0')}`;
                const endId = `${fruitCode}${sizeCode}${dateCode}${String(saleId + quantity - 1).padStart(2, '0')}`;
                return `${startId} TO ${endId}`;
            }
        }

        // Function to update report header info based on active tab
        function updateReportHeaderInfo() {
            const activeTab = document.querySelector('.nav-link.active');
            const reportTypeSpan = document.getElementById('currentReportType');
            const reportPeriodSpan = document.getElementById('reportPeriod');
            
            if (activeTab) {
                const tabText = activeTab.textContent.trim();
                reportTypeSpan.textContent = tabText;
            }
            
            // Update period based on selected date range
            const dateRange = document.getElementById('dateRange')?.value || 'today';
            const periodMap = {
                'today': 'Today',
                'week': 'This Week',
                'month': 'This Month',
                'custom': 'Custom Range'
            };
            reportPeriodSpan.textContent = periodMap[dateRange] || 'All Time';
        }

        // Add event listeners to update header when tabs change
        // Function to show report details in modal
        function showReportDetails(type, index, data) {
            const modal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));
            const modalTitle = document.getElementById('reportDetailsModalLabel');
            const modalContent = document.getElementById('reportDetailsContent');
            
            let title = '';
            let content = '';
            
            switch(type) {
                case 'sales':
                    title = 'Sales Transaction Details';
                    content = generateSalesDetails(data, index);
                    break;
                case 'top_products':
                    title = 'Top Product Performance Details';
                    content = generateTopProductDetails(data, index);
                    break;
                case 'low_stock':
                    title = 'Low Stock Alert Details';
                    content = generateLowStockDetails(data);
                    break;
                case 'transactions':
                    title = 'Transaction Details';
                    content = generateTransactionDetails(data);
                    break;
                case 'inventory':
                    title = 'Inventory Report Details';
                    content = generateInventoryDetails(data);
                    break;
                default:
                    title = 'Report Details';
                    content = '<p>No details available.</p>';
            }
            
            modalTitle.textContent = title;
            modalContent.innerHTML = content;
            modal.show();
        }

        // Generate sales details content
        function generateSalesDetails(data, index) {
            const date = new Date(data.date || data.created_at || new Date()).toLocaleDateString('en-US', { 
                month: '2-digit', day: '2-digit', year: 'numeric' 
            });
            const revenue = Number(data.revenue || 0);
            
            return `
                <div class="detail-section">
                    <h6>Transaction Information</h6>
                    <div class="detail-row">
                        <span class="detail-label">Product Name:</span>
                        <span class="detail-value">${data.name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Transaction Date:</span>
                        <span class="detail-value">${date}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Reference Number:</span>
                        <span class="detail-value">SALE-${String(index + 1).padStart(3, '0')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Quantity Sold:</span>
                        <span class="detail-value">${data.boxes_sold ?? 0} boxes</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h6>Financial Summary</h6>
                    <div class="detail-row">
                        <span class="detail-label">Total Revenue:</span>
                        <span class="detail-value">â‚±${revenue.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Estimated Profit:</span>
                        <span class="detail-value">â‚±${(revenue * 0.3).toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Profit Margin:</span>
                        <span class="detail-value">30%</span>
                    </div>
                </div>
            `;
        }

        // Generate top product details content
        function generateTopProductDetails(data, index) {
            const date = new Date(data.date || data.created_at || new Date()).toLocaleDateString('en-US', { 
                month: '2-digit', day: '2-digit', year: 'numeric' 
            });
            const revenue = Number(data.revenue || 0);
            const performance = revenue > 1000 ? 'High' : revenue > 500 ? 'Medium' : 'Low';
            
            return `
                <div class="detail-section">
                    <h6>Product Performance</h6>
                    <div class="detail-row">
                        <span class="detail-label">Product Name:</span>
                        <span class="detail-value">${data.name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Product Size:</span>
                        <span class="detail-value">${data.size || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Performance Rank:</span>
                        <span class="detail-value">#${index + 1}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Boxes Sold:</span>
                        <span class="detail-value">${data.boxes_sold ?? 0}</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h6>Financial Performance</h6>
                    <div class="detail-row">
                        <span class="detail-label">Total Revenue:</span>
                        <span class="detail-value">â‚±${revenue.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Performance Level:</span>
                        <span class="detail-value"><span class="badge ${performance === 'High' ? 'bg-success' : performance === 'Medium' ? 'bg-warning' : 'bg-secondary'}">${performance}</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Report Date:</span>
                        <span class="detail-value">${date}</span>
                    </div>
                </div>
            `;
        }

        // Generate low stock details content
        function generateLowStockDetails(data) {
            const date = new Date(data.date || data.last_updated || new Date()).toLocaleDateString('en-US', { 
                month: '2-digit', day: '2-digit', year: 'numeric' 
            });
            const stock = Number(data.stock || 0);
            const status = stock === 0 ? 'Out of Stock' : stock <= 5 ? 'Critical' : 'Low';
            const action = stock === 0 ? 'Restock Immediately' : stock <= 5 ? 'Order Soon' : 'Monitor';
            
            return `
                <div class="detail-section">
                    <h6>Stock Alert Information</h6>
                    <div class="detail-row">
                        <span class="detail-label">Product Name:</span>
                        <span class="detail-value">${data.name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Product Size:</span>
                        <span class="detail-value">${data.size || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Current Stock:</span>
                        <span class="detail-value"><span class="badge bg-danger">${stock}</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Alert Date:</span>
                        <span class="detail-value">${date}</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h6>Action Required</h6>
                    <div class="detail-row">
                        <span class="detail-label">Stock Status:</span>
                        <span class="detail-value"><span class="badge ${status === 'Out of Stock' ? 'bg-danger' : status === 'Critical' ? 'bg-warning' : 'bg-info'}">${status}</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Recommended Action:</span>
                        <span class="detail-value"><span class="badge bg-primary">${action}</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Current Price:</span>
                        <span class="detail-value">â‚±${Number(data.price || 0).toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Priority Level:</span>
                        <span class="detail-value">${stock === 0 ? 'HIGH' : stock <= 5 ? 'MEDIUM' : 'LOW'}</span>
                    </div>
                </div>
            `;
        }

        // Generate transaction details content
        function generateTransactionDetails(data) {
            const subtotal = Number(data.subtotal || 0);
            const vat = Number(data.vat || 0);
            const total = Number(data.total || 0);
            const amountPaid = Number(data.amount_paid || 0);
            const change = amountPaid - total;
            
            return `
                <div class="detail-section">
                    <h6>Transaction Information</h6>
                    <div class="detail-row">
                        <span class="detail-label">Transaction ID:</span>
                        <span class="detail-value">${data.sale_id || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Transaction Number:</span>
                        <span class="detail-value">${data.transaction_number || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">OR Number:</span>
                        <span class="detail-value">${data.or_number || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value">${data.recorded_at || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Processed By:</span>
                        <span class="detail-value">${data.processed_by || 'admin'}</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h6>Customer Information</h6>
                    <div class="detail-row">
                        <span class="detail-label">Customer Name:</span>
                        <span class="detail-value">${data.customer_name || 'Walk-in'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Contact Number:</span>
                        <span class="detail-value">${data.contact_number || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Address:</span>
                        <span class="detail-value">${data.address || 'N/A'}</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h6>Product Details</h6>
                    <div class="detail-row">
                        <span class="detail-label">Fruits:</span>
                        <span class="detail-value">${data.fruits || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Sizes:</span>
                        <span class="detail-value">${data.sizes || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Items:</span>
                        <span class="detail-value">${data.items || data.fruit_count || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Boxes:</span>
                        <span class="detail-value">${data.boxes || data.total_boxes || 0}</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h6>Financial Summary</h6>
                    <div class="detail-row">
                        <span class="detail-label">Subtotal:</span>
                        <span class="detail-value">â‚±${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">VAT (12%):</span>
                        <span class="detail-value">â‚±${vat.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Amount:</span>
                        <span class="detail-value">â‚±${total.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Amount Paid:</span>
                        <span class="detail-value">â‚±${amountPaid.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Change:</span>
                        <span class="detail-value">â‚±${change.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value"><span class="badge status-${data.status}">${data.status}</span></span>
                    </div>
                </div>
            `;
        }

        // Generate inventory details content
        function generateInventoryDetails(data) {
            return `
                <div class="detail-section">
                    <h6>Inventory Information</h6>
                    <div class="detail-row">
                        <span class="detail-label">Product:</span>
                        <span class="detail-value">${data.name || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Current Stock:</span>
                        <span class="detail-value">${data.stock || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Price:</span>
                        <span class="detail-value">â‚±${Number(data.price || 0).toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">${data.status || 'N/A'}</span>
                    </div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Update header info on page load
            updateReportHeaderInfo();
            
            // Add event listeners to tab buttons
            const tabButtons = document.querySelectorAll('.nav-link[data-bs-toggle="tab"]');
            tabButtons.forEach(button => {
                button.addEventListener('shown.bs.tab', function() {
                    updateReportHeaderInfo();
                });
            });
            
            // Update header when date range changes
            const dateRangeSelect = document.getElementById('dateRange');
            if (dateRangeSelect) {
                dateRangeSelect.addEventListener('change', updateReportHeaderInfo);
            }
        });

        function createRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Generate sample daily data for the last 7 days
            const labels = [];
            const revenueData = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                revenueData.push(Math.random() * 5000 + 1000); // Sample data
            }

            if (revenueChart) revenueChart.destroy();
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Revenue',
                        data: revenueData,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(99, 102, 241)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚±' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createTopProductsChart(data) {
            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            const topProducts = data.top_fruits || [];
            const labels = topProducts.map(p => p.name);
            const revenueData = topProducts.map(p => p.revenue);

            if (topProductsChart) topProductsChart.destroy();
            
            topProductsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: revenueData,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)',
                            'rgb(99, 102, 241)',
                            'rgb(139, 92, 246)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚±' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createSalesDistributionChart(data) {
            const ctx = document.getElementById('salesDistributionChart').getContext('2d');
            
            const fruitSummary = data.fruit_summary || [];
            const labels = fruitSummary.map(f => f.name);
            const revenueData = fruitSummary.map(f => f.revenue);

            if (salesDistributionChart) salesDistributionChart.destroy();
            
            salesDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: revenueData,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(14, 165, 233, 0.8)'
                        ],
                        borderColor: '#fff',
                        borderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createInventoryHealthChart(data) {
            const ctx = document.getElementById('inventoryHealthChart').getContext('2d');
            
            const lowStock = data.low_stock || [];
            const healthyStock = data.fruit_summary || [];
            
            const healthyCount = healthyStock.length;
            const lowCount = lowStock.length;
            const totalCount = healthyCount + lowCount;

            if (inventoryHealthChart) inventoryHealthChart.destroy();
            
            inventoryHealthChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Healthy Stock', 'Low Stock'],
                    datasets: [{
                        data: [healthyCount, lowCount],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('generateReport').addEventListener('click', loadReports);
        dateRangeSelect?.addEventListener('change', ()=>{
            const sel = (dateRangeSelect.value||'today').toLowerCase();
            // daily/week/month set dates automatically; custom launches modal
            const todayIso = today;
            if(sel==='today'){
                loadReports(); updateRangeLabels();
            } else if(sel==='week'){
                loadReports(); updateRangeLabels();
            } else if(sel==='month'){
                loadReports(); updateRangeLabels();
            } else if(sel==='custom'){
                // open modal and wait for apply
                const modal = new bootstrap.Modal(document.getElementById('customRangeModal'));
                document.getElementById('customStart').value = customStart || todayIso;
                document.getElementById('customEnd').value = customEnd || (customStart || todayIso);
                modal.show();
            }
        });

        document.addEventListener('click', (e)=>{
            if(e.target && e.target.id==='applyCustomRange'){
                const s = document.getElementById('customStart').value;
                const eDate = document.getElementById('customEnd').value;
                if(!s || !eDate) return;
                const sNorm = s <= eDate ? s : eDate;
                const eNorm = eDate >= s ? eDate : s;
                customStart = sNorm; customEnd = eNorm;
                startEl.value = customStart; endEl.value = customEnd;
                updateRangeLabels();
                loadReports();
                const m = bootstrap.Modal.getInstance(document.getElementById('customRangeModal')); if(m) m.hide();
            }
        });


        // Helper function to extract all tab data
        function getAllTabsData() {
            const tabsData = {};

            // Extract sales summary data
            const summaryBody = document.getElementById('summaryBody');
            if (summaryBody) {
                const rows = Array.from(summaryBody.querySelectorAll('tr')).filter(row => !row.querySelector('.text-center.text-muted'));
                tabsData.sales = {
                    title: 'Sales Summary',
                    headers: ['Date', 'Product', 'Particulars', 'Reference', 'Quantity', 'Revenue', 'Profit', 'Balance'],
                    data: rows.map(row => {
                        const cells = row.querySelectorAll('td');
                        return Array.from(cells).map(cell => cell.textContent.trim());
                    })
                };
            }

            // Extract top products data
            const topBody = document.getElementById('topBody');
            if (topBody) {
                const rows = Array.from(topBody.querySelectorAll('tr')).filter(row => !row.querySelector('.text-center.text-muted'));
                tabsData.products = {
                    title: 'Top Products',
                    headers: ['Rank', 'Product', 'Size', 'Particulars', 'Boxes Sold', 'Revenue', 'Performance'],
                    data: rows.map(row => {
                        const cells = row.querySelectorAll('td');
                        return Array.from(cells).map(cell => cell.textContent.trim());
                    })
                };
            }

            // Extract low stock data
            const lowBody = document.getElementById('lowBody');
            if (lowBody) {
                const rows = Array.from(lowBody.querySelectorAll('tr')).filter(row => !row.querySelector('.text-center.text-muted'));
                tabsData.inventory = {
                    title: 'Low Stock Items',
                    headers: ['Date', 'Product', 'Size', 'Particulars', 'Current Stock', 'Price', 'Status', 'Action Required'],
                    data: rows.map(row => {
                        const cells = row.querySelectorAll('td');
                        return Array.from(cells).map(cell => cell.textContent.trim());
                    })
                };
            }

            // Extract transactions data
            const txBody = document.getElementById('txBody');
            if (txBody) {
                const rows = Array.from(txBody.querySelectorAll('tr')).filter(row => !row.querySelector('.text-center.text-muted'));
                tabsData.transactions = {
                    title: 'Transactions',
                    headers: ['Sale ID', 'Transaction No.', 'OR No.', 'Date & Time', 'Customer', 'Contact', 'Address', 'Processed By', 'Fruits', 'Size', 'Items', 'Boxes', 'Subtotal', 'VAT (12%)', 'Total', 'Amount Paid', 'Change', 'Status'],
                    data: rows.map(row => {
                        const cells = row.querySelectorAll('td');
                        return Array.from(cells).map(cell => cell.textContent.trim());
                    })
                };
            }

            // Extract product performance data
            const summaryReportsBody = document.getElementById('summaryReportsBody');
            if (summaryReportsBody) {
                const rows = Array.from(summaryReportsBody.querySelectorAll('tr')).filter(row => !row.querySelector('.text-center.text-muted'));
                tabsData.reports = {
                    title: 'Product Performance',
                    headers: ['Date', 'Product', 'Particulars', 'Period', 'Opening Qty', 'Added Qty', 'Sold Qty', 'Closing Qty', 'Revenue', 'COGS', 'Gross Profit', 'Margin %', 'Performance'],
                    data: rows.map(row => {
                        const cells = row.querySelectorAll('td');
                        return Array.from(cells).map(cell => cell.textContent.trim());
                    })
                };
            }

            // Extract inventory reports data
            const inventoryReportsBody = document.getElementById('inventoryReportsBody');
            if (inventoryReportsBody) {
                const rows = Array.from(inventoryReportsBody.querySelectorAll('tr')).filter(row => !row.querySelector('.text-center.text-muted'));
                tabsData.inventoryReports = {
                    title: 'Inventory Reports',
                    headers: ['Date', 'Product', 'Particulars', 'Last Price', 'Suggested Price', 'Price Action', 'Demand Level', 'First Sale', 'Last Sale', 'Status'],
                    data: rows.map(row => {
                        const cells = row.querySelectorAll('td');
                        return Array.from(cells).map(cell => cell.textContent.trim());
                    })
                };
            }

            return tabsData;
        }

        async function exportCompletePDF() {
            try {
                // Show loading state
                const exportBtn = document.querySelector('button[onclick="exportCompletePDF()"]');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating PDF...';
                exportBtn.disabled = true;

            // Get current date range for the report title
            const dateRange = document.getElementById('dateRange')?.value || 'Today';
            const currentDate = new Date().toLocaleDateString();

            // Get current statistics values
            const totalRevenue = document.getElementById('statTotalRevenue')?.textContent || 'â‚±0.00';
            const totalTransactions = document.getElementById('statTransactions')?.textContent || '0';
            const itemsSold = document.getElementById('statItemsSold')?.textContent || '0';
            const avgOrder = document.getElementById('statAvgOrder')?.textContent || 'â‚±0.00';

                // Get all tab data for comprehensive report
                const tabsData = getAllTabsData();

                // Create PDF content container
                const pdfContainer = document.createElement('div');
                pdfContainer.style.cssText = `
                    font-family: Arial, sans-serif;
                    margin: 20px;
                    line-height: 1.6;
                    font-size: 12px;
                    color: #333;
                    width: 210mm;
                    min-height: 297mm;
                    padding: 15mm;
                    box-sizing: border-box;
                `;

                // Add header
                const header = document.createElement('div');
                header.style.cssText = `
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 20px;
                `;
                header.innerHTML = `
                    <h1 style="margin: 0; font-size: 24px; color: #333;">StockWise - Complete Sales Report</h1>
                    <p style="margin: 10px 0 0 0; font-size: 14px;">
                        <strong>Date Range:</strong> ${dateRange} |
                        <strong>Generated:</strong> ${currentDate}
                    </p>
                `;

                // Add statistics section
                const statsSection = document.createElement('div');
                statsSection.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 20px;
                    margin-bottom: 30px;
                `;

                const stats = [
                    { label: 'Total Revenue', value: totalRevenue },
                    { label: 'Total Transactions', value: totalTransactions },
                    { label: 'Items Sold', value: itemsSold },
                    { label: 'Average Sale', value: avgOrder }
                ];

                stats.forEach(stat => {
                    const statCard = document.createElement('div');
                    statCard.style.cssText = `
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        text-align: center;
                        border: 1px solid #dee2e6;
                    `;
                    statCard.innerHTML = `
                        <div style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 5px;">${stat.value}</div>
                        <div style="color: #666; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">${stat.label}</div>
                    `;
                    statsSection.appendChild(statCard);
                });

                pdfContainer.appendChild(header);
                pdfContainer.appendChild(statsSection);

                // Add all tab data to the PDF
                Object.entries(tabsData).forEach(([tabKey, tabData]) => {
                    if (tabData.data.length > 0) {
                        const contentSection = document.createElement('div');
                        contentSection.style.cssText = 'margin-bottom: 30px; page-break-inside: avoid;';

                        const title = document.createElement('h3');
                        title.style.cssText = `
                            color: #333;
                            border-bottom: 1px solid #ddd;
                            padding-bottom: 8px;
                            margin-top: 25px;
                            margin-bottom: 15px;
                            font-size: 16px;
                        `;
                        title.textContent = tabData.title;

                        contentSection.appendChild(title);

                        // Create table for this tab's data
                        const table = document.createElement('table');
                        table.style.cssText = `
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                            font-size: 10px;
                        `;

                        // Create table header
                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');
                        tabData.headers.forEach(headerText => {
                            const th = document.createElement('th');
                            th.style.cssText = `
                                border: 1px solid #ddd;
                                padding: 8px;
                                text-align: left;
                                background-color: #f8f9fa;
                                font-weight: bold;
                                color: #333;
                                font-size: 9px;
                            `;
                            th.textContent = headerText;
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
                        table.appendChild(thead);

                        // Create table body
                        const tbody = document.createElement('tbody');
                        tabData.data.forEach(rowData => {
                            const row = document.createElement('tr');
                            rowData.forEach(cellData => {
                                const td = document.createElement('td');
                                td.style.cssText = `
                                    border: 1px solid #ddd;
                                    padding: 6px;
                                    text-align: left;
                                    font-size: 9px;
                                `;
                                td.textContent = cellData;
                                row.appendChild(td);
                            });
                            tbody.appendChild(row);
                        });
                        table.appendChild(tbody);

                        contentSection.appendChild(table);
                        pdfContainer.appendChild(contentSection);
                    }
                });

                // PDF generation options
                const opt = {
                    margin: 15,
                    filename: `stockwise_complete_report_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Generate and download PDF
                await html2pdf().set(opt).from(pdfContainer).save();

                // Restore button state
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;

            } catch (error) {
                console.error('PDF export error:', error);
                alert('Error generating PDF. Please try again.');
                // Restore button state
                const exportBtn = document.querySelector('button[onclick="exportCompletePDF()"]');
                if (exportBtn) {
                    exportBtn.innerHTML = '<i class="bi bi-file-pdf"></i> Export PDF';
                    exportBtn.disabled = false;
                }
            }
        }

        // Print Report functionality - opens print dialog with report content
        document.getElementById('printReport').addEventListener('click', function() {
            // Ensure reports are loaded before printing
            if (typeof loadReports === 'function') {
                loadReports().then(() => {
                    setTimeout(printReportContent, 1000); // Wait for data to load
                }).catch(() => {
                    printReportContent(); // Print anyway if load fails
                });
            } else {
                printReportContent();
            }
        });

        function printReportContent() {
            // Create a new window for printing
            const printWindow = window.open('', '_blank', 'width=1200,height=800');

            // Get current date range for the report title
            const dateRange = document.getElementById('dateRange')?.value || 'Today';
            const currentDate = new Date().toLocaleDateString();

            // Get current statistics values
            const totalRevenue = document.getElementById('statTotalRevenue')?.textContent || 'â‚±0.00';
            const totalTransactions = document.getElementById('statTransactions')?.textContent || '0';
            const itemsSold = document.getElementById('statItemsSold')?.textContent || '0';
            const avgOrder = document.getElementById('statAvgOrder')?.textContent || 'â‚±0.00';

            // Get all tab content for the report
            const salesTab = document.getElementById('sales');
            const productsTab = document.getElementById('products');
            const inventoryTab = document.getElementById('inventory');
            const transactionsTab = document.getElementById('transactions');
            const reportsTab = document.getElementById('reports');
            const inventoryReportsTab = document.getElementById('inventory-reports');

            // Build the report content
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>StockWise - ${tabName} Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 15px; line-height: 1.6; font-size: 11px; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
                        .stat-card { background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #dee2e6; }
                        .stat-value { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 3px; }
                        .stat-label { color: #666; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
                        .section { margin-bottom: 25px; page-break-inside: avoid; }
                        h3 { color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 20px; font-size: 14px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; page-break-inside: auto; font-size: 10px; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                        th { background-color: #f8f9fa; font-weight: bold; color: #333; font-size: 9px; }
                        .text-center { text-align: center; }
                        .text-muted { color: #666; }
                        .badge { display: inline-block; padding: 2px 4px; border-radius: 3px; font-size: 8px; font-weight: bold; }
                        .bg-primary { background-color: #007bff; color: white; }
                        .bg-secondary { background-color: #6c757d; color: white; }
                        .bg-success { background-color: #28a745; color: white; }
                        .bg-danger { background-color: #dc3545; color: white; }
                        .bg-warning { background-color: #ffc107; color: #212529; }
                        @media print {
                            body { margin: 8mm; font-size: 10px; }
                            .no-print { display: none; }
                            .header { margin-bottom: 10mm; }
                            .stats-grid { margin-bottom: 10mm; }
                            .section { margin-bottom: 15mm; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>StockWise - ${tabName} Report</h1>
                        <p><strong>Date Range:</strong> ${dateRange} | <strong>Generated:</strong> ${currentDate}</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalRevenue}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalTransactions}</div>
                            <div class="stat-label">Total Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${itemsSold}</div>
                            <div class="stat-label">Items Sold</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${avgOrder}</div>
                            <div class="stat-label">Average Sale</div>
                        </div>
                    </div>

                    ${salesTab ? `
                    <div class="section">
                        <h3>Sales Summary</h3>
                        ${salesTab.innerHTML}
                    </div>` : ''}

                    ${productsTab ? `
                    <div class="section">
                        <h3>Top Products</h3>
                        ${productsTab.innerHTML}
                    </div>` : ''}

                    ${inventoryTab ? `
                    <div class="section">
                        <h3>Low Stock Items</h3>
                        ${inventoryTab.innerHTML}
                    </div>` : ''}

                    ${transactionsTab ? `
                    <div class="section">
                        <h3>Recent Transactions</h3>
                        ${transactionsTab.innerHTML}
                    </div>` : ''}

                    ${reportsTab ? `
                    <div class="section">
                        <h3>Product Performance</h3>
                        ${reportsTab.innerHTML}
                    </div>` : ''}

                    ${inventoryReportsTab ? `
                    <div class="section">
                        <h3>Inventory Reports</h3>
                        ${inventoryReportsTab.innerHTML}
                    </div>` : ''}
                </body>
                </html>
            `;

            printWindow.document.write(reportHTML);
            printWindow.document.close();

            // Wait for content to load then print
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            }, 1000);
        }



        // Initial load - reports load automatically when page loads
        console.log('Loading initial reports...');
        loadReports().then(() => {
            console.log('Initial reports loaded successfully');
        }).catch(error => {
            console.error('Error loading initial reports:', error);
        });

        // Mobile sidebar toggle functionality
        const sidebar = document.querySelector('.sidebar');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');

        function toggleMobileMenu() {
            if (sidebar) {
                sidebar.classList.toggle('active');
                console.log('Mobile sidebar toggled:', sidebar.classList.contains('active'));
                // Prevent body scroll when sidebar is open on mobile
                if (sidebar.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }

        // Handle mobile menu toggle click
        if (mobileMenuToggle) {
            console.log('Mobile menu button found in reports_full');
            mobileMenuToggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Mobile menu button clicked in reports_full');
                toggleMobileMenu();
            });
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768 && sidebar && sidebar.classList.contains('active')) {
                if (!sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                    document.body.style.overflow = '';
                    console.log('Mobile sidebar closed from outside click');
                }
            }
        });

        // Close sidebar when clicking on navigation links
        if (sidebar) {
            const navLinks = sidebar.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                        document.body.style.overflow = '';
                        console.log('Mobile sidebar closed from nav link click');
                    }
                });
            });
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768 && sidebar) {
                sidebar.classList.remove('active');
                document.body.style.overflow = '';
                console.log('Mobile sidebar closed on resize');
            }
        });

        // Handle escape key to close sidebar
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                document.body.style.overflow = '';
                console.log('Mobile sidebar closed from escape key');
            }
        });

        // ============================================================================
        // INVENTORY REPORTS FUNCTIONALITY
        // ============================================================================
        
        // Global variables for inventory report modals
        let currentInventoryReportData = null;
        let currentInventoryReportType = null;

        // View inventory report in modal
        function viewInventoryReport(reportType) {
            showInventoryLoadingState();
            currentInventoryReportType = reportType;
            
            // Fetch report data
            const endpoints = {
                'stock': '/api/inventory/reports/stock/',
                'movement': '/api/inventory/reports/movement/',
                'batches': '/api/inventory/reports/batches/',
                'turnover': '/api/inventory/reports/turnover/',
                'suppliers': '/api/inventory/reports/suppliers/'
            };
            
            if (!endpoints[reportType]) {
                hideInventoryLoadingState();
                alert('Invalid report type');
                return;
            }
            
            fetch(endpoints[reportType])
                .then(response => response.json())
                .then(data => {
                    hideInventoryLoadingState();
                    if (data.success) {
                        currentInventoryReportData = data;
                        displayInventoryReportModal(reportType, data);
                    } else {
                        alert('Error loading report: ' + data.message);
                    }
                })
                .catch(error => {
                    hideInventoryLoadingState();
                    console.error('Error fetching inventory report:', error);
                    alert('Error loading report. Please try again.');
                });
        }

        // Download PDF inventory report
        function downloadInventoryPDF(reportType) {
            showInventoryLoadingState();
            
            const url = `/api/inventory/reports/pdf/?type=${reportType}`;
            
            // Create a temporary link to download the PDF
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory_report_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            hideInventoryLoadingState();
        }

        // Display inventory report in modal
        function displayInventoryReportModal(reportType, data) {
            const reportTitles = {
                'stock': 'Stock Snapshot Report',
                'movement': 'Stock Movement Report',
                'batches': 'Active Batches Report',
                'turnover': 'Inventory Turnover Report',
                'suppliers': 'Supplier Analysis Report'
            };
            
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="inventoryReportModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${reportTitles[reportType]}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="report-content">
                                    ${generateInventoryReportHTML(reportType, data)}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-danger" onclick="downloadInventoryPDF('${reportType}')">
                                    <i class="bi bi-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#inventoryReportModal').remove();
            
            // Add modal to body and show
            $('body').append(modalHtml);
            $('#inventoryReportModal').modal('show');
        }

        // Generate HTML for different inventory report types
        function generateInventoryReportHTML(reportType, data) {
            switch (reportType) {
                case 'stock':
                    return generateInventoryStockReportHTML(data);
                case 'movement':
                    return generateInventoryMovementReportHTML(data);
                case 'batches':
                    return generateInventoryBatchesReportHTML(data);
                case 'turnover':
                    return generateInventoryTurnoverReportHTML(data);
                case 'suppliers':
                    return generateInventorySuppliersReportHTML(data);
                default:
                    return '<p>Report type not supported</p>';
            }
        }

        // Generate Stock Report HTML
        function generateInventoryStockReportHTML(data) {
            const summary = data.summary;
            let html = `
                <div class="inventory-report-summary mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="inventory-summary-card">
                                <h6>Total Products</h6>
                                <div class="inventory-summary-value">${summary.total_products}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="inventory-summary-card">
                                <h6>Total Stock</h6>
                                <div class="inventory-summary-value">${summary.total_stock_boxes} boxes</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="inventory-summary-card">
                                <h6>Stock Value</h6>
                                <div class="inventory-summary-value">â‚±${summary.total_value_price.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="inventory-summary-card">
                                <h6>Low Stock Items</h6>
                                <div class="inventory-summary-value text-warning">${summary.low_stock_count}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Size</th>
                                <th>Stock</th>
                                <th>Unit Price</th>
                                <th>Stock Value</th>
                                <th>Margin %</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.data.forEach((item, index) => {
                const statusClass = item.low_stock_flag ? 'text-warning' : 'text-success';
                const statusIcon = item.low_stock_flag ? 'âš ï¸' : 'âœ…';
                html += `
                    <tr class="clickable" onclick="showReportDetails('inventory', ${index}, ${JSON.stringify(item).replace(/"/g, '&quot;')})">
                        <td>${item.name}</td>
                        <td>${item.size || 'N/A'}</td>
                        <td>${item.current_stock}</td>
                        <td>â‚±${item.unit_price.toFixed(2)}</td>
                        <td>â‚±${item.stock_value_price.toLocaleString()}</td>
                        <td>${item.margin_pct.toFixed(1)}%</td>
                        <td class="${statusClass}">${statusIcon}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        // Generate Movement Report HTML
        function generateInventoryMovementReportHTML(data) {
            const summary = data.summary;
            let html = `
                <div class="inventory-report-summary mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="inventory-summary-card">
                                <h6>Total Movements</h6>
                                <div class="inventory-summary-value">${summary.total_movements}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="inventory-summary-card">
                                <h6>Net Movement</h6>
                                <div class="inventory-summary-value">${summary.net_movement} boxes</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="inventory-summary-card">
                                <h6>Period</h6>
                                <div class="inventory-summary-value small">${summary.date_range}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Product</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Batch/Reference</th>
                                <th>Supplier</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.data.forEach((item, index) => {
                const typeClass = item.type === 'Addition' ? 'text-success' : 'text-danger';
                const quantityDisplay = item.type === 'Addition' ? `+${item.quantity}` : Math.abs(item.quantity);
                html += `
                    <tr class="clickable" onclick="showReportDetails('movement', ${index}, ${JSON.stringify(item).replace(/"/g, '&quot;')})">
                        <td>${item.date}</td>
                        <td>${item.time}</td>
                        <td>${item.product_name}</td>
                        <td class="${typeClass}">${item.type}</td>
                        <td class="${typeClass}">${quantityDisplay}</td>
                        <td><code>${item.batch_id}</code></td>
                        <td>${item.supplier}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        // Generate other inventory report HTML functions (simplified for brevity)
        function generateInventoryBatchesReportHTML(data) {
            return generateInventoryGenericTableReport(data, [
                { key: 'batch_id', title: 'Batch ID', format: 'code' },
                { key: 'product_name', title: 'Product' },
                { key: 'date_added', title: 'Date Added' },
                { key: 'remaining_quantity', title: 'Remaining' },
                { key: 'age_days', title: 'Age (Days)' },
                { key: 'age_category', title: 'Category', format: 'badge' }
            ]);
        }

        function generateInventoryTurnoverReportHTML(data) {
            return generateInventoryGenericTableReport(data, [
                { key: 'product_name', title: 'Product' },
                { key: 'current_stock', title: 'Stock' },
                { key: 'sales_qty_30d', title: '30d Sales' },
                { key: 'daily_sales_rate', title: 'Daily Rate' },
                { key: 'days_of_cover', title: 'Days Cover' },
                { key: 'velocity_category', title: 'Velocity', format: 'badge' }
            ]);
        }

        function generateInventorySuppliersReportHTML(data) {
            return generateInventoryGenericTableReport(data, [
                { key: 'supplier_name', title: 'Supplier' },
                { key: 'total_deliveries', title: 'Deliveries' },
                { key: 'total_boxes', title: 'Total Boxes' },
                { key: 'unique_products', title: 'Products' },
                { key: 'avg_delivery_size', title: 'Avg Size' },
                { key: 'days_since_last_delivery', title: 'Days Since Last' }
            ]);
        }

        // Generic table report generator for inventory
        function generateInventoryGenericTableReport(data, columns) {
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
            
            columns.forEach(col => {
                html += `<th>${col.title}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            data.data.forEach(item => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = item[col.key];
                    if (col.format === 'code') {
                        value = `<code>${value}</code>`;
                    } else if (col.format === 'badge') {
                        const badgeClass = getInventoryBadgeClass(value);
                        value = `<span class="badge ${badgeClass}">${value}</span>`;
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        // Helper function for inventory badge classes
        function getInventoryBadgeClass(value) {
            const badgeMap = {
                'Fresh': 'bg-success',
                'Aging': 'bg-warning',
                'Old': 'bg-danger',
                'Fast': 'bg-success',
                'Medium': 'bg-warning',
                'Slow': 'bg-danger',
                'Normal': 'bg-success',
                'Low Stock': 'bg-warning',
                'Overstocked': 'bg-info',
                'Out of Stock': 'bg-danger'
            };
            return badgeMap[value] || 'bg-secondary';
        }

        // Loading state functions for inventory reports
        function showInventoryLoadingState() {
            // Create loading overlay if it doesn't exist
            if (!$('#inventoryLoadingOverlay').length) {
                $('body').append(`
                    <div id="inventoryLoadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `);
            }
            $('#inventoryLoadingOverlay').show();
        }

        function hideInventoryLoadingState() {
            $('#inventoryLoadingOverlay').hide();
        }

        // Add custom CSS for inventory report modals
        $('<style>').text(`
            .inventory-report-summary {
                background: #f8f9fa;
                padding: 1.5rem;
                border-radius: 12px;
                margin-bottom: 1.5rem;
            }
            .inventory-summary-card {
                text-align: center;
                padding: 1.25rem;
                background: white;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 1rem;
            }
            .inventory-summary-card h6 {
                margin-bottom: 0.75rem;
                color: #6c757d;
                font-size: 0.85rem;
                text-transform: uppercase;
                font-weight: 600;
            }
            .inventory-summary-value {
                font-size: 1.75rem;
                font-weight: bold;
                color: #495057;
            }
            #inventoryReportModal .modal-dialog {
                max-width: 95%;
            }
            #inventoryReportModal .table {
                font-size: 0.9rem;
            }
            #inventoryReportModal .modal-header {
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border-radius: 0.5rem 0.5rem 0 0;
            }
            #inventoryReportModal .btn-close {
                filter: invert(1);
            }
    <!-- Report Details Modal -->
    <div class="modal fade report-modal" id="reportDetailsModal" tabindex="-1" aria-labelledby="reportDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportDetailsModalLabel">Report Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reportDetailsContent">
                    <!-- Content will be populated dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $('<style>')
            .text(`
            #inventoryReportModal .btn-close {
                filter: invert(1);
            }
        `).appendTo('head');
    </script>
</body>
</html> 