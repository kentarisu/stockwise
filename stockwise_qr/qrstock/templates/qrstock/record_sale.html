<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="StockWise">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>StockWise - Record Sale via QR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        .page-container { 
            min-height: 100vh; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            padding:2rem 1rem; 
        }
        .card-modern { 
            width:100%; 
            max-width: 800px; 
            background:#fff; 
            border-radius:16px; 
            border:1px solid #e5e7eb; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); 
            overflow:hidden; 
        }
        .card-header-modern { 
            background:#f3f4f6; 
            padding:1rem 1.25rem; 
            display:flex; 
            align-items:center; 
            justify-content:space-between; 
        }
        .product-highlight {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .product-highlight h6 {
            color: #1e40af;
            margin-bottom: 0.5rem;
        }
        .product-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .product-info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .product-info-label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .product-info-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            margin-top: 0.25rem;
        }
        .sale-steps{display:flex;justify-content:center;align-items:center;gap:2rem;margin-bottom:1rem;padding:1rem;background:#f8f9fa;border-radius:12px}
        .sale-step{display:flex;flex-direction:column;align-items:center;text-align:center;min-width:80px}
        .sale-step i{width:40px;height:40px;border-radius:50%;background:#e9ecef;color:#6c757d;display:flex;align-items:center;justify-content:center;margin-bottom:.5rem;font-size:1.2rem}
        .sale-step.active i{background:#6366f1;color:#fff}
        .sale-step-label{font-size:.875rem;font-weight:500;color:#6c757d}
        .sale-step.active .sale-step-label{color:#6366f1;font-weight:600}
        .item-row{background:#f8f9fa;border:1px solid #e9ecef!important}
        .stock-info{font-size:.75rem}
        .payment-summary-table{width:100%;max-width:600px;margin:0 auto 1rem;border-radius:12px;overflow:hidden;background:#fff}
    </style>
</head>
<body>
<div class="page-container">
  <div class="card-modern">
    <div class="card-header-modern">
      <h5 class="m-0"><i class="bi bi-cart-plus me-2"></i>Record Sale via QR</h5>
      <div class="d-flex align-items-center">
        <span class="badge bg-success me-2">
          <i class="bi bi-qr-code me-1"></i>QR Scanned
        </span>
        {% if app_username %}
        <span class="badge bg-primary">
          <i class="bi bi-person me-1"></i>{{ app_username }} ({{ app_role }})
        </span>
        {% endif %}
      </div>
    </div>
    <div class="p-3">
      <div id="buyFormAlert"></div>

      <!-- Product Highlight -->
      <div class="product-highlight">
        <h6><i class="bi bi-box-seam me-2"></i>Selected Product from QR Code</h6>
        <div class="product-details">
          <div class="product-info-item">
            <div class="product-info-label">Product</div>
            <div class="product-info-value">{{ product.name }}</div>
          </div>
          {% if product.size %}
          <div class="product-info-item">
            <div class="product-info-label">Size</div>
            <div class="product-info-value">{{ product.size }}</div>
          </div>
          {% endif %}
          <div class="product-info-item">
            <div class="product-info-label">Stock Available</div>
            <div class="product-info-value">{{ product.stock }} boxes</div>
          </div>
        <div class="product-info-item">
          <div class="product-info-label">Unit Price</div>
          <div class="product-info-value">₱{{ product.price|floatformat:2 }}</div>
        </div>
        <div class="product-info-item">
          <div class="product-info-label">Available Stock (FIFO Order)</div>
          <div class="product-info-value">
            {% if stock_batches %}
              <div class="stock-preview">
                <div class="mb-2">
                  <strong>{{ stock_batches|length }} boxes available</strong>
                </div>
                <div class="fifo-batches" style="max-height: 120px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                  {% for batch in stock_batches|slice:":10" %}
                    <div class="batch-item d-flex justify-content-between py-1 {% if forloop.first %}text-success fw-bold{% endif %}">
                      <span>{{ batch.batch_id }}</span>
                      <span class="text-muted">{% if forloop.first %}← Next to sell{% endif %}</span>
                    </div>
                  {% endfor %}
                  {% if stock_batches|length > 10 %}
                    <div class="text-muted small">... and {{ stock_batches|length|add:"-10" }} more</div>
                  {% endif %}
                </div>
                <small class="text-muted">System will automatically use oldest batches first</small>
              </div>
            {% else %}
              <div class="text-warning">⚠️ No stock available</div>
            {% endif %}
          </div>
        </div>
        <div class="product-info-item">
          <div class="product-info-label">Batches to Sell</div>
          <div class="product-info-value">
            <div id="batchesToSell" class="text-muted" style="font-family: 'Courier New', monospace;">
              Enter quantity to see which batches will be sold
            </div>
          </div>
        </div>
        </div>
      </div>

      <div class="sale-steps" id="saleStepsIndicator">
        <div class="sale-step active" id="stepIndicator1"><i class="bi bi-basket"></i><div class="sale-step-label">Sale Details</div></div>
        <div class="sale-step" id="stepIndicator2"><i class="bi bi-credit-card"></i><div class="sale-step-label">Payment</div></div>
        <div class="sale-step" id="stepIndicator3"><i class="bi bi-receipt"></i><div class="sale-step-label">Receipt</div></div>
      </div>

      <div id="saleStep1">
        <form id="qrSaleForm" novalidate>
          <div class="customer-info-section mb-4 p-3 border rounded bg-light">
            <h6 class="mb-3 text-primary"><i class="bi bi-person-circle"></i> Customer Information</h6>
            <div class="row">
              <div class="col-md-6">
                <label for="customerName" class="form-label">Customer Name / Company</label>
                <input type="text" class="form-control" id="customerName" name="customer_name" placeholder="Enter customer name or company">
              </div>
              <div class="col-md-6">
                <label for="customerContact" class="form-label">Contact Number</label>
                <input type="tel" class="form-control" id="customerContact" name="customer_contact" placeholder="Enter contact number">
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <label for="customerAddress" class="form-label">Address</label>
                <textarea class="form-control" id="customerAddress" name="customer_address" rows="2" placeholder="Enter customer address"></textarea>
              </div>
            </div>
          </div>

          <div class="items-section">
            <h6 class="mb-3 text-primary"><i class="bi bi-basket"></i> Sale Details</h6>
            <div class="item-row mb-3 p-3 border rounded">
              <div class="row">
                <div class="col-md-8">
                  <label class="form-label">Product (from QR scan)</label>
                  <div class="form-control-plaintext bg-light p-2 rounded">
                    <strong>{{ product.name }}</strong>
                    {% if product.size %} ({{ product.size }}){% endif %}
                    <br><small class="text-muted">Stock: {{ product.stock }} boxes available</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Quantity (Boxes)</label>
                  <input type="number" class="form-control" id="saleQuantity" min="1" max="{{ product.stock }}" required>
                </div>
              </div>
            </div>
            
            <div class="mt-3">
              <strong>Total Price (VAT Inclusive): ₱<span id="liveSaleTotalWithVATText">0.00</span></strong>
            </div>
            
            <div class="mt-3 d-flex align-items-center gap-2">
              <label class="form-label mb-0">Date Recorded:</label>
              <input type="text" class="form-control form-control-sm w-auto" id="saleDate" readonly>
            </div>
            <small class="form-text text-muted">Set to today and cannot be changed.</small>
          </div>
        </form>
      </div>

      <div id="saleStep2" style="display:none;">
        <div class="payment-summary-table mb-3">
          <table class="table table-bordered mb-0">
            <thead><tr><th>Description</th><th class="text-center">Boxes</th><th class="text-center">Price</th><th class="text-end">Amount</th></tr></thead>
            <tbody id="paymentTableItems"></tbody>
          </table>
        </div>
        <div class="payment-summary-table">
          <table class="table table-bordered mb-0">
            <tbody>
              <tr><th>Subtotal</th><td class="text-end">₱<span id="paymentSubtotal">0.00</span></td></tr>
              <tr><th>VAT (12%)</th><td class="text-end">₱<span id="paymentVAT">0.00</span></td></tr>
              <tr class="table-light"><th>Total Amount with VAT</th><td class="text-end">₱<span id="paymentTotalWithVAT">0.00</span></td></tr>
              <tr><th>Amount Tendered</th><td><input type="number" class="form-control" id="paymentTendered" min="0" step="0.01" required placeholder="Amount received"></td></tr>
              <tr><th>Change</th><td class="text-end">₱<span id="paymentChange">0.00</span></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="saleStep3" style="display:none;">
        <div id="saleSuccessMessage" class="alert alert-success w-100 mb-3" style="display:none;">
          <i class="bi bi-check-circle-fill text-success me-2"></i>Sale recorded successfully!
        </div>
        <div class="receipt-container border p-3" style="max-width:300px;margin:0 auto;">
          <div class="receipt-header text-center mb-2">
            <div class="company-name fw-bold">FruitMaster Marketing</div>
            <div class="company-details small">Mabini Street - Libertad, Bacolod City, Negros Occidental</div>
            <div class="company-details small">TIN: </div>
            <div class="company-details small">Tel: 434-7680, 213-5681, 213-5682</div>
          </div>
          <div class="receipt-title text-center fw-bold">SALES RECEIPT</div>
          <hr class="receipt-divider"/>
          <div class="receipt-info">Processed by: <span id="receiptProcessedBy">{{ app_username }}</span></div>
          <div class="receipt-info">Transaction no.: <span id="transactionNumber"></span></div>
          <div class="receipt-info">OR no.: <span id="orNumber"></span></div>
          <div class="receipt-info">Date: <span id="receiptDate"></span></div>
          <div class="receipt-info">Customer: <span id="receiptCustomerName"></span></div>
          <div class="receipt-info">Contact no.: <span id="receiptCustomerContact"></span></div>
          <div class="receipt-info">Address: <span id="receiptCustomerAddress"></span></div>
          <table class="receipt-table w-100 my-2">
            <thead><tr><th>Description</th><th class="text-end">Boxes</th><th class="text-end">Price</th><th class="text-end">Amount</th></tr></thead>
            <tbody id="receiptTableItems"></tbody>
          </table>
          <hr class="receipt-divider"/>
          <div class="d-flex justify-content-between"><span>Sub Total:</span><span id="receiptSubtotal">0.00</span></div>
          <div class="d-flex justify-content-between"><span>Plus 12% VAT:</span><span id="receiptVAT">0.00</span></div>
          <div class="d-flex justify-content-between fw-bold border-top pt-1"><span>TOTAL AMOUNT TO BE PAID:</span><span id="receiptTotalAmount">0.00</span></div>
          <div class="d-flex justify-content-between"><span>Cash (PHP) Tendered:</span><span id="receiptAmountPaid">0.00</span></div>
          <div class="d-flex justify-content-between"><span>Change Cash:</span><span id="receiptChange">0.00</span></div>
          <div class="receipt-footer text-center small mt-2">
            <p class="mb-1">This serves as your Official Receipt.</p>
            <p class="mb-1">SERVER SN: </p>
            <p class="mb-1">POS SN: </p>
            <p class="mb-1">BIR PERMIT NO. </p>
            <p class="mb-0">ACCREDITATION NO. </p>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          <button type="button" class="btn btn-outline-secondary" id="backToStep1" style="display:none;">Back</button>
        </div>
        <div>
          <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Cancel</button>
          <button type="button" class="btn btn-primary" id="nextToStep2">Proceed to Payment</button>
          <button type="button" class="btn btn-success" id="confirmPaymentStep" style="display:none;" disabled>Confirm Payment</button>
          <button type="button" class="btn btn-success" id="recordSaleBtn" style="display:none;">Record Sale</button>
          <button type="button" class="btn btn-outline-success" id="printReceiptBtn" style="display:none;">Print Receipt</button>
          <button type="button" class="btn btn-success" id="doneBtn" style="display:none;" onclick="history.back()">Done</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// CSRF helper
function getCookie(name){
  let v=null;
  if(document.cookie&&document.cookie!==''){
    const cs=document.cookie.split(';');
    for(let i=0;i<cs.length;i++){
      const c=cs[i].trim();
      if(c.substring(0,name.length+1)===(name+'=')){
        v=decodeURIComponent(c.substring(name.length+1));
        break;
      }
    }
  }
  return v;
}
const csrftoken=getCookie('csrftoken');
$.ajaxSetup({headers:{'X-CSRFToken':csrftoken}});

let currentStep=1; 
let saleItem = null; 
let transactionNumber=''; 
let orNumber='';

// Product data from Django template
const productData = {
  id: {{ product.product_id }},
  name: '{{ product.name }}',
  size: '{{ product.size|default:"" }}',
  price: parseFloat('{{ product.price|default:0 }}'),
  stock: parseInt('{{ product.stock|default:0 }}')
};

function updateTotal(){ 
  const qty = parseInt($('#saleQuantity').val()) || 0;
  const total = productData.price * qty;
  $('#liveSaleTotalWithVATText').text(total.toFixed(2));
}

function showStep(step){ 
  $('#saleStep1,#saleStep2,#saleStep3').hide(); 
  $('#stepIndicator1,#stepIndicator2,#stepIndicator3').removeClass('active'); 
  
  if(step===1){ 
    $('#saleStep1').show(); 
    $('#nextToStep2').show(); 
    $('#confirmPaymentStep,#recordSaleBtn,#printReceiptBtn,#doneBtn').hide(); 
    $('#backToStep1').hide(); 
    $('#stepIndicator1').addClass('active'); 
  } else if(step===2){ 
    $('#saleStep2').show(); 
    $('#nextToStep2').hide(); 
    $('#confirmPaymentStep').show(); 
    $('#recordSaleBtn,#printReceiptBtn,#doneBtn').hide(); 
    $('#backToStep1').show(); 
    $('#stepIndicator2').addClass('active'); 
  } else { 
    $('#saleStep3').show(); 
    $('#nextToStep2,#confirmPaymentStep').hide(); 
    $('#recordSaleBtn,#printReceiptBtn').show(); 
    $('#backToStep1').show(); 
    $('#stepIndicator3').addClass('active'); 
  } 
  currentStep=step; 
}

function generateReceipt(){ 
  const subtotal = parseFloat($('#paymentSubtotal').text()) || 0; 
  const vat = parseFloat($('#paymentVAT').text()) || 0; 
  const totalAmount = parseFloat($('#paymentTotalWithVAT').text()) || 0; 
  const amountPaid = parseFloat($('#paymentTendered').val()) || 0; 
  const change = parseFloat($('#paymentChange').text()) || 0; 
  const customerName = $('#customerName').val() || ''; 
  const customerContact = $('#customerContact').val() || ''; 
  const customerAddress = $('#customerAddress').val() || ''; 
  
  let description = productData.name;
  if(productData.size) description += ` (${productData.size})`;
  
  const html = `<tr><td>${description}</td><td class="text-end">${saleItem.quantity}</td><td class="text-end">₱${saleItem.price.toFixed(2)}</td><td class="text-end">₱${saleItem.amount.toFixed(2)}</td></tr>`;
  
  $('#receiptTableItems').html(html); 
  $('#receiptSubtotal').text(subtotal.toFixed(2)); 
  $('#receiptVAT').text(vat.toFixed(2)); 
  $('#receiptTotalAmount').text(totalAmount.toFixed(2)); 
  $('#receiptAmountPaid').text(amountPaid.toFixed(2)); 
  $('#receiptChange').text(change.toFixed(2)); 
  $('#transactionNumber').text(transactionNumber||''); 
  $('#orNumber').text(orNumber||''); 
  $('#receiptDate').text(new Date().toLocaleString()); 
  $('#receiptCustomerName').text(customerName); 
  $('#receiptCustomerContact').text(customerContact); 
  $('#receiptCustomerAddress').text(customerAddress); 
}

function recordSale(){ 
  const amountPaid = parseFloat($('#paymentTendered').val()) || 0; 
  const customerName = $('#customerName').val() || ''; 
  const customerContact = $('#customerContact').val() || ''; 
  const customerAddress = $('#customerAddress').val() || ''; 
  
  const saleData = { 
    action: 'buy', 
    items: JSON.stringify([saleItem]), 
    amount_paid: amountPaid, 
    customer_name: customerName, 
    customer_contact: customerContact, 
    customer_address: customerAddress, 
    transaction_number: transactionNumber, 
    or_number: orNumber, 
    purchase_date: new Date().toISOString().split('T')[0], 
    csrfmiddlewaretoken: csrftoken
  }; 
  
  $.ajax({ 
    url: "/products_inventory/post/", 
    method:'POST', 
    data:saleData, 
    success:function(resp){ 
      if(resp.success){ 
        try{ 
          if(resp.sale_ids && resp.sale_ids.length){ 
            transactionNumber = String(resp.sale_ids[0]); 
            $('#transactionNumber').text(transactionNumber); 
          } 
          $('#orNumber').text(orNumber||''); 
        }catch(e){} 
        $('#saleSuccessMessage').show(); 
        $('#printReceiptBtn').hide(); 
        $('#doneBtn').show(); 
      } else { 
        $('#buyFormAlert').html(`<div class="alert alert-danger alert-dismissible fade show" role="alert">${resp.message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`); 
      }
    }, 
    error:function(){ 
      $('#buyFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error recording sale. Please try again.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>'); 
    }
  }); 
}

function printReceipt(){ 
  const w=window.open('', '_blank'); 
  const content=$('.receipt-container').html(); 
  const html='<!doctype html><html><head><title>Receipt</title><style>body{font-family:"Courier New",monospace;font-size:12px;margin:0;padding:20px}.receipt-container{max-width:300px;margin:0 auto}</style></head><body><div class="receipt-container">'+content+'</div></body></html>'; 
  w.document.write(html); 
  w.document.close(); 
  w.print(); 
}

$(document).ready(function(){
  $('#saleDate').val(new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}));
  
  // Quantity validation and batch display for FIFO system
  const quantityInput = document.getElementById('saleQuantity');
  const batchesToSellDisplay = document.getElementById('batchesToSell');
  const totalAvailableBoxes = {{ stock_batches|length }};
  const availableBatches = [
    {% for batch in stock_batches %}
    '{{ batch.batch_id }}'{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  function validateQuantity() {
    const currentQuantity = parseInt(quantityInput.value) || 0;
    
    // Cannot exceed total available stock
    if (currentQuantity > totalAvailableBoxes) {
      quantityInput.value = totalAvailableBoxes;
      alert(`Maximum quantity available: ${totalAvailableBoxes} boxes`);
      return;
    }
    
    // Update batches to sell display
    updateBatchesToSell(currentQuantity);
  }

  function updateBatchesToSell(quantity) {
    if (quantity <= 0) {
      batchesToSellDisplay.textContent = 'Enter quantity to see which batches will be sold';
      batchesToSellDisplay.className = 'text-muted';
      return;
    }
    
    if (quantity === 1) {
      // Single batch
      batchesToSellDisplay.textContent = availableBatches[0];
      batchesToSellDisplay.className = 'text-success fw-bold';
    } else if (quantity <= availableBatches.length) {
      // Multiple batches - show range
      const firstBatch = availableBatches[0];
      const lastBatch = availableBatches[quantity - 1];
      batchesToSellDisplay.textContent = firstBatch + ' to ' + lastBatch;
      batchesToSellDisplay.className = 'text-success fw-bold';
    }
  }

  // Update total when quantity changes
  $('#saleQuantity').on('input', function() {
    updateTotal();
    validateQuantity();
  });
  
  $('#nextToStep2').on('click',function(){ 
    const form = $('#qrSaleForm')[0]; 
    const qty = parseInt($('#saleQuantity').val()) || 0;
    
    if(!form.checkValidity() || qty <= 0){ 
      form.reportValidity(); 
      return; 
    } 
    
    if(qty > productData.stock) {
      $('#buyFormAlert').html('<div class="alert alert-warning alert-dismissible fade show" role="alert">Quantity exceeds available stock.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>'); 
      return;
    }
    
    const amount = qty * productData.price;
    const subtotal = amount / 1.12; 
    const vat = amount - subtotal; 
    
    saleItem = { 
      product_id: productData.id, 
      name: productData.name, 
      size: productData.size, 
      quantity: qty, 
      price: productData.price, 
      amount: amount
      // No batch_id needed - system will handle FIFO automatically
    };
    
    $('#paymentSubtotal').text(subtotal.toFixed(2)); 
    $('#paymentVAT').text(vat.toFixed(2)); 
    $('#paymentTotalWithVAT').text(amount.toFixed(2)); 
    
    let description = productData.name;
    if(productData.size) description += ` (${productData.size})`;
    const html = `<tr><td>${description}</td><td class="text-end">${qty}</td><td class="text-end">₱${productData.price.toFixed(2)}</td><td class="text-end">₱${amount.toFixed(2)}</td></tr>`;
    $('#paymentTableItems').html(html); 
    
    const base = Date.now(); 
    const txnSuffix = (base%1000000).toString().padStart(6,'0'); 
    let orSuffix = ((base + Math.floor(Math.random()*900+100))%1000000); 
    if(orSuffix===Number(txnSuffix)){ 
      orSuffix = (orSuffix+1)%1000000; 
    } 
    transactionNumber = `TXN${txnSuffix}`; 
    orNumber = `OR${orSuffix.toString().padStart(6,'0')}`; 
    
    showStep(2); 
  });
  
  $('#backToStep1').on('click',function(){ 
    if(currentStep===2){ 
      showStep(1); 
    } else if(currentStep===3){ 
      showStep(2); 
    }
  });
  
  $('#confirmPaymentStep').on('click',function(){ 
    const tendered = parseFloat($('#paymentTendered').val()) || 0; 
    const total = parseFloat($('#paymentTotalWithVAT').text()) || 0; 
    if(tendered < total){ 
      $('#buyFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert">Amount tendered is less than total amount.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>'); 
      return; 
    } 
    const change = tendered - total; 
    $('#paymentChange').text(change.toFixed(2)); 
    generateReceipt(); 
    showStep(3); 
  });
  
  $('#paymentTendered').on('input',function(){ 
    const t = parseFloat($(this).val()) || 0; 
    const total = parseFloat($('#paymentTotalWithVAT').text()) || 0; 
    const change = t - total; 
    $('#paymentChange').text(change.toFixed(2)); 
    $('#confirmPaymentStep').prop('disabled', t < total); 
  });
  
  $('#recordSaleBtn').on('click', recordSale);
  $('#printReceiptBtn').on('click', printReceipt);
  
  // Focus on quantity input when page loads
  $('#saleQuantity').focus();
});
</script>
</body>
</html>
