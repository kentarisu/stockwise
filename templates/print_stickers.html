{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockWise - Print QR Code Stickers</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/modern-inventory.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 0;
    }
    
    .page-container {
      min-height: 100vh;
      background: #f8fafc;
      padding: 1rem;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }
    
    .card-modern {
      width: 100%;
      max-width: 1000px;
      background: #fff;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      overflow: hidden;
    }
    
    .card-header-modern {
      background: var(--gray-100);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .card-header-modern h5 {
      font-weight: 600;
      font-size: 0.95rem;
      color: #1f2937;
      margin: 0;
    }
    
    .form-section {
      margin-bottom: 1rem;
    }
    
    .form-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    
    .form-control {
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.8rem;
      padding: 0.4rem 0.6rem;
      height: 32px;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .form-control:disabled {
      background: var(--gray-100);
      color: #6b7280;
      cursor: not-allowed;
    }
    
    .dropdown-menu {
      max-height: 300px;
      overflow: auto;
      position: absolute;
      top: 100%;
      left: 0;
      right: auto;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .dropdown-item {
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    
    .dropdown-item:hover {
      background: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .alert-info {
      background: #e0f2fe;
      border: 1px solid #7dd3fc;
      border-radius: 8px;
      color: #0c4a6e;
    }
    
    .alert-info strong {
      color: var(--primary);
    }
    
    .btn {
      font-weight: 500;
      border-radius: 6px;
      padding: 0.625rem 1rem;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="card-modern">
      <div class="card-header-modern">
        <h5 class="m-0"><i class="bi bi-printer me-2"></i>Print QR Code Stickers</h5>
        <div>
          <a href="{% url 'add_stock_page' %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Back to Add Stock</a>
        </div>
      </div>
      <div class="p-3">
        <div class="form-section">
          <div class="form-section-title">
            <i class="bi bi-box-seam"></i> Product Selection
          </div>
          <div class="row g-3">
          <div class="col-md-6">
              <label class="form-label">Product Name</label>
              <div class="position-relative">
              <input type="text" class="form-control" id="stickerFruitSelect" placeholder="Search or select fruit name" autocomplete="off">
                <div id="nameSuggestions" class="dropdown-menu w-100" style="display:none;"></div>
            </div>
          </div>
          <div class="col-md-6">
              <label class="form-label">Variant</label>
              <div class="position-relative">
              <input type="text" class="form-control" id="stickerVariantSelect" list="stickerVariantList" placeholder="Search or select variant" disabled autocomplete="off">
                <div id="variantSuggestions" class="dropdown-menu w-100" style="display:none;"></div>
              </div>
              <datalist id="stickerVariantList"></datalist>
            </div>
          </div>
          <div class="row g-3 mt-0">
          <div class="col-md-6">
              <label class="form-label">Quantity</label>
              <div class="position-relative">
              <input type="text" class="form-control" id="stickerSizeSelect" placeholder="Enter quantity (e.g., 120 or 125-175)" disabled autocomplete="off">
                <div id="sizeSuggestions" class="dropdown-menu w-100" style="display:none;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-section">
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
          <strong>Instructions:</strong>
          <ul class="mb-0 mt-2">
            <li>Select a product name (fruit → variant → quantity)</li>
            <li>Enter a numeric quantity value (e.g., 28, 32, 125-175)</li>
            <li>Click "Generate QR Code Stickers" to create printable QR stickers</li>
            <li>Each sticker contains a unique QR code for that specific batch</li>
            <li><strong>Delivery date will be set when you scan and confirm stock</strong></li>
          </ul>
        </div>
        </div>
        
        <div class="d-flex justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-primary" id="generateStickersBtn" disabled>
            <i class="bi bi-qr-code-scan"></i> Generate QR Code Stickers
          </button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="{% static 'js/modern-inventory.js' %}"></script>
  <script>
    let allProducts=[];
    async function loadAllProducts(){ try{ const resp=await fetch('/api/products/active/',{headers:{'X-Requested-With':'XMLHttpRequest'}}); if(!resp.ok) throw new Error('Network error'); const data=await resp.json(); if(data.success){ allProducts=data.data; } }catch(e){ console.error('Load products error:', e); } }
    function baseName(name){ if(!name) return ''; const s=String(name); const i=s.indexOf('('); const j=s.endsWith(')')?s.lastIndexOf('('):-1; if(i>=0){ return s.substring(0,i).trim(); } return s.trim(); }
    function loadStickerVariants(fruit){ const variantList=$('#stickerVariantList'); $('#stickerVariantSelect').prop('disabled',true).val(''); $('#stickerSizeSelect').prop('disabled',true).val(''); variantList.empty(); if(!fruit) return; const variants=[...new Set(allProducts.filter(p=>baseName(p.name)===fruit).map(p=>p.variant).filter(v=>v))]; if(variants.length===0){       $('#stickerVariantSelect').prop('disabled',false).attr('placeholder','No variants available - proceed to quantity'); loadStickerSizes(fruit,''); } else { $('#stickerVariantSelect').prop('disabled',false).attr('placeholder','Search or select variant'); variants.forEach(v=>variantList.append($('<option>',{value:v}))); } }
    function loadStickerSizes(fruit,variant){ $('#stickerSizeSelect').prop('disabled',false).val(''); if(!fruit) return; const sizes=[...new Set(allProducts.filter(p=>{ if(!variant){return baseName(p.name)===fruit && (!p.variant||p.variant==='');} else {return baseName(p.name)===fruit && (p.variant||'')===variant;} }).map(p=>p.size).filter(s=>s))]; if(sizes.length>0){ $('#stickerSizeSelect').attr('placeholder',`Enter quantity (e.g., ${sizes.slice(0,3).join(', ')})`); } else { $('#stickerSizeSelect').attr('placeholder','Enter numeric quantity'); } }
    function validateForm(){ const fruit=$('#stickerFruitSelect').val(); const variant=$('#stickerVariantSelect').val(); const size=$('#stickerSizeSelect').val(); const hasVariants=allProducts.some(p=>baseName(p.name)===fruit && (p.variant||'')!==''); $('#generateStickersBtn').prop('disabled', hasVariants ? (!fruit||!variant||!size) : (!fruit||!size)); }
    $('#stickerFruitSelect').on('change', function(){ loadStickerVariants($(this).val()); validateForm(); });
    $('#stickerVariantSelect').on('change', function(){ loadStickerSizes($('#stickerFruitSelect').val(), $(this).val()); validateForm(); });
    $('#stickerSizeSelect').on('change input', validateForm);
    // CSRF setup
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    $.ajaxSetup({ headers: { 'X-CSRFToken': csrftoken } });
 
    // Autocomplete functions (inventory-only)
    function searchInventoryNames(query) {
        const q = (query || '').toLowerCase();
        const namesSet = new Set();
        (allProducts || []).forEach(p => {
            const nm = baseName(p.name) || '';
            if (!nm) return;
            if (q && nm.toLowerCase().indexOf(q) === -1) return;
            namesSet.add(nm);
        });
        const items = Array.from(namesSet).map(n => ({ name: n }));
        displayNameSuggestions(items);
    }
 
    function displayNameSuggestions(items) {
        const dropdown = $('#nameSuggestions');
        dropdown.empty();
        if (!items || items.length === 0) {
            dropdown.html('<div class="dropdown-item text-muted">No products found</div>').show();
            return;
        }
        items.forEach(p => {
            const option = $(`<div class="dropdown-item" data-name="${p.name}"><strong>${p.name}</strong></div>`);
            option.on('click', function(){
                $('#stickerFruitSelect').val(p.name);
                $('#stickerVariantSelect, #stickerSizeSelect').prop('disabled', false);
                window.__selectedProductFromSuggestions = true;
                dropdown.hide();
                updateEnableStates();
                validateForm();
                // Preload variants list for UX
                $('#stickerVariantSelect').trigger('focus');
            });
            dropdown.append(option);
        });
        dropdown.show();
    }
 
    function setupProductAutocomplete() {
        const $name = $('#stickerFruitSelect');
        const $dropdown = $('#nameSuggestions');
        let t;
        $name.on('input', function(){
            const q = $(this).val().trim();
            window.__selectedProductFromSuggestions = false;
            $('#stickerVariantSelect').val('').prop('disabled', true);
            $('#stickerSizeSelect').val('').prop('disabled', true);
            clearTimeout(t);
            t = setTimeout(() => {
                if (q.length >= 1) { searchInventoryNames(q); }
                else { $dropdown.hide(); }
            }, 250);
            updateEnableStates();
            validateForm();
        });
        $(document).on('click', function(e){
            if (!$(e.target).closest('#stickerFruitSelect, #nameSuggestions').length) { $dropdown.hide(); }
        });
        $name.on('focus', function(){
            const q = $(this).val().trim();
            searchInventoryNames(q);
        });
 
        const $variant = $('#stickerVariantSelect');
        const $size = $('#stickerSizeSelect');
        const ensureName = () => $name.val().trim();
        $variant.on('focus', function(){
            const base = ensureName(); if (!base) return;
            const variants = Array.from(new Set(
                (allProducts || [])
                  .filter(p => baseName(p.name) === base)
                  .map(p => p.variant)
                  .filter(v => v)
            ));
            let $menu = $('#variantSuggestions');
            if (!$menu.length) { $variant.after('<div id="variantSuggestions" class="dropdown-menu w-100"></div>'); $menu = $('#variantSuggestions'); }
            if (variants.length) {
                const list = variants.map(v => `<div class="dropdown-item variant-item">${v}</div>`).join('');
                $menu.html(list).show();
                $menu.off('click').on('click', '.variant-item', function(){ $variant.val($(this).text()); $menu.hide(); updateEnableStates(); validateForm(); });
            } else {
                $menu.hide();
            }
        });
        $variant.on('input change', function(){ updateEnableStates(); validateForm(); });
        $size.on('focus', function(){
            const base = ensureName(); if (!base) return;
            const selectedVariant = ($variant.val() || '').trim();
            const sizes = Array.from(new Set(
                (allProducts || [])
                  .filter(p => baseName(p.name) === base)
                  .filter(p => selectedVariant ? (p.variant || '') === selectedVariant : (p.variant || '') === (p.variant || ''))
                  .map(p => p.size)
                  .filter(s => s)
            ));
            let $menu = $('#sizeSuggestions');
            if (!$menu.length) { $size.after('<div id="sizeSuggestions" class="dropdown-menu w-100"></div>'); $menu = $('#sizeSuggestions'); }
            if (sizes.length) {
                const list = sizes.map(s => `<div class="dropdown-item size-item">${s}</div>`).join('');
                $menu.html(list).show();
                $menu.off('click').on('click', '.size-item', function(){ $size.val($(this).text()); $menu.hide(); validateForm(); });
            } else {
                $menu.hide();
            }
        });
        $size.on('input change', validateForm);
    }

    // Enable/disable Variant and Quantity depending on current selection
    function updateEnableStates(){
        const fruit = $('#stickerFruitSelect').val().trim();
        const hasVariants = (allProducts || []).some(p => baseName(p.name) === fruit && (p.variant || '') !== '');
        // Variant is enabled when a fruit is chosen and that fruit has variants
        $('#stickerVariantSelect').prop('disabled', !fruit || !hasVariants);
        // Quantity is enabled when fruit is chosen AND
        //  - if fruit has variants: a variant is also chosen
        //  - otherwise: immediately
        const variant = $('#stickerVariantSelect').val().trim();
        const sizeEnabled = !!fruit && (!hasVariants || !!variant);
        $('#stickerSizeSelect').prop('disabled', !sizeEnabled);
    }
 
    function validateForm() {
        const fruit = $('#stickerFruitSelect').val();
        const variant = $('#stickerVariantSelect').val();
        const size = $('#stickerSizeSelect').val();
        const hasVariants = (allProducts || []).some(p => baseName(p.name) === fruit && (p.variant || '') !== '');
        $('#generateStickersBtn').prop('disabled', hasVariants ? (!fruit || !variant || !size) : (!fruit || !size));
    }
 
    $(document).ready(function(){
        setupProductAutocomplete();
        // Suggestions container is pre-rendered in HTML (see above)
 
        $('#generateStickersBtn').on('click', function(){
            const fruit = $('#stickerFruitSelect').val();
            const variant = $('#stickerVariantSelect').val();
            const size = $('#stickerSizeSelect').val();
            if (!fruit || !size) {
                alert('Please select a product name and quantity');
                return;
            }
            const hasVariants = (allProducts || []).some(p => baseName(p.name) === fruit && (p.variant || '') !== '');
            const match = (allProducts || []).find(p => {
                const nameOk = baseName(p.name) === fruit;
                const variantOk = hasVariants ? ((p.variant || '') === (variant || '')) : true;
                const sizeOk = (String(p.size) === String(size));
                return nameOk && variantOk && sizeOk;
            });
            if (match) {
                const productId = match.product_id;
                const url = `/qr/sticker/${productId}/`;
                window.open(url, '_blank', 'width=800,height=600');
            } else {
                alert('Product not found in your inventory with that selection.');
            }
        });
        // Load inventory products for suggestions
    loadAllProducts();
    updateEnableStates();
    });
  </script>
</body>
</html>


