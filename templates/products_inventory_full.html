{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="StockWise">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>StockWise - Inventory Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/modern-inventory.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive-enhancements.css' %}">
    <!-- Select2 CSS for searchable selects -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #f8fafc;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --sidebar-width: 212px;
            --header-height: 72px;
            --layout-max-width: 1120px;
            --radius-lg: 14px;
            --radius-md: 10px;
            --space-2xs: 0.25rem;
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.25rem;
            --space-xl: 1.5rem;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 14px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.85rem;
            line-height: 1.45;
            background: var(--gray-50);
            min-height: 100vh;
            color: var(--gray-800);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Same as dashboard */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            position: fixed;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            z-index: 1000;
            transition: none;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .sidebar-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-100);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-header .burger-menu-btn {
            width: 1.5rem;
            height: 1.5rem;
            padding: 0;
            margin: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }

        .sidebar-header .burger-menu-btn span {
            width: 100%;
            height: 2px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .sidebar-header .burger-menu-btn:hover span {
            background: rgba(255, 255, 255, 0.8);
        }

        .sidebar-header .burger-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .sidebar-header .burger-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .sidebar-header .burger-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            font-size: 1.25rem;
            font-weight: 700;
            text-decoration: none;
            color: white;
            flex: 1;
        }

        .sidebar-brand i {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.4rem;
            border-radius: 8px;
        }

        .sidebar-nav {
            padding: var(--space-sm) 0;
        }

        .nav-section {
            margin-bottom: 1rem;
        }

        .nav-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--gray-400);
            padding: 0 var(--space-sm);
            margin-bottom: var(--space-xs);
        }

        .nav-item {
            margin-bottom: var(--space-2xs);
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: var(--space-sm);
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: 0;
            font-size: 0.85rem;
            font-weight: 500;
            position: relative;
        }

        .nav-link:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-link.active {
            color: var(--primary);
            background: var(--primary-light);
            border-right: 3px solid var(--primary);
        }

        .nav-link i {
            font-size: 1.1rem;
            margin-right: 0.4rem;
            width: 1.2rem;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
            background: var(--gray-50);
        }

        /* Desktop sidebar toggle */
        @media (min-width: 769px) {
            .sidebar {
                transform: translateX(0);
                width: var(--sidebar-width);
            }

            .sidebar:not(.active) {
                width: 64px;
            }

            .sidebar:not(.active) .nav-section-title {
                display: none;
            }

            .sidebar:not(.active) .nav-link {
                justify-content: center;
                padding: 0.75rem 0.5rem;
                font-size: 0;
            }

            .sidebar:not(.active) .nav-link i {
                margin-right: 0;
            }

            .sidebar:not(.active) .nav-link > span,
            .sidebar:not(.active) .nav-link > :not(i) {
                display: none;
            }

            .sidebar:not(.active) .sidebar-nav {
                padding: 0.5rem 0;
            }

            .main-content {
                margin-left: var(--sidebar-width);
                margin-top: var(--header-height);
            }

            .main-content:not(.sidebar-open) {
                margin-left: 64px;
            }

            .sidebar-overlay {
                display: none !important;
            }
        }

        .header {
            background: white;
            min-height: var(--header-height);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-sm) var(--space-xl);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            flex: 1;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.15rem;
            font-weight: 700;
            text-decoration: none;
            color: var(--gray-900);
            flex-shrink: 0;
        }

        .header-brand i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .header-brand:hover {
            color: var(--primary);
        }

        .header-title-section {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
            line-height: 1.25;
        }

        .header-subtitle {
            color: var(--gray-500);
            font-size: 0.8rem;
            margin-top: var(--space-xs);
            line-height: 1.3;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .user-avatar {
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            border: 2px solid var(--primary-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-avatar:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        /* Burger Menu Button - Now in sidebar header, styled above */

        /* Content Area */
        .content-area {
            padding: var(--space-lg);
            max-width: var(--layout-max-width);
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        /* Modern Cards - Matching other pages */
        .modern-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: var(--space-lg);
            padding: var(--space-lg);
        }

        .modern-card:hover {
            box-shadow: var(--shadow-lg);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .stat-icon.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .stat-icon.success { background: linear-gradient(135deg, var(--success), #059669); }
        .stat-icon.warning { background: linear-gradient(135deg, var(--warning), #d97706); }
        .stat-icon.danger { background: linear-gradient(135deg, var(--danger), #dc2626); }
        .stat-icon.info { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .stat-icon.secondary { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .stat-icon.dark { background: linear-gradient(135deg, var(--gray-700), var(--gray-800)); }

        .stat-content {
            flex: 1;
            min-width: 0;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--gray-500);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }


        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-modern.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-modern.success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-modern.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        /* Filters Card */
        .filters-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            margin-bottom: 1.5rem;
        }

        .filters-row {
            display: grid;
            grid-template-columns: 1fr 200px 200px 200px auto;
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control, .form-select {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .input-group {
            position: relative;
        }

        .input-group-text {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            z-index: 2;
            background: none;
            border: none;
            padding: 0;
        }

        .input-group .form-control {
            padding-left: 2.5rem;
        }

        .quantity-unit-group .form-select {
            flex: 0 0 130px;
            cursor: pointer;
        }

        @media (max-width: 576px) {
            .quantity-unit-group {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .quantity-unit-group .form-select {
                flex: 0 0 100%;
            }
        }

        /* Table */
        .table-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            /* Allow dropdowns to overflow above rows */
            overflow: visible;
        }

        .table-header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-700);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-title i {
            color: var(--primary);
            font-size: 1.125rem;
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background: var(--gray-50);
            border: none;
            border-bottom: 2px solid var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
            padding: 1rem;
            font-size: 0.875rem;
        }

        .table tbody td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background: var(--gray-50);
        }

        /* Allow all table containers to overflow for dropdowns */
        .table-card {
            overflow: visible !important;
        }

        .tab-content {
            overflow: visible !important;
        }

        .tab-pane {
            overflow: visible !important;
        }

        .table-responsive {
            overflow: visible !important;
        }

        /* Ensure proper table row stacking */
        .table tbody tr {
            position: relative;
            z-index: 1;
        }

        .table tbody tr:hover {
            z-index: 2;
        }

        /* Actions column needs higher z-index when dropdown is open */
        .table tbody td:last-child {
            position: relative;
            z-index: 10;
        }

        /* When dropdown is open, increase parent td z-index */
        .table-card .dropdown.show {
            z-index: 1000;
        }


        /* Status Badges */
        .badge {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .badge.bg-success {
            background: var(--success) !important;
        }

        .badge.bg-danger {
            background: var(--danger) !important;
        }

        /* Stock Indicators */
        .stock-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stock-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stock-dot.high { background: var(--success); }
        .stock-dot.medium { background: var(--warning); }
        .stock-dot.low { background: var(--danger); }

        /* Stock Details Link - Make it more obvious */
        .stock-link {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: 1px solid var(--primary);
        }

        .stock-link:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .stock-link i {
            font-size: 0.875rem;
        }

        /* Pagination - Matching Stock Details */
        .pagination-container {
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        .pagination-info {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .pagination .page-link {
            color: var(--primary);
            border-color: var(--gray-300);
        }

        .pagination .page-item.active .page-link {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pagination .page-item.disabled .page-link {
            color: var(--gray-400);
            pointer-events: none;
            background-color: var(--gray-50);
            border-color: var(--gray-200);
        }

        .pagination .page-link:hover:not(.disabled) {
            background-color: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary-dark);
        }

        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                gap: 1rem;
            }

            .pagination-container .d-flex {
                flex-direction: column;
                align-items: stretch !important;
                gap: 1rem;
            }

            .pagination-info {
                text-align: center;
            }

            .pagination {
                justify-content: center;
            }
        }

        /* Action Buttons in Table */
        .btn-group .btn {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            margin-right: 0.25rem;
            transition: all 0.2s ease;
        }

        .btn-group .btn:hover {
            transform: translateY(-1px);
        }

        /* Modals */
        .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            border-radius: 16px 16px 0 0;
            padding: 1.5rem;
        }

        .modal-title {
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-body {
            padding: 1.5rem;
        }
        
        #stockQRScanner {
            min-height: 300px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }
        
        #stockQRScanner video {
            border-radius: 8px;
        }

        .modal-footer {
            border-top: 1px solid var(--gray-200);
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: 0 0 16px 16px;
        }

        /* Tabs Styling */
        .nav-tabs {
            border-bottom: 2px solid var(--gray-200);
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 8px 8px 0 0;
            margin-right: 0.5rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--gray-600);
            background: transparent;
            transition: all 0.2s ease;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            background: var(--primary-light);
            border-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background: white;
            border-color: var(--gray-200) var(--gray-200) white;
            font-weight: 600;
        }

        .nav-tabs .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        /* Sidebar Overlay Backdrop */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --content-padding: 1rem;
                --sidebar-width: 280px;
                --header-height: 90px;
            }

            .sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-width);
                max-width: 85vw;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                margin-top: var(--header-height);
            }

            .header {
                padding: 0.75rem 1rem;
                min-height: var(--header-height);
            }

            .header-left {
                gap: 0.75rem;
            }

            .header-brand span {
                display: none;
            }

            .header-title-section {
                flex: 1;
                min-width: 0;
            }

            .header-left h1 {
                font-size: 1.25rem;
                line-height: 1.3;
                margin: 0;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
            }

            .header-subtitle {
                display: none;
            }

            .header-right {
                gap: 0.75rem;
                flex-wrap: wrap;
            }

            /* Burger Menu Button - Show on Mobile */
            .burger-menu-btn {
                display: flex !important;
                width: 0.875rem !important;
                height: 0.875rem !important;
            }

            .header-left {
                display: flex;
                align-items: center;
                flex: 1;
                min-width: 0;
                gap: 0.5rem;
            }

            .header-left h1 {
                font-size: 1.25rem;
                line-height: 1.3;
                margin: 0;
                flex: 1;
                min-width: 0;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
            }

            .header-subtitle {
                display: none;
            }

            .header-right {
                flex-shrink: 0;
            }

            /* Mobile menu toggle button - SHOW ON MOBILE */
            #mobileMenuToggle {
                display: flex !important;
                background: var(--primary) !important;
                border: 2px solid var(--gray-900) !important;
                color: #ffffff !important;
                min-width: 44px !important;
                min-height: 44px !important;
                position: relative !important;
                z-index: 9999 !important;
            }

            .content-area {
                padding: 1rem;
                max-width: 100%;
                overflow-x: hidden;
            }

            /* Cards - Mobile */
            .card-modern, .card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .stat-card {
                padding: 1rem 0.75rem;
                min-height: auto;
            }

            .stat-icon {
                width: 2.5rem;
                height: 2.5rem;
                font-size: 1.25rem;
                margin-bottom: 0.75rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .filters-row {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .filters-row .form-group {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }

            .action-buttons .btn-modern,
            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }

            .table-responsive {
                margin: 0 -1rem;
                padding: 0 1rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table {
                font-size: 0.8125rem;
                min-width: 600px;
            }

            .table th,
            .table td {
                padding: 0.625rem 0.5rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
                border-bottom: 2px solid var(--gray-200);
            }

            .nav-tabs .nav-link {
                font-size: 0.875rem;
                padding: 0.75rem 1rem;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Buttons - Mobile */
            .btn-modern, .btn, .dropdown-toggle {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 20px;
                font-size: 15px;
                border-radius: 10px;
            }

            /* Forms - Mobile */
            .form-control, .form-select {
                min-height: 44px;
                font-size: 16px;
                padding: 12px 16px;
            }

            /* Modals - Mobile */
            .modal-dialog {
                margin: 0.75rem;
                max-width: calc(100vw - 1.5rem);
            }

            .modal-footer {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-footer .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            :root {
                --content-padding: 0.75rem;
                --header-height: 80px;
            }

            .header {
                padding: 0.625rem 0.75rem;
            }

            .header-left h1 {
                font-size: 1.25rem;
            }

            .content-area {
                padding: 0.75rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.625rem;
            }

            .stat-card {
                padding: 0.875rem;
            }

            .table {
                font-size: 0.75rem;
            }

            .table th,
            .table td {
                padding: 0.5rem 0.375rem;
            }

            .btn-modern, .btn {
                padding: 12px 16px;
                font-size: 15px;
            }

            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100vw - 1rem);
            }
        }

        /* Extra small screens - stack cards vertically */
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .stat-card {
                padding: 0.75rem;
                min-height: 100px;
            }

            .stat-icon {
                width: 2rem;
                height: 2rem;
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }
        }

        /* Desktop - Hide mobile menu button */
        @media (min-width: 769px) {
            #mobileMenuToggle {
                display: none !important;
            }
        }
    </style>
    <style>
      /* Ensure scrollable modal-body occupies most of viewport */
      .modal-dialog-scrollable .modal-body {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }

      /* Record Sale Modal Styles */
      .sale-steps {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 2rem;
          margin-bottom: 2rem;
          padding: 1rem;
          background: #f8f9fa;
          border-radius: 12px;
      }

      .sale-step {
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
          min-width: 80px;
      }

      .sale-step i {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: #e9ecef;
          color: #6c757d;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 0.5rem;
          font-size: 1.2rem;
      }

      .sale-step.active i {
          background: var(--primary);
          color: white;
      }

      .sale-step-label {
          font-size: 0.875rem;
          font-weight: 500;
          color: #6c757d;
      }

      .sale-step.active .sale-step-label {
          color: var(--primary);
          font-weight: 600;
      }

      /* Payment Summary Table Styles */
      .payment-summary-table {
          width: 100%;
          max-width: 500px;
          margin: 0 auto 2rem;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          background: #fff;
      }

      .payment-summary-table tr {
          transition: background-color 0.2s ease;
      }

      .payment-summary-table tr:hover {
          background-color: rgba(211, 47, 47, 0.02);
      }

      .payment-summary-table th {
          background: #f8f9fa;
          color: #212529;
          font-weight: 600;
          padding: 1rem;
          text-align: left;
          border-bottom: 2px solid rgba(211, 47, 47, 0.1);
          width: 40%;
      }

      .payment-summary-table td {
          padding: 1rem;
          border-bottom: 1px solid rgba(0,0,0,0.05);
          font-weight: 500;
      }

      .payment-summary-table .amount {
          text-align: right;
          font-weight: 600;
          color: var(--primary);
      }

      .payment-summary-table .total-row th,
      .payment-summary-table .total-row td {
          background: rgba(211, 47, 47, 0.05);
          font-weight: 700;
          font-size: 1.1rem;
      }

      .payment-summary-table .amount-tendered th,
      .payment-summary-table .amount-tendered td {
          background: rgba(40, 167, 69, 0.05);
      }

      .payment-summary-table .change-row th,
      .payment-summary-table .change-row td {
          background: rgba(255, 193, 7, 0.05);
      }

      /* Receipt Styles */
      .receipt-container {
          max-width: 300px;
          margin: 0 auto;
          background: white;
          padding: 20px;
          border: 1px solid #ddd;
          font-family: 'Courier New', monospace;
          font-size: 12px;
      }

      .receipt-header {
          text-align: center;
          margin-bottom: 15px;
      }

      .company-name {
          font-weight: bold;
          font-size: 14px;
          margin-bottom: 5px;
      }

      .company-details {
          font-size: 10px;
          margin-bottom: 2px;
      }

      .receipt-title {
          text-align: center;
          font-weight: bold;
          font-size: 14px;
          margin-bottom: 10px;
          text-transform: uppercase;
      }

      .receipt-divider {
          border-top: 1px dashed #000;
          margin: 10px 0;
      }

      .receipt-info {
          margin-bottom: 3px;
          font-size: 11px;
      }

      .receipt-table {
          width: 100%;
          margin: 10px 0;
      }

      .receipt-table th,
      .receipt-table td {
          padding: 2px 5px;
          font-size: 11px;
      }

      .receipt-table th {
          border-bottom: 1px solid #000;
          font-weight: bold;
      }

      .align-right {
          text-align: right;
      }

      .receipt-summary {
          margin-top: 10px;
      }

      .receipt-summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 3px;
          font-size: 11px;
      }

      .receipt-summary-row.total {
          font-weight: bold;
          font-size: 12px;
          border-top: 1px solid #000;
          padding-top: 5px;
          margin-top: 5px;
      }

      .receipt-footer {
          text-align: center;
          margin-top: 15px;
          font-size: 10px;
      }

      .receipt-footer p {
          margin-bottom: 2px;
      }

      /* Item Row Styles */
      .item-row {
          background: #f8f9fa;
          border: 1px solid #e9ecef !important;
      }

      .stock-info {
          font-size: 0.75rem;
      }

      /* Button States */
      #nextToStep2:disabled {
          cursor: not-allowed;
          opacity: 0.7;
      }

      #nextToStep2:disabled:hover {
          background-color: var(--bs-secondary);
          border-color: var(--bs-secondary);
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
          .sale-steps {
              gap: 1rem;
              padding: 0.5rem;
          }
          
          .sale-step {
              min-width: 60px;
          }
          
          .sale-step i {
              width: 32px;
              height: 32px;
              font-size: 1rem;
          }
          
          .sale-step-label {
              font-size: 0.75rem;
          }
          
          .payment-summary-table {
              margin: 0 0 1rem 0;
          }
          
          .receipt-container {
              max-width: 280px;
              padding: 15px;
            }
        }
    </style>
    <style>
        /* Local mobile card overrides (standalone page) */
        @media (max-width: 768px) {
            .content-area table.table-mobile-card { width: 100% !important; min-width: 0 !important; display: block !important; background: #fff; }
            .content-area table.table-mobile-card thead { display: none !important; }
            .content-area table.table-mobile-card tbody { display: block !important; }
            .content-area table.table-mobile-card tr { display: block !important; margin-bottom: 0.75rem; border: 1px solid #e5e7eb; border-radius: 12px; padding: 0.75rem 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
            .content-area table.table-mobile-card td { display: flex !important; justify-content: space-between; align-items: center; gap: 0.75rem; padding: 0.5rem 0 !important; border: none !important; border-bottom: 1px solid #f3f4f6 !important; white-space: normal !important; color: #111827 !important; }
            .content-area table.table-mobile-card td:last-child { border-bottom: none !important; }
            .content-area table.table-mobile-card td::before { content: attr(data-label); font-weight: 600; color: #6b7280; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.03em; }
        }
    </style>
    <style>
        .modern-card .card-body {
            padding: 2rem;
        }

        .modern-card .table > :not(caption) > * > * {
            padding: 0.75rem;
        }

        /* Unified sizing overrides */
        :root {
            --sidebar-width: 212px;
            --header-height: 72px;
            --layout-max-width: 1120px;
            --radius-lg: 14px;
            --radius-md: 10px;
            --space-2xs: 0.25rem;
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.25rem;
            --space-xl: 1.5rem;
        }

        html {
            font-size: 14px;
        }

        body {
            font-size: 0.85rem;
            line-height: 1.45;
        }

        .header {
            padding: var(--space-sm) var(--space-xl);
            min-height: var(--header-height);
        }

        .header-left {
            gap: var(--space-sm);
        }

        .header-left h1 {
            font-size: 1.5rem;
        }

        .header-subtitle {
            font-size: 0.8rem;
            margin-top: var(--space-xs);
        }

        .header-right {
            gap: var(--space-sm);
        }

        .user-avatar {
            width: 1.75rem;
            height: 1.75rem;
        }

        .sidebar {
            width: var(--sidebar-width);
            transition: none;
        }

        .sidebar .nav-section-title {
            padding: 0 var(--space-sm);
            margin-bottom: var(--space-xs);
            font-size: 0.7rem;
            letter-spacing: 0.04em;
        }

        .sidebar .nav-link {
            padding: var(--space-sm);
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .sidebar .nav-link i {
            font-size: 1.1rem;
        }

        .main-content,
        .main-content.sidebar-open {
            margin-left: var(--sidebar-width);
            padding: var(--space-lg);
            min-height: calc(100vh - var(--header-height));
            transition: none;
        }

        .main-content:not(.sidebar-open) {
            margin-left: 64px;
        }

        .content-area {
            max-width: var(--layout-max-width);
            padding: var(--space-lg);
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-card {
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            gap: var(--space-sm);
        }

        .stat-value {
            font-size: 1.2rem;
        }

        .stat-label {
            font-size: 0.72rem;
        }

        .stat-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
        }

        .modern-card,
        .card,
        .summary-card,
        .profile-card,
        .table-card,
        .settings-card,
        .analytics-card,
        .dashboard-section,
        section {
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .modern-card .card-header,
        .card .card-header {
            padding: 0 0 var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .modern-card .card-body,
        .card .card-body {
            padding: 0;
        }

        table {
            font-size: 0.82rem;
        }

        table thead th,
        table tbody td {
            padding: 0.65rem 0.75rem;
        }

        .form-control,
        .form-select,
        .input-group-text {
            border-radius: 10px;
            padding: 0.45rem 0.75rem;
            font-size: 0.85rem;
        }

        .btn {
            border-radius: 10px;
            padding: 0.55rem 1rem;
            font-size: 0.85rem;
        }

        .action-buttons {
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        .header-title-section {
            gap: var(--space-2xs);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Unified Header -->
        <header class="header">
            <div class="header-left">
                <button class="burger-menu-btn" id="burgerMenuBtn" aria-label="Toggle sidebar menu" type="button">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <a href="{% url 'dashboard' %}" class="header-brand">
                    <i class="bi bi-basket-fill"></i>
                    <span>StockWise</span>
                </a>
                <div class="header-title-section">
                    <h1>Inventory Management</h1>
                    <p class="header-subtitle">Manage your product inventory and track stock levels</p>
            </div>
            </div>
            <div class="header-right">
                <div class="dropdown">
                    <img src="{{ user_obj.profile_picture|default:'https://via.placeholder.com/40' }}" alt="User" class="user-avatar" data-bs-toggle="dropdown">
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="bi bi-person me-2"></i>Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item logout-link" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </header>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <!-- Sidebar -->
        <nav class="sidebar active">
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item">
                        <a href="{% url 'dashboard' %}" class="nav-link">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="{% url 'products_inventory' %}" class="nav-link active">
                            <i class="bi bi-basket"></i>
                            <span>Inventory</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="{% url 'sales' %}" class="nav-link">
                            <i class="bi bi-cart"></i>
                            <span>Sales</span>
                        </a>
                    </div>
                </div>

                {% if app_role == 'admin' %}
                <div class="nav-section">
                    <div class="nav-section-title">Reports</div>
                    <div class="nav-item">
                        <a href="{% url 'reports' %}" class="nav-link">
                            <i class="bi bi-graph-up"></i>
                            <span>Reports</span>
                        </a>
                    </div>
                </div>
                {% endif %}

                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    {% if app_role == 'admin' %}
                    <div class="nav-item">
                        <a href="{% url 'sms_settings' %}" class="nav-link">
                            <i class="bi bi-chat-dots"></i>
                            <span>SMS Settings</span>
                        </a>
                    </div>
                    {% endif %}
                    <div class="nav-item">
                        <a href="{% url 'profile' %}" class="nav-link">
                            <i class="bi bi-person"></i>
                            <span>Profile</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="{% url 'logout' %}" class="nav-link logout-link">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content sidebar-open">

            <div class="content-area">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">{{ total_products }}</div>
                            <div class="stat-label">Total Boxes</div>
                            <div class="stat-subtitle" style="font-size: 0.7rem; color: var(--gray-500); margin-top: 0.125rem;">Total number of product boxes</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">{{ active_products }}</div>
                            <div class="stat-label">Active Products</div>
                            <div class="stat-subtitle" style="font-size: 0.7rem; color: var(--gray-500); margin-top: 0.125rem;">Products currently active</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="bi bi-boxes"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">{{ total_stock }}</div>
                            <div class="stat-label">Total Stock</div>
                            <div class="stat-subtitle" style="font-size: 0.7rem; color: var(--gray-500); margin-top: 0.125rem;">Total quantity in stock</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">{{ restock_alerts }}</div>
                            <div class="stat-label">Restock Alerts</div>
                            <div class="stat-subtitle" style="font-size: 0.7rem; color: var(--gray-500); margin-top: 0.125rem;">Products needing restock</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a href="{% url 'add_product_page' %}" class="btn-modern primary">
                        <i class="bi bi-plus-lg"></i>
                        Add Product
                    </a>
                    <a href="{% url 'record_sale_page' %}" class="btn-modern success">
                        <i class="bi bi-cart-plus"></i>
                        Record Sale
                    </a>
                    <a href="{% url 'add_stock_page' %}" class="btn-modern warning">
                        <i class="bi bi-box-arrow-in-down"></i>
                        Add Stock
                    </a>
                </div>

                <!-- Filters -->
                <div class="filters-card">
                    <div class="filters-row">
                        <div class="form-group">
                            <label class="form-label">Search</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search products..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filter</label>
                            <select class="form-select" id="filterSelect">
                                <option value="All Products">All Products</option>
                                <option value="Active">Active Only</option>
                                <option value="Discontinued">Discontinued</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Products</label>
                            <select class="form-select" id="fruitFilter">
                                <option value="all">All Products</option>
                                {% for fruit in fruits %}
                                <option value="{{ fruit }}" {% if fruit_filter == fruit %}selected{% endif %}>{{ fruit }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Supplier</label>
                            <select class="form-select" id="supplierFilter">
                                <option value="all">All Suppliers</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier }}" {% if supplier_filter == supplier %}selected{% endif %}>{{ supplier }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="align-self: end;">
                            <button type="button" class="btn-modern primary" id="refreshTable" aria-label="Refresh table" style="width: fit-content;">
                                <i class="bi bi-arrow-clockwise"></i>
                                <span class="d-none d-md-inline">Refresh</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="table-card">
                    <div class="table-header">
                        <ul class="nav nav-tabs border-0" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-products-tab" data-bs-toggle="tab" data-bs-target="#all-products" type="button" role="tab" aria-controls="all-products" aria-selected="true">All Products</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="low-stock-tab" data-bs-toggle="tab" data-bs-target="#low-stock" type="button" role="tab" aria-controls="low-stock" aria-selected="false">Low Stock</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="out-of-stock-tab" data-bs-toggle="tab" data-bs-target="#out-of-stock" type="button" role="tab" aria-controls="out-of-stock" aria-selected="false">Out of Stock</button>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-content p-3 pt-0">
                        <div class="tab-pane fade show active" id="all-products" role="tabpanel" aria-labelledby="all-products-tab">
                            <div class="table-responsive table-responsive-wrapper">
                                <table class="table table-mobile-card" id="allProductsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px">Product ID</th>
                                            <th>Fruit</th>
                                            <th>Variant</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th style="width: 150px">Options</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Filled by JavaScript -->
                                    </tbody>
                                </table>
                                <div id="pagination-allProductsTable" class="mt-3"></div>
                            </div>
                        </div>


                        <div class="tab-pane fade" id="low-stock" role="tabpanel" aria-labelledby="low-stock-tab">
                            <div class="table-responsive table-responsive-wrapper">
                                <table class="table table-mobile-card" id="lowStockTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px">Product ID</th>
                                            <th>Fruit</th>
                                            <th>Variant</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th style="width: 150px">Options</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Low stock products will be loaded dynamically -->
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">Loading low stock products...</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div id="pagination-lowStockTable" class="mt-3"></div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="out-of-stock" role="tabpanel" aria-labelledby="out-of-stock-tab">
                            <div class="table-responsive table-responsive-wrapper">
                                <table class="table table-mobile-card" id="outOfStockTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px">Product ID</th>
                                            <th>Fruit</th>
                                            <th>Variant</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th style="width: 150px">Options</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Out of stock products will be loaded dynamically -->
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">Loading out of stock products...</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div id="pagination-outOfStockTable" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="config" data-show-cost="{{ show_cost|yesno:'true,false' }}" style="display: none;"></div>

    

    <!-- Generate Stock QR Modal -->
    <div class="modal fade" id="generateStockQRModal" tabindex="-1" aria-labelledby="generateStockQRModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateStockQRModalLabel">Scan to Add Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3" id="stockQRContainer"></div>
                    <div class="small text-muted" id="stockQRLinkWrap" style="word-break: break-all;"></div>
                    <div class="alert alert-info mt-3" role="alert">
                        Open your phone camera or QR app and scan this code. The link will securely add the stock items you prepared.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-primary" id="copyStockQRLinkBtn">Copy Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan Stock QR Modal (webcam) -->
    <div class="modal fade" id="scanStockQRModal" tabindex="-1" aria-labelledby="scanStockQRModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scanStockQRModalLabel">Scan QR (Webcam)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="stockQRScanner" style="width: 100%">
                        <div class="text-center text-muted">
                            <i class="bi bi-camera" style="font-size: 2rem;"></i>
                            <p class="mt-2">Initializing camera...</p>
                        </div>
                    </div>
                    <div id="stockQRScanResult" class="mt-2 small text-muted"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="closeScanQRBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Change Confirmation Modal -->
    <div class="modal fade" id="discontinueModal" tabindex="-1" aria-labelledby="discontinueModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title" id="discontinueModalLabel">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                        <span id="modalTitle">Discontinue Product</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i id="modalIcon" class="bi bi-x-circle-fill text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <p class="mb-0" id="modalMessage">Are you sure you want to discontinue this product?</p>
                    <small class="text-muted" id="modalSubtext">This will change the product status to "Discontinued"</small>
                </div>
                <div class="modal-footer border-0 pt-0 justify-content-center">
                    <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn" id="confirmDiscontinue">
                        <i id="confirmIcon" class="bi bi-x-circle me-1"></i> <span id="confirmText">Discontinue</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal (Add/Edit) -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="productFormAlert"></div>
                    <form id="productForm" enctype="multipart/form-data" novalidate>
                        <input type="hidden" id="formAction" name="action" value="add">
                        <input type="hidden" id="productId" name="productId">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="productName" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="productName" name="productName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="variant" class="form-label">Variant (Optional)</label>
                                <input type="text" class="form-control" id="variant" name="variant" placeholder="e.g., Red, Green, Organic">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="size" class="form-label">Quantity</label>
                                <div class="input-group quantity-unit-group">
                                    <input type="text" class="form-control" id="size" name="size" required placeholder="Enter quantity">
                                    <select class="form-select" id="quantityUnit" name="quantity_unit" aria-label="Quantity unit">
                                        <option value="box" selected>Box</option>
                                        <option value="kilo">Kilo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="initialStock" class="form-label">Initial Stock (Per box/kilo)</label>
                                <input type="number" class="form-control" id="initialStock" name="initialStock" min="0" required>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="cost" class="form-label">Cost</label>
                                <div class="input-group">
                                    <span class="input-group-text"></span>
                                    <input type="number" class="form-control" id="cost" name="cost" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="price" class="form-label">Price</label>
                                <div class="input-group">
                                    <span class="input-group-text"></span>
                                    <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="dateAdded" class="form-label">Date Added</label>
                                <input type="date" class="form-control" id="dateAdded" name="dateAdded" required readonly title="Set to today and cannot be changed">
                            </div>
                            <div class="col-md-6">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="Active">Active</option>
                                    <option value="Discontinued">Discontinued</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productImage" class="form-label">Product Image (Optional)</label>
                            <input type="file" class="form-control w-auto" style="max-width: 400px;" id="productImage" name="productImage" accept="image/jpeg,image/png" aria-describedby="productImageFeedback" title="Upload an image (JPG/PNG, max 2MB)">
                            <div id="productImageFeedback" class="invalid-feedback">Please upload a valid image (JPG/PNG, max 2MB).</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" title="Close without saving">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn" title="Save the fruit details">Add Fruit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Stock modal removed in favor of dedicated page -->

    <!-- Record Sale modal removed in favor of dedicated page -->

    <!-- Print QR Code Stickers modal removed; use dedicated page -->


    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger me-2"></i>Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this fruit? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery and Bootstrap Bundle -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="{% static 'js/modern-inventory.js' %}"></script>

    <script>
        // CSRF token setup for AJAX
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        $.ajaxSetup({
            headers: {
                'X-CSRFToken': csrftoken
            }
        });

        // Expose cost-visibility flag for JS logic
        window.showCost = document.getElementById('config').dataset.showCost === 'true';

        // Global variables
        let currentProductId = null;
        let saleItems = [];
        let products = [];

        // Currency formatter
        const formatCurrency = (value) => {
            const num = Number(value || 0);
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // Alert function
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            // Remove existing alerts
            $('.alert').remove();
            // Add new alert at the top of the content area
            $('.content-area').prepend(alertHtml);
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 5000);
        }

        // Mobile-specific optimizations
        function initMobileOptimizations() {
            // Prevent iOS zoom on input focus
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                $('input[type="text"], input[type="number"], select').each(function() {
                    if ($(this).attr('type') !== 'search') {
                        $(this).css('font-size', '16px');
                    }
                });
            }
            
            // Add touch-friendly dropdown behavior
            $(document).on('touchstart', '.dropdown-toggle', function(e) {
                const $this = $(this);
                setTimeout(function() {
                    $this.dropdown('toggle');
                }, 10);
            });
            
            // Improve table scrolling on mobile
            $('.table-responsive').on('touchstart touchmove', function(e) {
                e.stopPropagation();
            });
            
            // Add haptic feedback for iOS (if available)
            if ('vibrate' in navigator) {
                $(document).on('click', '.btn:not(.dropdown-toggle), .dropdown-item', function() {
                    navigator.vibrate(10);
                });
            }
            
            // Handle custom icon buttons on mobile without interfering with Bootstrap dropdowns
            $(document).on('click', '.btn-icon', function(e) {
                // If this button is a Bootstrap dropdown toggler, let Bootstrap handle it
                if ($(this).attr('data-bs-toggle') === 'dropdown') {
                    return; // do not intercept Bootstrap dropdowns
                }
                // Otherwise, toggle the adjacent custom menu if any
                e.preventDefault();
                e.stopPropagation();
                const dropdown = $(this).next('.dropdown-menu');
                if (dropdown.length) {
                    $('.dropdown-menu').not(dropdown).removeClass('show');
                    dropdown.toggleClass('show');
                }
            });
            
            // Close dropdowns when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.dropdown').length) {
                    $('.dropdown-menu').removeClass('show');
                }
            });
        }

        // Filter Persistence Functions
        function isManualRefresh() {
            // Check if page was manually refreshed (F5 or refresh button)
            try {
                // Modern Navigation Timing API
                const navEntries = performance.getEntriesByType('navigation');
                if (navEntries.length > 0) {
                    return navEntries[0].type === 'reload';
                }
                // Legacy API
                if (performance.navigation && performance.navigation.type !== undefined) {
                    return performance.navigation.type === 1; // TYPE_RELOAD
                }
            } catch (e) {
                // API not available
            }
            // Fallback: check if page was navigated to (not refreshed)
            // On navigation, the page will be loaded fresh, so we check if we came from another page
            return !document.referrer || document.referrer.includes(window.location.hostname);
        }

        function saveFilters() {
            if (typeof Storage === 'undefined') return;
            const filters = {
                searchInput: $('#searchInput').val() || '',
                filterSelect: $('#filterSelect').val() || 'all',
                fruitFilter: $('#fruitFilter').val() || 'all',
                supplierFilter: $('#supplierFilter').val() || 'all',
                activeTab: document.querySelector('.nav-link.active')?.id || 'all-products-tab'
            };
            localStorage.setItem('inventory_filters', JSON.stringify(filters));
        }

        function loadFilters() {
            if (typeof Storage === 'undefined') return null;
            const saved = localStorage.getItem('inventory_filters');
            if (!saved) return null;
            try {
                return JSON.parse(saved);
            } catch (e) {
                return null;
            }
        }

        function clearFilters() {
            if (typeof Storage === 'undefined') return;
            localStorage.removeItem('inventory_filters');
        }

        function applySavedFilters() {
            // If manually refreshed, clear filters and use defaults
            if (isManualRefresh()) {
                clearFilters();
                return;
            }
            
            // Otherwise, restore saved filters
            const saved = loadFilters();
            if (!saved) return;
            
            if (saved.searchInput) $('#searchInput').val(saved.searchInput);
            if (saved.filterSelect) $('#filterSelect').val(saved.filterSelect);
            if (saved.fruitFilter) $('#fruitFilter').val(saved.fruitFilter);
            if (saved.supplierFilter) $('#supplierFilter').val(saved.supplierFilter);
            if (saved.activeTab) {
                const tabElement = document.getElementById(saved.activeTab);
                if (tabElement) {
                    const tab = new bootstrap.Tab(tabElement);
                    tab.show();
                }
            }
        }

        // Load products on page load
        $(document).ready(function() {
            console.log('Document ready - starting product loading...');
            
            setupEventHandlers();
            initMobileOptimizations();
            $('#addStockForm [name="date_added"]').val(new Date().toISOString().split('T')[0]);
            
            // Restore saved filters after handlers are set up
            applySavedFilters();
            
            // Load products after filters are restored
            setTimeout(function() {
                const activeTab = document.querySelector('.nav-link.active');
                const tabId = activeTab?.id || 'all-products-tab';
                switch(tabId) {
                    case 'all-products-tab': 
                        loadProducts('allProductsTable', 'all'); 
                        break;
                    case 'low-stock-tab': 
                        loadProducts('lowStockTable', 'Low Stock'); 
                        break;
                    case 'out-of-stock-tab': 
                        loadProducts('outOfStockTable', 'Out of Stock'); 
                        break;
                    default: 
                        loadProducts('allProductsTable', 'all');
                }
                loadActiveProducts();
            }, 100);

            console.log('Document ready - all initialization complete');
        });

        


        function setupEventHandlers() {
            // Search and filter - save on change
            $('#searchInput').on('input', function() {
                saveFilters();
                loadCurrentTab();
            });
            $('#filterSelect').on('change', function() {
                saveFilters();
                loadCurrentTab();
            });
            $('#fruitFilter').on('change', function() {
                saveFilters();
                loadCurrentTab();
            });
            $('#supplierFilter').on('change', function() {
                saveFilters();
                loadCurrentTab();
            });
            $('#refreshTable').on('click', loadCurrentTab);

            // Tab event listeners - save tab on change
            $('#all-products-tab').on('shown.bs.tab', function() {
                saveFilters();
                loadProducts('allProductsTable', 'all');
            });
            $('#low-stock-tab').on('shown.bs.tab', function() {
                saveFilters();
                loadProducts('lowStockTable', 'Low Stock');
            });
            $('#out-of-stock-tab').on('shown.bs.tab', function() {
                saveFilters();
                loadProducts('outOfStockTable', 'Out of Stock');
            });

            function loadCurrentTab() {
                const activeTab = document.querySelector('.nav-link.active');
                if (!activeTab) return;
                
                const tabId = activeTab.id;
                switch(tabId) {
                    case 'all-products-tab': 
                        loadProducts('allProductsTable', 'all'); 
                        break;
                    case 'low-stock-tab': 
                        loadProducts('lowStockTable', 'Low Stock'); 
                        break;
                    case 'out-of-stock-tab': 
                        loadProducts('outOfStockTable', 'Out of Stock'); 
                        break;
                    default: 
                        loadProducts('allProductsTable', 'all');
                }
            }

            // Product Modal (Add/Edit) - Initialize
            $('#productModal').on('show.bs.modal', function() {
                // Reset form for add mode
                $('#productForm')[0].reset();
                $('#formAction').val('add');
                $('#productId').val('');
                $('#productModalLabel').text('Add New Fruit');
                $('#productModalLabel').text('Add New Product');
                $('#saveProductBtn').text('Add Product').attr('title', 'Save the product details');
                $('#productFormAlert').empty();
                
                // Set today's date as default and lock it
                $('#dateAdded').val(new Date().toISOString().split('T')[0]).prop('readOnly', true);
            });

            // Handle Edit button from dropdown (use table row data to populate main modal)
            $(document).on('click', '.edit-btn', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const productId = $(this).data('id');
                const row = $(this).closest('tr');
                const nameText = row.find('td').eq(1).text().trim();
                const variantText = row.find('td').eq(2).text().trim();
                const sizeText = row.find('td').eq(3).text().trim();
                const priceText = row.find('td').eq(4).text().trim().replace('','').replace(',','');
                const statusText = row.find('td').eq(6).text().trim();

                // Parse name and variant if embedded
                let productName = nameText;
                let variant = variantText;
                if (!variant && /\(.*\)/.test(nameText)) {
                    const m = nameText.match(/^(.*?)\s*\((.*?)\)$/);
                    if (m) { productName = m[1].trim(); variant = m[2].trim(); }
                    }
                    
                // Set edit state and texts
                    $('#formAction').val('edit');
                    $('#productId').val(productId);
                $('#productModalLabel').text('Edit Product');
                $('#saveProductBtn').text('Save Changes').attr('title', 'Save the product details');
                    
                // Fill fields
                    $('#productName').val(productName);
                $('#variant').val(variant || '');
                $('#size').val(sizeText || '');
                $('#price').val(priceText || 0);
                $('#status').val(statusText);
                // Unit detect
                const detectedUnit = (sizeText || '').toLowerCase().includes('kilo') ? 'kilo' : 'box';
                $('#quantityUnit').val(detectedUnit);
                $('#productSizeUnit').val(detectedUnit);
                // Lock date to today
                $('#dateAdded').val(new Date().toISOString().split('T')[0]).prop('readOnly', true);
                    $('#productFormAlert').empty();
                $('#productImage').val('');

                // Show main modal
                $('#productModal').modal('show');
            });

            // Handle save button click
            $('#saveProductBtn').on('click', function() {
                const formData = new FormData($('#productForm')[0]);
                
                $.ajax({
                    url: "{% url 'handle_product_post' %}",
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#productModal').modal('hide');
                            loadProducts();
                        }
                        showAlert(response.message, response.success ? 'success' : 'danger');
                    },
                    error: function() {
                        showAlert('Error saving product. Please try again.', 'danger');
                    }
                });
            });

            // Add Stock Modal functionality
            let stockItems = [];

            // Function to validate stock items
            function validateStockItems() {
                let isValid = true;
                $('.stock-item').each(function() {
                    const productSelect = $(this).find('.stock-product-select');
                    const quantity = $(this).find('.stock-quantity');
                    const supplier = $(this).find('.stock-supplier');
                    
                    if (!productSelect.val() || !quantity.val() || quantity.val() < 1) {
                        isValid = false;
                        return false;
                    }
                });
                
                const dateAdded = $('#stockDate').val();
                if (!dateAdded) {
                    isValid = false;
                }
                
                $('#saveStockBtn').prop('disabled', !isValid);
                return isValid;
            }

            // Function to update current stock display
            function updateCurrentStock(selectElement) {
                const productId = $(selectElement).val();
                const stockItem = $(selectElement).closest('.stock-item');
                const stockDisplay = stockItem.find('.stock-indicator');
                
                if (productId) {
                    // Find the product in the products array
                    const product = products.find(p => p.product_id == productId);
                    if (product) {
                        stockDisplay.text(`Current Stock: ${product.stock || 0} boxes`);
                    }
                } else {
                    stockDisplay.text('');
                }
            }

            // Function to populate product select
            function populateProductSelect(selectElement) {
                const $select = $(selectElement);
                $select.html('<option value="">Select a fruit</option>');
                products.forEach(product => {
                    const variant = product.variant ? `(${product.variant})` : '';
                    const size = product.size ? `(${product.size})` : '';
                    const option = $(`<option 
                        value="${product.product_id}"
                        data-name="${product.name}"
                        data-variant="${product.variant || ''}"
                        data-size="${product.size || ''}"
                        data-price="${product.price || 0}"
                        data-stock="${product.stock || 0}"
                    >${product.name} ${variant} ${size}</option>`);
                    $select.append(option);
                });

                // Initialize Select2 for stock selects as well
                if (!$select.hasClass('select2-hidden-accessible')) {
                    $select.select2({
                        placeholder: 'Search and select a fruit...',
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $select.closest('.modal'),
                        templateResult: function(option) {
                            if (!option.id) return option.text;
                            const $opt = $(option.element);
                            const name = $opt.data('name') || '';
                            const variant = $opt.data('variant') ? ` (${$opt.data('variant')})` : '';
                            const size = $opt.data('size') ? ` (${$opt.data('size')})` : '';
                            const price = $opt.data('price') ? ` - ${formatCurrency($opt.data('price'))}` : '';
                            const stock = $opt.data('stock') ? ` - Stock: ${$opt.data('stock')}` : '';
                            return $(`<div><strong>${name}${variant}${size}</strong>${price}${stock}</div>`);
                        },
                        templateSelection: function(option) {
                            if (!option.id) return option.text;
                            const $opt = $(option.element);
                            const name = $opt.data('name') || '';
                            const variant = $opt.data('variant') ? ` (${$opt.data('variant')})` : '';
                            const size = $opt.data('size') ? ` (${$opt.data('size')})` : '';
                            const price = $opt.data('price') ? ` - ${formatCurrency($opt.data('price'))}` : '';
                            return `${name}${variant}${size}${price}`;
                        }
                    });
                } else {
                    $select.trigger('change.select2');
                }
            }



            // Handle Status Change button from dropdown
            let currentStatusChangeProductId = null;
            let currentStatusChangeAction = null;
            
            $(document).on('click', '.discontinue-btn', function() {
                currentStatusChangeProductId = $(this).data('id');
                const currentStatus = $(this).data('status');
                const isDiscontinued = currentStatus === 'Discontinued';
                
                if (isDiscontinued) {
                    // Continue/Reactivate mode
                    currentStatusChangeAction = 'continue';
                    $('#modalTitle').text('Continue Product');
                    $('#modalIcon').removeClass('bi-x-circle-fill text-danger').addClass('bi-arrow-counterclockwise text-success');
                    $('#modalMessage').text('Are you sure you want to continue this product?');
                    $('#modalSubtext').text('This will change the product status to "Active"');
                    $('#confirmDiscontinue').removeClass('btn-danger').addClass('btn-success');
                    $('#confirmIcon').removeClass('bi-x-circle').addClass('bi-arrow-counterclockwise');
                    $('#confirmText').text('Continue');
                } else {
                    // Discontinue mode
                    currentStatusChangeAction = 'discontinue';
                    $('#modalTitle').text('Discontinue Product');
                    $('#modalIcon').removeClass('bi-arrow-counterclockwise text-success').addClass('bi-x-circle-fill text-danger');
                    $('#modalMessage').text('Are you sure you want to discontinue this product?');
                    $('#modalSubtext').text('This will change the product status to "Discontinued"');
                    $('#confirmDiscontinue').removeClass('btn-success').addClass('btn-danger');
                    $('#confirmIcon').removeClass('bi-arrow-counterclockwise').addClass('bi-x-circle');
                    $('#confirmText').text('Discontinue');
                }
                
                $('#discontinueModal').modal('show');
            });

            // Handle confirm button
            $('#confirmDiscontinue').on('click', function() {
                if (currentStatusChangeProductId && currentStatusChangeAction) {
                    const newStatus = currentStatusChangeAction === 'continue' ? 'Active' : 'Discontinued';
                    const actionText = currentStatusChangeAction === 'continue' ? 'continued' : 'discontinued';
                    
                    $.ajax({
                        url: "{% url 'handle_product_post' %}",
                        method: 'POST',
                        data: {
                            action: 'update_status',
                            product_id: currentStatusChangeProductId,
                            status: newStatus
                        },
                        success: function(response) {
                            if (response.success) {
                                $('#discontinueModal').modal('hide');
                                loadProducts();
                                showAlert(`Product ${actionText} successfully`, 'success');
                            } else {
                                showAlert(response.message, 'danger');
                            }
                        },
                        error: function() {
                            showAlert(`Error ${actionText} product. Please try again.`, 'danger');
                        }
                    });
                    currentStatusChangeProductId = null;
                    currentStatusChangeAction = null;
                }
            });

            // Initialize stock modal
            $('#addStockModal').on('show.bs.modal', function() {
                // Reset form
                $('#stockItemsContainer').html(`
                    <div class="stock-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Fruit</label>
                                <select class="form-select stock-product-select" required>
                                    <option value="">Select a fruit</option>
                                </select>
                                <div class="stock-indicator text-muted small mt-1"></div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Boxes to Add</label>
                                <input type="number" class="form-control stock-quantity" min="1" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Supplier</label>
                                <input type="text" class="form-control stock-supplier" placeholder="Enter supplier name">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <!-- No delete button for the first row -->
                            </div>
                        </div>
                    </div>
                `);
                
                // Set today's date
                $('#stockDateDisplay').val(new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }));
                $('#stockDate').val(new Date().toISOString().split('T')[0]);
                
                // Populate product selects
                populateProductSelect('.stock-product-select');

                // Force Select2 init/update on all current stock selects
                $('.stock-product-select').each(function(){
                    const $sel = $(this);
                    if (!$sel.hasClass('select2-hidden-accessible')) {
                        $sel.select2({
                            placeholder: 'Search and select a fruit...',
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $sel.closest('.modal'),
                            templateResult: function(option){
                                if (!option.id) return option.text;
                                const $opt = $(option.element);
                                const name = $opt.data('name') || '';
                                const variant = $opt.data('variant') ? ` (${$opt.data('variant')})` : '';
                                const size = $opt.data('size') ? ` (${$opt.data('size')})` : '';
                                const price = $opt.data('price') ? ` - ${formatCurrency($opt.data('price'))}` : '';
                                const stock = $opt.data('stock') ? ` - Stock: ${$opt.data('stock')}` : '';
                                return $(`<div><strong>${name}${variant}${size}</strong>${price}${stock}</div>`);
                            },
                            templateSelection: function(option){
                                if (!option.id) return option.text;
                                const $opt = $(option.element);
                                const name = $opt.data('name') || '';
                                const variant = $opt.data('variant') ? ` (${$opt.data('variant')})` : '';
                                const size = $opt.data('size') ? ` (${$opt.data('size')})` : '';
                                const price = $opt.data('price') ? ` - ${formatCurrency($opt.data('price'))}` : '';
                                return `${name}${variant}${size}${price}`;
                            }
                        });
                    } else {
                        $sel.trigger('change.select2');
                    }
                });

                // Reset validation
                validateStockItems();
            });

            // Add new stock item
            $('#addStockItemBtn').on('click', function() {
                const newItem = $(
                    `<div class="stock-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">Fruit</label>
                                <select class="form-select stock-product-select" required>
                                    <option value="">Select a fruit</option>
                                </select>
                                <div class="stock-indicator text-muted small mt-1"></div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">Boxes to Add</label>
                                <input type="number" class="form-control stock-quantity" min="1" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">Supplier</label>
                                <input type="text" class="form-control stock-supplier" placeholder="Enter supplier name">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-danger btn-sm d-block w-100 remove-stock-item">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>`
                );
                $('#stockItemsContainer').append(newItem);
                populateProductSelect(newItem.find('.stock-product-select'));
                // Show remove buttons only for additional rows
                $('.remove-stock-item').show();
                validateStockItems();
            });

            // Remove stock item
            $(document).on('click', '.remove-stock-item', function() {
                $(this).closest('.stock-item').remove();
                // Hide remove buttons if only one item left
                if ($('.stock-item').length === 1) {
                    $('.remove-stock-item').hide();
                }
                validateStockItems();
            });

            // Handle product selection change
            $(document).on('change', '.stock-product-select', function() {
                updateCurrentStock(this);
                validateStockItems();
            });

            // Handle quantity change
            $(document).on('input', '.stock-quantity', function() {
                validateStockItems();
            });

            // Supplier is optional; no validation needed

            // Save stock button handler (kept for backwards compatibility but not used now)
            $('#saveStockBtn').on('click', function() {
                if (!validateStockItems()) {
                    $('#addStockFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Please fill in all required fields.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                    return;
                }

                // Collect stock items
                const stockItems = [];
                $('.stock-item').each(function() {
                    const productSelect = $(this).find('.stock-product-select');
                    const quantity = $(this).find('.stock-quantity');
                    const supplier = $(this).find('.stock-supplier');
                    
                    if (productSelect.val() && quantity.val()) {
                        stockItems.push({
                            product_id: productSelect.val(),
                            quantity: parseInt(quantity.val()),
                            supplier: supplier.val().trim() || ''
                        });
                    }
                });

                const data = {
                    action: 'add_stock',
                    items: JSON.stringify(stockItems),
                    date_added: $('#stockDate').val(),
                    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                };

                $.ajax({
                    url: "{% url 'handle_product_post' %}",
                    method: 'POST',
                    data: data,
                    success: function(response) {
                        if (response.success) {
                            loadProducts();
                            $('#addStockFormAlert').html('<div class="alert alert-success alert-dismissible fade show" role="alert"><i class="bi bi-check-circle-fill text-success me-2"></i>Stock added successfully!<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                        } else {
                            $('#addStockFormAlert').html(`<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>${response.message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`);
                        }
                    },
                    error: function() {
                        $('#addStockFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Error adding stock. Please try again.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                    }
                });
            });

            // Generate per-delivery QR (product + date) via Django QR service
            $('#generateStockQRBtn').off('click.qr').on('click.qr', function () {
                const $row = $('#stockItemsContainer .stock-item').first();
                const productId = $row.find('.stock-product-select').val();
                const dateISO = $('#stockDate').val(); // YYYY-MM-DD
                if (!productId || !dateISO) {
                    $('#addStockFormAlert').html('<div class="alert alert-warning alert-dismissible fade show" role="alert">Please select a fruit and ensure the date is set before generating a QR.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                    return;
                }
                const url = `/qr/generate/${productId}/?date=${encodeURIComponent(dateISO)}`;
                // Show QR in existing modal so you can copy/print
                const absolute = window.location.origin + url;
                $('#stockQRContainer').html(`<img src="${url}" alt="QR" style="max-width:100%"/>`);
                $('#stockQRLinkWrap').text(absolute);
                const m = new bootstrap.Modal(document.getElementById('generateStockQRModal'));
                m.show();
            });

            // Copy QR link
            $('#copyStockQRLinkBtn').on('click', function(){
                const text = $('#stockQRLinkWrap').text();
                navigator.clipboard.writeText(text).then(function(){
                    $('#stockQRLinkWrap').append('<div class="text-success"> Copied!</div>');
                });
            });

            // Scan QR with webcam (uses html5-qrcode if available)
            let html5QrcodeInstance = null;
            $('#scanStockQRBtn').on('click', function(){
                const modalEl = document.getElementById('scanStockQRModal');
                const m = new bootstrap.Modal(modalEl);
                m.show();
                
                // Reset the scanner area
                $('#stockQRScanner').html(`
                    <div class="text-center text-muted">
                        <i class="bi bi-camera" style="font-size: 2rem;"></i>
                        <p class="mt-2">Initializing camera...</p>
                    </div>
                `);
                $('#stockQRScanResult').text('');
                
                setTimeout(function(){
                    try {
                        if (window.Html5Qrcode) {
                            html5QrcodeInstance = new Html5Qrcode('stockQRScanner');
                            
                            const config = {
                                fps: 10,
                                qrbox: { width: 250, height: 250 },
                                aspectRatio: 1.0
                            };
                            
                            // Try back camera first, then front camera
                            const cameraConfigs = [
                                { facingMode: "environment" }, // Back camera
                                { facingMode: "user" },         // Front camera
                                "auto"                          // Auto-select
                            ];
                            
                            let cameraIndex = 0;
                            
                            function tryNextCamera() {
                                if (cameraIndex >= cameraConfigs.length) {
                                    $('#stockQRScanner').html(`
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            Unable to access camera. Please ensure camera permissions are granted and try again.
                                        </div>
                                    `);
                                    return;
                                }
                                
                                html5QrcodeInstance.start(
                                    cameraConfigs[cameraIndex],
                                    config,
                                    function(decodedText, decodedResult) {
                                        $('#stockQRScanResult').html(`
                                            <div class="alert alert-success">
                                                <i class="bi bi-check-circle me-2"></i>
                                                QR Code detected! Opening link...
                                            </div>
                                        `);
                                        // Stop scanning after successful scan
                                        html5QrcodeInstance.stop().then(() => {
                                            try { 
                                                window.open(decodedText, '_blank'); 
                                                m.hide(); // Close modal after opening link
                                            } catch(e) {
                                                console.log("Error opening link:", e);
                                            }
                                        }).catch(err => {
                                            console.log("Error stopping scanner:", err);
                                        });
                                    },
                                    function(errorMessage) {
                                        // Handle scan errors silently - this is normal during scanning
                                    }
                                ).catch(err => {
                                    console.log(`Camera ${cameraIndex} failed:`, err);
                                    cameraIndex++;
                                    tryNextCamera();
                                });
                            }
                            
                            tryNextCamera();
                        } else {
                            $('#stockQRScanner').html(`
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Webcam scanner library not found. You can scan using your phone after generating the QR.
                                </div>
                            `);
                        }
                    } catch (e) {
                        $('#stockQRScanner').html(`
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-circle me-2"></i>
                                Unable to start scanner: ${e.message}
                            </div>
                        `);
                    }
                }, 200);
            });

            $('#closeScanQRBtn').on('click', function(){
                if (html5QrcodeInstance) {
                    html5QrcodeInstance.stop().then(() => {
                        html5QrcodeInstance.clear();
                    }).catch(err => {
                        console.log("Error stopping scanner:", err);
                    });
                }
            });

            // Clean up scanner when modal is closed
            $('#scanStockQRModal').on('hidden.bs.modal', function(){
                if (html5QrcodeInstance) {
                    html5QrcodeInstance.stop().then(() => {
                        html5QrcodeInstance.clear();
                    }).catch(err => {
                        console.log("Error stopping scanner:", err);
                    });
                }
            });

            // Record sale form
            $('#recordSaleForm').on('submit', function(e) {
                e.preventDefault();
                if (saleItems.length === 0) {
                    showAlert('Please add at least one item to the sale.', 'danger');
                    return;
                }
                const data = {
                    action: 'buy',
                    items: JSON.stringify(saleItems),
                    amount_paid: parseFloat($('#recordSaleForm [name="amount_paid"]').val()),
                    purchase_date: new Date().toISOString().split('T')[0],
                    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                };
                $.ajax({
                    url: "{% url 'handle_product_post' %}",
                    method: 'POST',
                    data: data,
                    success: function(response) {
                        if (response.success) {
                            $('#recordSaleModal').modal('hide');
                            loadProducts();
                            saleItems = [];
                            updateSaleTable();
                        }
                        showAlert(response.message, response.success ? 'success' : 'danger');
                    }
                });
            });

            // Sale item selection
            $('#recordSaleForm [name="product"]').on('change', function() {
                const productId = $(this).val();
                if (!productId) return;
                const product = products.find(p => p.product_id == productId);
                if (product) {
                    $(this).val(productId); // Set the value to the product ID
                    $(this).trigger('change'); // Trigger change to update price
                }
            });

            // Add item to sale
            $('#recordSaleForm').on('submit', function(e) {
                e.preventDefault();
                const productId = $(this).find('[name="product"]').val();
                const quantity = parseInt($(this).find('[name="quantity"]').val());
                const product = products.find(p => p.product_id == productId);
                
                if (!product || quantity <= 0) return;
                
                saleItems.push({
                    product_id: product.product_id,
                    name: product.name,
                    size: product.size,
                    quantity: quantity,
                    price: product.price
                });
                
                updateSaleTable();
                $(this).find('[name="product"]').val('').trigger('change');
                $(this).find('[name="quantity"]').val('');
            });

            // Calculate change
            $('#recordSaleForm [name="amount_paid"]').on('input', function() {
                const amountPaid = parseFloat($(this).val()) || 0;
                const total = calculateTotal();
                const change = amountPaid - total;
                $('#recordSaleForm [name="change"]').val(change.toFixed(2));
            });

            // Delete confirmation
            $('#confirmDelete').on('click', function() {
                if (!currentProductId) return;
                $.ajax({
                    url: `/api/products/${currentProductId}/delete/`,
                    method: 'POST',
                    success: function(response) {
                        if (response.success) {
                            $('#deleteConfirmModal').modal('hide');
                            loadProducts();
                        }
                        showAlert(response.message, response.success ? 'success' : 'danger');
                    }
                });
            });
        }

        // Inventory pagination state and helpers
        const invPagination = { currentPage: {}, perPage: 10, totalPages: {} };
        function invSlice(arr, page){ const s=(page-1)*invPagination.perPage; return arr.slice(s, s+invPagination.perPage); }
        function invUpdateControls(totalItems, tableId){
            const container = document.querySelector(`#pagination-${tableId}`);
            if(!container) return;
            const current = invPagination.currentPage[tableId] || 1;
            const pages = Math.max(1, Math.ceil((totalItems||0)/invPagination.perPage));
            invPagination.totalPages[tableId] = pages;
            const hasPrevious = current > 1;
            const hasNext = current < pages;
            const startNumber = ((current - 1) * invPagination.perPage) + 1;
            const endNumber = Math.min(startNumber + invPagination.perPage - 1, totalItems);
            const itemType = tableId.includes('low') ? 'products' : tableId.includes('out') ? 'products' : 'products';
            
            let html = '';
            if(pages > 1 || totalItems > 0) {
                html = `<div class="pagination-container mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="pagination-info">
                            <span class="text-muted">Showing ${startNumber} to ${endNumber} of ${totalItems} ${itemType}</span>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item ${!hasPrevious ? 'disabled' : ''}">
                                    <a class="page-link" href="#" data-table="${tableId}" data-page="1" ${!hasPrevious ? 'tabindex="-1" aria-disabled="true"' : ''}>
                                        <i class="bi bi-chevron-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item ${!hasPrevious ? 'disabled' : ''}">
                                    <a class="page-link" href="#" data-table="${tableId}" data-page="${current - 1}" ${!hasPrevious ? 'tabindex="-1" aria-disabled="true"' : ''}>
                                        <i class="bi bi-chevron-left"></i> Previous
                                    </a>
                                </li>`;
                
                // Show up to 5 page numbers
                const pageNumbers = [];
                if(pages <= 5) {
                    for(let i = 1; i <= pages; i++) pageNumbers.push(i);
                } else if(current <= 3) {
                    for(let i = 1; i <= 5; i++) pageNumbers.push(i);
                } else if(current >= pages - 2) {
                    for(let i = pages - 4; i <= pages; i++) pageNumbers.push(i);
                } else {
                    for(let i = current - 2; i <= current + 2; i++) pageNumbers.push(i);
                }
                
                pageNumbers.forEach(pageNum => {
                    html += `<li class="page-item ${pageNum === current ? 'active' : ''}">
                        <a class="page-link" href="#" data-table="${tableId}" data-page="${pageNum}">${pageNum}</a>
                    </li>`;
                });
                
                html += `<li class="page-item ${!hasNext ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-table="${tableId}" data-page="${current + 1}" ${!hasNext ? 'tabindex="-1" aria-disabled="true"' : ''}>
                            Next <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item ${!hasNext ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-table="${tableId}" data-page="${pages}" ${!hasNext ? 'tabindex="-1" aria-disabled="true"' : ''}>
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>`;
            }
            container.innerHTML = html;
            container.querySelectorAll('a.page-link').forEach(a=>{
                a.addEventListener('click',(e)=>{
                    e.preventDefault();
                    // Skip if parent is disabled
                    if(a.closest('.page-item.disabled')) return;
                    const p = parseInt(a.dataset.page,10);
                    if(!p || p<1 || p>invPagination.totalPages[tableId]) return;
                    invPagination.currentPage[tableId]=p;
                    const all = window[`${tableId}_data`]||[];
                    renderProductsTableForPage(all, tableId);
                });
            });
        }

        function renderProductsTableForPage(data, tableId){
            const $tbody = $(`#${tableId} tbody`).empty();
            if(!data || !data.length){
                $tbody.append('<tr><td colspan="8" class="text-center text-muted py-4">No product yet</td></tr>');
                invUpdateControls(0, tableId);
                if (window.enhanceMobileTables) { window.enhanceMobileTables(); }
                return;
            }
            const page = invPagination.currentPage[tableId] || 1;
            const rows = invSlice(data, page);
            rows.forEach((product)=>{
                const row = $('<tr>');
                row.append(`<td>${product.product_id}</td>`);
                let productName = product.name; let variant = product.variant || '-';
                const m = productName && productName.match(/^(.+?)\s*\(([^)]+)\)$/);
                if(m){ productName = m[1].trim(); variant = m[2].trim(); }
                row.append(`<td>${productName}</td>`);
                row.append(`<td>${variant}</td>`);
                row.append(`<td>${product.size||''}</td>`);
                row.append(`<td>${formatCurrency(product.price)}</td>`);
                const stockClass = product.stock <= 10 ? 'text-danger' : product.stock <= 30 ? 'text-warning' : 'text-success';
                const stockValue = parseInt(product.stock)||0;
                row.append(`<td><i class="bi bi-circle-fill ${stockClass} me-1" style="font-size: .5rem"></i><a href="/stock_details/?product_id=${product.product_id}" class="stock-link" title="View Stock Details"><i class="bi bi-eye"></i> ${stockValue}</a></td>`);
                const statusLower = (product.status || '').toLowerCase();
                const statusBadgeClass = statusLower === 'active' ? 'bg-success' : 'bg-danger';
                const statusDisplay = product.status || 'N/A';
                row.append(`<td><span class="badge ${statusBadgeClass}">${statusDisplay}</span></td>`);
                let optionsHtml = `
                    <div class="dropdown">
                        <button class="btn btn-sm btn-icon dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="More options">
                            <i class="bi bi-three-dots-vertical"></i>
                            <span class="visually-hidden">More options for ${product.name}</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item edit-btn" data-id="${product.product_id}" title="Edit this product"><i class="bi bi-pencil me-2"></i> Edit</button></li>
                            <li><button class="dropdown-item discontinue-btn ${product.status==='Discontinued'?'continue-btn':''}" data-id="${product.product_id}" data-status="${product.status}" title="${product.status==='Discontinued'?'Continue this product':'Discontinue this product'}"><i class="bi bi-${product.status==='Discontinued'?'arrow-counterclockwise':'x-circle'} me-2"></i> ${product.status==='Discontinued'?'Continue':'Discontinue'}</button></li>
                        </ul>
                    </div>`;
                row.append(`<td>${optionsHtml}</td>`);
                $tbody.append(row);
            });
            invUpdateControls(data.length, tableId);
            if (window.enhanceMobileTables) { window.enhanceMobileTables(); }
        }

        function loadProducts(tableId = 'allProductsTable', filter = 'all') {
            const search = $('#searchInput').val();
            const currentFilter = $('#filterSelect').val();
            const supplierFilter = $('#supplierFilter').val() || 'all';
            const fruitFilter = $('#fruitFilter').val() || 'all';
            console.log('Loading products for table:', tableId, 'with filter:', filter, 'search:', search, 'supplier:', supplierFilter, 'fruit:', fruitFilter);
            
            fetch("{% url 'fetch_products' %}?" + new URLSearchParams({
                search: search || '',
                filter: filter === 'all' ? (currentFilter || 'All Products') : filter,
                supplier: supplierFilter,
                fruit: fruitFilter
            }))
            .then(response => response.json())
            .then(response => {
                console.log('Products API response:', response);
                
                if (!response.success) {
                    const tbody = $(`#${tableId} tbody`).empty();
                    tbody.append('<tr><td colspan="8" class="text-center text-muted py-4">No products found</td></tr>');
                    return;
                }
                
                if (!response.data || !Array.isArray(response.data)) {
                    console.error('Invalid data format from API:', response);
                    return;
                }
                
                // Store dataset and render page 1
                window[`${tableId}_data`] = response.data;
                invPagination.currentPage[tableId] = 1;
                renderProductsTableForPage(response.data, tableId);
                })
                .catch(function(error){
                    console.error('Failed to fetch products:', error);
                    const tbody = $('#inventoryTable tbody').empty();
                    tbody.append('<tr><td colspan="8" class="text-center text-muted py-4">No product yet</td></tr>');
                    if (window.enhanceMobileTables) { window.enhanceMobileTables(); }
                });
        }


        function loadActiveProducts() {
            return fetch("{% url 'get_active_products' %}")
                .then(response => response.json())
                .then(response => {
                console.log('Active products response:', response);  // debug
                if (!response.success) {
                    console.error('Failed to load products:', response.error);
                    return;
                }
                // Ensure numeric price to avoid toFixed error
                products = response.data.map(function(p){
                    p.price = parseFloat(p.price) || 0;
                    return p;
                });
                // Update all existing dropdowns
                document.querySelectorAll('.product-select').forEach(select => {
                    select.innerHTML = '<option value="">Select a fruit</option>' + 
                        products.map(function(p){ return `<option value="${p.product_id}" data-price="${p.price}" data-name="${p.name}" data-variant="${p.variant || ''}" data-size="${p.size || ''}" data-stock="${p.stock || 0}">${p.name} (${p.size}) - ${formatCurrency(p.price)}</option>`; }).join('');
                });
                return products; // Return products for Promise chain
            });
        }

        // Record Sale handlers
        let currentStep = 1;
        const totalSteps = 3;

        // Global functions for Record Sale modal
            function addItemRow() {
            const itemCount = $('.item-row').length;
            const rowHtml = `
                <div class="item-row mb-3 p-3 border rounded">
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label">Fruit</label>
                            <select class="form-select product-select" required>
                                <option value="">Select a fruit</option>
                        </select>
                            <div class="stock-info text-muted small mt-1"></div>
                    </div>
                        <div class="col-md-4">
                            <label class="form-label">Boxes</label>
                            <input type="number" class="form-control quantity-input stock-quantity" min="1" required>
                    </div>
                    <div class="col-md-3">
                            <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">&nbsp;</label>
                            ${itemCount > 0 ? '<button type="button" class="btn btn-outline-danger btn-sm remove-item"><i class="bi bi-trash"></i></button>' : ''}
                    </div>
                    </div>
                    </div>
                `;
            $('#itemsContainer').append(rowHtml);
            updateProductSelects();
        }

        function updateProductSelects() {
            $('.product-select').each(function() {
                const $this = $(this);
                if ($this.find('option').length <= 1) { // Only has default option
                    let options = '<option value="">Select a fruit</option>';
                    products.forEach(product => {
                        options += `<option value="${product.product_id}" data-price="${product.price}" data-name="${product.name}" data-variant="${product.variant || ''}" data-size="${product.size || ''}" data-stock="${product.stock || 0}">${product.name} (${product.size || 'N/A'}) - ${formatCurrency(product.price)}</option>`;
                    });
                    $this.html(options);
                    
                    // Initialize Select2 if not already initialized
                    if (!$this.hasClass('select2-hidden-accessible')) {
                        $this.select2({
                            placeholder: 'Search and select a fruit...',
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $this.closest('.modal'),
                            templateResult: function(option) {
                                if (!option.id) return option.text;
                                const $option = $(option.element);
                                const name = $option.data('name') || '';
                                const variant = $option.data('variant') ? ` (${$option.data('variant')})` : '';
                                const size = $option.data('size') ? ` (${$option.data('size')})` : '';
                                const price = $option.data('price') ? ` - ${formatCurrency($option.data('price'))}` : '';
                                const stock = $option.data('stock') ? ` - Stock: ${$option.data('stock')}` : '';
                                return $(`<div><strong>${name}${variant}${size}</strong>${price}${stock}</div>`);
                            },
                            templateSelection: function(option) {
                                if (!option.id) return option.text;
                                const $option = $(option.element);
                                const name = $option.data('name') || '';
                                const variant = $option.data('variant') ? ` (${$option.data('variant')})` : '';
                                const size = $option.data('size') ? ` (${$option.data('size')})` : '';
                                const price = $option.data('price') ? ` - ${formatCurrency($option.data('price'))}` : '';
                                return `${name}${variant}${size}${price}`;
                            }
                        });
                    } else {
                        // Refresh Select2 if already initialized
                        $this.trigger('change.select2');
                    }
                }
            });
        }

        function updateTotal() {
            let total = 0;
            $('.item-row').each(function() {
                const $select = $(this).find('.product-select option:selected');
                const $quantity = $(this).find('.quantity-input');
                if ($select.val() && $quantity.val()) {
                    const price = parseFloat($select.data('price')) || 0;
                    const quantity = parseInt($quantity.val()) || 0;
                    total += price * quantity;
                }
            });
            $('#liveSaleTotalWithVATText').text(formatCurrency(total));
        }

        function showStep(step) {
            // Hide all steps
            // The following helpers were for the removed sale modal; harmless but not used
            $('#saleStep1, #saleStep2, #saleStep3').hide();
            $('#step1Buttons, #step2Buttons, #step3Buttons').hide();
            
            // Show current step
            $(`#saleStep${step}`).show();
            $(`#step${step}Buttons`).show();
            
            // Update step indicators
            $('.sale-step').removeClass('active');
            $(`#stepIndicator${step}`).addClass('active');
            
            currentStep = step;
        }

        function generateReceipt() {
            const items = window.saleItems || [];
            const subtotal = parseFloat($('#paymentSubtotal').text()) || 0;
            const vat = parseFloat($('#paymentVAT').text()) || 0;
            const totalAmount = parseFloat($('#paymentTotalWithVAT').text()) || 0;
            const amountPaid = parseFloat($('#paymentTendered').val()) || 0;
            const change = parseFloat($('#paymentChange').text()) || 0;

            // Get customer information
            const customerName = $('#customerName').val() || 'Walk-in Customer';
            const customerContact = $('#customerContact').val() || '';
            const customerAddress = $('#customerAddress').val() || '';

            // Generate receipt items
            let receiptItemsHtml = '';
            items.forEach(item => {
                let description = `${item.name}`;
                if (item.variant) description += ` (${item.variant})`;
                if (item.size) description += ` (${item.size})`;
                receiptItemsHtml += `
                    <tr>
                        <td>${description}</td>
                        <td class="align-right">${item.quantity}</td>
                        <td class="align-right">${formatCurrency(item.price)}</td>
                        <td class="align-right">${formatCurrency(item.amount)}</td>
                    </tr>
                `;
            });
            $('#receiptTableItems').html(receiptItemsHtml);

            // Update receipt summary
            $('#receiptSubtotal').text(formatCurrency(subtotal));
            $('#receiptVAT').text(formatCurrency(vat));
            $('#receiptTotalAmount').text(formatCurrency(totalAmount));
            $('#receiptAmountPaid').text(formatCurrency(amountPaid));
            $('#receiptChange').text(formatCurrency(change));

            // Generate transaction number and OR number
            const transactionNumber = 'TXN' + Date.now().toString().slice(-6);
            const orNumber = 'OR' + Date.now().toString().slice(-6);
            $('#transactionNumber').text(transactionNumber);
            $('#orNumber').text(orNumber);
            $('#receiptDate').text(new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }));

            // Add customer information to receipt
            let customerInfoHtml = '';
            if (customerName && customerName !== 'Walk-in Customer') {
                customerInfoHtml += `<div class="receipt-info"><span>Customer: ${customerName}</span></div>`;
            }
            if (customerContact) {
                customerInfoHtml += `<div class="receipt-info"><span>Contact: ${customerContact}</span></div>`;
            }
            if (customerAddress) {
                customerInfoHtml += `<div class="receipt-info"><span>Address: ${customerAddress}</span></div>`;
            }
            
            // Insert customer info after transaction number
            if (customerInfoHtml) {
                $('#transactionNumber').parent().after(customerInfoHtml);
            }
        }

        function recordSale() {
            const items = window.saleItems || [];
            const amountPaid = parseFloat($('#paymentTendered').val()) || 0;
            
            const saleData = {
                action: 'buy',
                items: JSON.stringify(items),
                amount_paid: amountPaid,
                purchase_date: new Date().toISOString().split('T')[0],
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            };

            $.ajax({
                url: "{% url 'handle_product_post' %}",
                method: 'POST',
                data: saleData,
                success: function(response) {
                    if (response.success) {
                        $('#saleSuccessMessage').show();
                        $('#printReceiptBtn').hide();
                        $('#printReceiptAfterBtn').show();
                        $('#doneBtn').show();
                        loadProducts(); // Refresh product list
                    } else {
                        $('#buyFormAlert').html(`<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>${response.message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`);
                    }
                },
                error: function() {
                    $('#buyFormAlert').html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Error recording sale. Please try again.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                }
            });
        }

        function printReceipt() {
            const printWindow = window.open('', '_blank');
            const receiptContent = $('.receipt-container').html();
            let html = '<html>';
            html += '<head>';
            html += '<style>';
            html += 'body { font-family: "Courier New", monospace; font-size: 12px; margin: 0; padding: 20px; }';
            html += '.receipt-container { max-width: 300px; margin: 0 auto; }';
            html += '.receipt-header { text-align: center; margin-bottom: 15px; }';
            html += '.company-name { font-weight: bold; font-size: 14px; margin-bottom: 5px; }';
            html += '.company-details { font-size: 10px; margin-bottom: 2px; }';
            html += '.receipt-title { text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }';
            html += '.receipt-divider { border-top: 1px dashed #000; margin: 10px 0; }';
            html += '.receipt-info { margin-bottom: 3px; font-size: 11px; }';
            html += '.receipt-table { width: 100%; margin: 10px 0; }';
            html += '.receipt-table th, .receipt-table td { padding: 2px 5px; font-size: 11px; }';
            html += '.receipt-table th { border-bottom: 1px solid #000; font-weight: bold; }';
            html += '.align-right { text-align: right; }';
            html += '.receipt-summary { margin-top: 10px; }';
            html += '.receipt-summary-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 11px; }';
            html += '.receipt-summary-row.total { font-weight: bold; font-size: 12px; border-top: 1px solid #000; padding-top: 5px; margin-top: 5px; }';
            html += '.receipt-footer { text-align: center; margin-top: 15px; font-size: 10px; }';
            html += '.receipt-footer p { margin-bottom: 2px; }';
            html += '@media print { body { width: 302px; } }';
            html += '</style>';
            html += '</head>';
            html += '<body>';
            html += '<div class="receipt-container">';
            html += receiptContent;
            html += '</div>';
            html += '</body>';
            html += '</html>';
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        function resetSaleModal() {
            // Reset to step 1
            showStep(1);
            
            // Clear customer information
            $('#customerName').val('');
            $('#customerContact').val('');
            $('#customerAddress').val('');
            
            // Clear form - keep only the first item row from HTML template
            $('#itemsContainer').html(`
                <div class="item-row mb-3 p-3 border rounded">
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label">Fruit</label>
                            <select class="form-select product-select" id="productSelect0" required>
                                <option value="">Select a fruit</option>
                            </select>
                            <div class="stock-info text-muted small mt-1"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Boxes</label>
                            <input type="number" class="form-control quantity-input stock-quantity" id="quantityInput0" min="1" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="visibility:hidden;height:0;margin:0;padding:0;">&nbsp;</label>
                            <!-- No remove button for the first row -->
                        </div>
                    </div>
                </div>
            `);
            
            // Clear totals
            $('#liveSaleTotalWithVATText').text('0.00');
            $('#paymentSubtotal').text('0.00');
            $('#paymentVAT').text('0.00');
            $('#paymentTotalWithVAT').text('0.00');
            $('#paymentTendered').val('');
            $('#paymentChange').text('0.00');
            
            // Clear alerts
            $('#buyFormAlert').html('');
            $('#saleSuccessMessage').hide();
            
            // Reset buttons
            $('#printReceiptBtn').show();
            $('#printReceiptAfterBtn').hide();
            $('#doneBtn').hide();
            
            // Clear stored items
            window.saleItems = [];
        }

        // Record Sale modal removed; keep only sticker modal logic
        $(document).ready(function() {
            // Set today's date
            $('#purchaseDate').val(new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }));

            // Add input validation for size fields to only allow numbers
            $('input[name="size"], #stickerSizeSelect').on('input', function() {
                let value = $(this).val();
                // Remove any non-numeric characters except decimal point
                value = value.replace(/[^0-9.]/g, '');
                // Ensure only one decimal point
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                $(this).val(value);
            });

            // Prevent non-numeric characters from being typed
            $('input[name="size"], #stickerSizeSelect').on('keypress', function(e) {
                const char = String.fromCharCode(e.which);
                // Allow: backspace, delete, tab, escape, enter, decimal point
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true)) {
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105) && e.keyCode !== 190) {
                    e.preventDefault();
                }
            });

            // Removed sale modal logic. Standalone page handles sale flow.
        });

        // Sticker modal logic removed; use dedicated page instead

        // Sidebar toggle functionality (works on both desktop and mobile)
        const sidebar = document.querySelector('.sidebar');
        const burgerMenuBtn = document.getElementById('burgerMenuBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Sidebar starts open via HTML. No animation adjustments needed.

        // Desktop transitions disabled intentionally

        // Enable transitions after initial render (disabled)

        // Burger menu button toggle
        if (burgerMenuBtn && sidebar) {
            burgerMenuBtn.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                burgerMenuBtn.classList.toggle('active');
                const mainContent = document.querySelector('.main-content');
                
                if (window.innerWidth > 768) {
                    // Desktop: toggle sidebar and adjust main content
                    if (sidebar.classList.contains('active')) {
                        if (mainContent) mainContent.classList.add('sidebar-open');
                    } else {
                        if (mainContent) mainContent.classList.remove('sidebar-open');
                    }
                } else {
                    // Mobile: show overlay and prevent body scroll
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.toggle('active');
                    }
                    if (sidebar.classList.contains('active')) {
                        document.body.style.overflow = 'hidden';
                    } else {
                        document.body.style.overflow = '';
                    }
                }
            });
        }

        // Close sidebar when clicking overlay (mobile only)
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    if (burgerMenuBtn) burgerMenuBtn.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }

        // Close sidebar when clicking on navigation links
        if (sidebar) {
            const navLinks = sidebar.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const mainContent = document.querySelector('.main-content');
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                        if (burgerMenuBtn) burgerMenuBtn.classList.remove('active');
                        if (sidebarOverlay) sidebarOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                        console.log('Mobile sidebar closed from nav link click');
                    } else {
                        // Desktop: close sidebar when navigating
                        sidebar.classList.remove('active');
                        if (burgerMenuBtn) burgerMenuBtn.classList.remove('active');
                        if (mainContent) mainContent.classList.remove('sidebar-open');
                    }
                });
            });
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            const mainContent = document.querySelector('.main-content');
            if (window.innerWidth > 768) {
                // Desktop: keep sidebar state but remove mobile-specific styles
                if (sidebarOverlay) sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
                if (sidebar && sidebar.classList.contains('active') && mainContent) {
                    mainContent.classList.add('sidebar-open');
                } else if (mainContent) {
                    mainContent.classList.remove('sidebar-open');
                }
            } else {
                // Mobile: remove desktop-specific styles
                if (mainContent) mainContent.classList.remove('sidebar-open');
            }
        });

        // Handle escape key to close sidebar
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                if (burgerMenuBtn) burgerMenuBtn.classList.remove('active');
                const mainContent = document.querySelector('.main-content');
                if (window.innerWidth > 768) {
                    if (mainContent) mainContent.classList.remove('sidebar-open');
                } else {
                    if (sidebarOverlay) sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
                }
                console.log('Sidebar closed from escape key');
            }
        });

        // Handle logout confirmation
        document.querySelectorAll('.logout-link, a[href*="logout"]').forEach(function(link) {
            link.addEventListener('click', function(e) {
                // Check if Bootstrap modal is available
                if (typeof bootstrap !== 'undefined') {
                    e.preventDefault();
                    const logoutModal = new bootstrap.Modal(document.getElementById('logoutConfirmModal'));
                    logoutModal.show();
                }
            });
        });

        // Event handlers for action buttons
        $(document).on('click', '.edit-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const productId = $(this).data('id');
            console.log('Edit button clicked for product ID:', productId);
            
            // Find the product data from the current table
            const row = $(this).closest('tr');
            const productData = {
                product_id: productId,
                name: row.find('td').eq(1).text().trim(), // Fruit column
                variant: row.find('td').eq(2).text().trim(), // Variant column
                size: row.find('td').eq(3).text().trim(), // Quantity column
                price: row.find('td').eq(4).text().trim().replace('', '').replace(',', ''), // Price column
                status: row.find('td').eq(6).text().trim() === 'ACTIVE' ? 'Active' : 'Discontinued' // Status column
            };
            
            console.log('Product data extracted:', productData);
            
            // Populate the edit form
            $('#productModalLabel').text('Edit Product');
            $('input[name="product_id"]').val(productData.product_id);
            $('input[name="name"]').val(productData.name);
            $('input[name="price"]').val(productData.price);
            $('input[name="size"]').val(productData.size);
            $('select[name="status"]').val(productData.status);
            
            // Show the modal
            $('#productModal').modal('show');
        });


        // Handle product form submission
        $('#productForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const productId = formData.get('product_id');
            
            // Determine if this is an edit or add operation
            if (productId && productId !== '') {
                formData.append('action', 'edit');
                formData.append('productId', productId); // Backend expects 'productId'
                formData.append('cost', '0'); // Add default cost
                formData.append('boxes', '1'); // Add default boxes
                formData.append('units_per_box', '1'); // Add default units per box
                formData.append('supplier', ''); // Add default supplier
            } else {
                formData.append('action', 'add');
            }
            
            $.ajax({
                url: "{% url 'handle_product_post' %}",
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('#productModal').modal('hide');
                        showAlert(response.message, 'success');
                        loadProducts(); // Refresh the table
                        // Reset form
                        document.getElementById('productForm').reset();
                        $('input[name="product_id"]').val(''); // Clear product ID
                    } else {
                        showAlert(response.message, 'danger');
                    }
                },
                error: function() {
                    showAlert('Failed to save product', 'danger');
                }
            });
        });

        // Remove legacy add-product modal wiring in favor of unified modal above

        // Function to show alerts
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            // Remove existing alerts
            $('.alert').remove();
            
            // Add new alert at the top of the content area
            $('.content-area').prepend(alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
    <script>
  $(document).ready(function() {
      // Calculate VAT-inclusive price (12%) dynamically
      $('#priceInput').on('input', function() {
          const price = parseFloat($(this).val()) || 0;
          const vatPrice = price * 1.12;
          $('#vatInclusive').text(formatCurrency(vatPrice));
      });
  });
    </script>

    <!-- Legacy duplicate Product Modal removed to prevent ID conflicts -->

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutConfirmModal" tabindex="-1" aria-labelledby="logoutConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutConfirmModalLabel">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                        Confirm Logout
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to logout?</p>
                    <p class="text-muted small mb-0">You will need to login again to access the system.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a href="{% url 'logout' %}" class="btn btn-danger">
                        <i class="bi bi-box-arrow-right me-1"></i>
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fallback: define enhanceMobileTables locally if not provided by base template
        if (!window.enhanceMobileTables) {
            window.enhanceMobileTables = function() {
                try {
                    var isMobile = window.matchMedia('(max-width: 768px)').matches;
                    if (!isMobile) return;
                    document.querySelectorAll('table.table-mobile-card').forEach(function(table) {
                        var headerCells = table.querySelectorAll('thead th');
                        if (!headerCells || headerCells.length === 0) return;
                        var labels = Array.from(headerCells).map(function(th){ return (th.textContent||'').trim(); });
                        table.querySelectorAll('tbody tr').forEach(function(row){
                            row.querySelectorAll('td').forEach(function(td, idx){
                                if (!td.hasAttribute('data-label') && labels[idx]) td.setAttribute('data-label', labels[idx]);
                            });
                        });
                    });
                } catch(e) { /* no-op */ }
            };
            window.addEventListener('resize', window.enhanceMobileTables);
            window.addEventListener('orientationchange', window.enhanceMobileTables);
        }
    </script>
    <script>
        function renderProductsTableForPage(data, tableId){
            const $tbody = $(`#${tableId} tbody`).empty();
            if(!data || !data.length){
                $tbody.append('<tr><td colspan="8" class="text-center text-muted py-4">No product yet</td></tr>');
                invUpdateControls(0, tableId);
                if (window.enhanceMobileTables) { window.enhanceMobileTables(); }
                return;
            }
            const page = invPagination.currentPage[tableId] || 1;
            const rows = invSlice(data, page);
            rows.forEach((product)=>{
                const row = $('<tr>');
                row.append(`<td>${product.product_id}</td>`);
                let productName = product.name; let variant = product.variant || '-';
                const m = productName && productName.match(/^(.+?)\s*\(([^)]+)\)$/);
                if(m){ productName = m[1].trim(); variant = m[2].trim(); }
                row.append(`<td>${productName}</td>`);
                row.append(`<td>${variant}</td>`);
                row.append(`<td>${product.size||''}</td>`);
                row.append(`<td>${formatCurrency(product.price)}</td>`);
                const stockClass = product.stock <= 10 ? 'text-danger' : product.stock <= 30 ? 'text-warning' : 'text-success';
                const stockValue = parseInt(product.stock)||0;
                row.append(`<td><i class="bi bi-circle-fill ${stockClass} me-1" style="font-size: .5rem"></i><a href="/stock_details/?product_id=${product.product_id}" class="stock-link" title="View Stock Details"><i class="bi bi-eye"></i> ${stockValue}</a></td>`);
                const statusLower = (product.status || '').toLowerCase();
                const statusBadgeClass = statusLower === 'active' ? 'bg-success' : 'bg-danger';
                const statusDisplay = product.status || 'N/A';
                row.append(`<td><span class="badge ${statusBadgeClass}">${statusDisplay}</span></td>`);
                let optionsHtml = `
                    <div class="dropdown">
                        <button class="btn btn-sm btn-icon dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="More options">
                            <i class="bi bi-three-dots-vertical"></i>
                            <span class="visually-hidden">More options for ${product.name}</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item edit-btn" data-id="${product.product_id}" title="Edit this product"><i class="bi bi-pencil me-2"></i> Edit</button></li>
                            <li><button class="dropdown-item discontinue-btn ${product.status==='Discontinued'?'continue-btn':''}" data-id="${product.product_id}" data-status="${product.status}" title="${product.status==='Discontinued'?'Continue this product':'Discontinue this product'}"><i class="bi bi-${product.status==='Discontinued'?'arrow-counterclockwise':'x-circle'} me-2"></i> ${product.status==='Discontinued'?'Continue':'Discontinue'}</button></li>
                        </ul>
                    </div>`;
                row.append(`<td>${optionsHtml}</td>`);
                $tbody.append(row);
            });
            invUpdateControls(data.length, tableId);
            if (window.enhanceMobileTables) { window.enhanceMobileTables(); }
        }

        document.addEventListener('DOMContentLoaded', function(){ if (window.enhanceMobileTables) { window.enhanceMobileTables(); } });
    </script>
    <script>
        // Sanitize Product Modal inputs
        (function(){
            const nameInput = document.getElementById('productName');
            const sizeInput = document.getElementById('productSize');
            const unitSelectInline = document.getElementById('quantityUnit');
            const unitSelectModal = document.getElementById('productSizeUnit');
            if(nameInput){
                nameInput.addEventListener('input', function(){
                    const cleaned = this.value.replace(/[^A-Za-z\s\-]/g, '');
                    if (cleaned !== this.value) this.value = cleaned;
                });
                nameInput.addEventListener('blur', function(){
                    const title = this.value.toLowerCase().replace(/\s+/g,' ').replace(/\b[a-z]/g, ch=>ch.toUpperCase()).trim();
                    if (title) this.value = title;
                });
            }
            if(sizeInput){
                sizeInput.addEventListener('input', function(){
                    const cleaned = this.value.replace(/[^0-9.]/g, '');
                    if (cleaned !== this.value) this.value = cleaned;
                });
            }
            // Adjust placeholders depending on unit selection
            function applyModalUnitBehavior() {
                if (!sizeInput || !unitSelectModal) return;
                const unit = (unitSelectModal.value || 'box').toLowerCase();
                if (unit === 'kilo') {
                    sizeInput.value = '';
                    sizeInput.setAttribute('placeholder', 'Kilo');
                    sizeInput.disabled = true;
                } else {
                    sizeInput.disabled = false;
                    sizeInput.setAttribute('placeholder', 'Enter quantity');
                }
            }
            if (unitSelectModal) {
                unitSelectModal.addEventListener('change', applyModalUnitBehavior);
                applyModalUnitBehavior();
            }
            if (unitSelectInline) {
                unitSelectInline.addEventListener('change', function(){
                    const unit = (unitSelectInline.value || 'box').toLowerCase();
                    const sizeField = document.getElementById('size');
                    if (sizeField) {
                        if (unit === 'kilo') {
                            sizeField.value = '';
                            sizeField.setAttribute('placeholder', 'Kilo');
                            sizeField.disabled = true;
                        } else {
                            sizeField.disabled = false;
                            sizeField.setAttribute('placeholder', 'Enter quantity');
                        }
                    }
                });
                // initial
                const sizeField = document.getElementById('size');
                if (sizeField) {
                    if ((unitSelectInline.value || 'box').toLowerCase() === 'kilo') {
                        sizeField.value = '';
                        sizeField.setAttribute('placeholder', 'Kilo');
                        sizeField.disabled = true;
                    } else {
                        sizeField.disabled = false;
                        sizeField.setAttribute('placeholder', 'Enter quantity');
                    }
                }
            }
            // Supplier fields in add-stock blocks
            document.addEventListener('input', function(e){
                if (e.target && e.target.classList.contains('stock-supplier')){
                    const cleaned = e.target.value.replace(/[^A-Za-z\s\-.,&]/g,'');
                    if (cleaned !== e.target.value) e.target.value = cleaned;
                }
            });
        })();
    </script>
</body>
</html>