<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockWise QR Test</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e8;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            background-color: #ffeaea;
            border-left: 4px solid #f44336;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ StockWise QR Scanner Test</h1>
        
        <div class="info">
            <h3>ðŸ“± Mobile Access URLs:</h3>
            <p><strong>Local Network:</strong> <a href="http://172.20.10.4:8000" target="_blank">http://172.20.10.4:8000</a></p>
            <p><strong>ngrok HTTPS:</strong> <a href="https://f60403338b9b.ngrok-free.app" target="_blank">https://f60403338b9b.ngrok-free.app</a></p>
            <p><em>Note: If ngrok doesn't work, use the local network URL</em></p>
        </div>

        <div id="qr-reader"></div>
        <div id="qr-reader-results"></div>
        
        <div style="text-align: center;">
            <button onclick="startScanner()">Start QR Scanner</button>
            <button onclick="stopScanner()">Stop Scanner</button>
        </div>
    </div>

    <script>
        let html5QrcodeScanner = null;

        function startScanner() {
            if (!window.Html5Qrcode) {
                document.getElementById('qr-reader-results').innerHTML = 
                    '<div class="result error">QR scanner library not loaded. Please check your internet connection.</div>';
                return;
            }

            document.getElementById('qr-reader-results').innerHTML = 
                '<div class="result">Requesting camera permission...</div>';

            // Use Html5Qrcode directly - it will request permission
            startQRScannerDirect();
        }

        function startQRScannerDirect() {
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            // Try back camera first (environment)
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                config,
                (decodedText, decodedResult) => {
                    document.getElementById('qr-reader-results').innerHTML = 
                        `<div class="result">
                            <strong>âœ… QR Code Detected!</strong><br>
                            <strong>Content:</strong> ${decodedText}<br>
                            <strong>Time:</strong> ${new Date().toLocaleTimeString()}
                        </div>`;
                    stopScanner();
                },
                (errorMessage) => {
                    // Handle scan errors silently
                }
            ).catch(err => {
                console.log("Back camera failed, trying front camera:", err);
                // Try front camera if back camera fails
                html5QrcodeScanner.start(
                    { facingMode: "user" },
                    config,
                    (decodedText, decodedResult) => {
                        document.getElementById('qr-reader-results').innerHTML = 
                            `<div class="result">
                                <strong>âœ… QR Code Detected!</strong><br>
                                <strong>Content:</strong> ${decodedText}<br>
                                <strong>Time:</strong> ${new Date().toLocaleTimeString()}
                            </div>`;
                        stopScanner();
                    },
                    (errorMessage) => {
                        // Handle scan errors silently
                    }
                ).catch(err2 => {
                    console.log("All cameras failed:", err2);
                    document.getElementById('qr-reader-results').innerHTML = 
                        `<div class="result error">
                            <strong>Camera Access Failed</strong><br>
                            Error: ${err2.message || 'Unknown error'}<br>
                            <button onclick="startScanner()">Try Again</button>
                        </div>`;
                });
            });
        }

        function startQRScanner() {
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            const cameraConfigs = [
                { facingMode: "environment" }, // Back camera
                { facingMode: "user" },         // Front camera
                "auto"
            ];

            let cameraIndex = 0;

            function tryNextCamera() {
                if (cameraIndex >= cameraConfigs.length) {
                    document.getElementById('qr-reader-results').innerHTML = 
                        '<div class="result error">Unable to access camera. Please ensure camera permissions are granted.<br><button onclick="startScanner()">Try Again</button></div>';
                    return;
                }

                html5QrcodeScanner.start(
                    cameraConfigs[cameraIndex],
                    config,
                    (decodedText, decodedResult) => {
                        document.getElementById('qr-reader-results').innerHTML = 
                            `<div class="result">
                                <strong>âœ… QR Code Detected!</strong><br>
                                <strong>Content:</strong> ${decodedText}<br>
                                <strong>Time:</strong> ${new Date().toLocaleTimeString()}
                            </div>`;
                        stopScanner();
                    },
                    (errorMessage) => {
                        // Handle scan errors silently
                    }
                ).catch(err => {
                    console.log(`Camera ${cameraIndex} failed:`, err);
                    cameraIndex++;
                    tryNextCamera();
                });
            }

            tryNextCamera();
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                }).catch(err => {
                    console.log("Error stopping scanner:", err);
                });
                html5QrcodeScanner = null;
            }
        }

        // Auto-start scanner when page loads
        window.onload = function() {
            startScanner();
        };
    </script>
</body>
</html>