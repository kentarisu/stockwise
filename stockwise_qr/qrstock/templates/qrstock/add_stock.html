<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="StockWise">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>StockWise - Add Stock via QR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        
        .page-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem 0;
        }
        
        .card-modern {
            width: 100%;
            max-width: 500px;
            background: #fff;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }
        
        .card-header-modern {
            background: #f3f4f6;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .product-info {
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
        }
        
        .info-label {
            font-weight: 500;
            color: #6b7280;
        }
        
        .info-value {
            font-weight: 600;
            color: #1f2937;
        }
        
        .batch-id {
            background: #fef3c7;
            color: #92400e;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .instruction-text {
            background: #eff6ff;
            color: #1e40af;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            text-align: center;
            margin-top: 1rem;
        }
        
        .loading-spinner {
            display: none;
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        .btn.loading .loading-spinner {
            display: inline-block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 8px;
        }
        
        .alert-success {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #22c55e;
        }
        
        .alert-danger {
            background: #fef2f2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body>
  <div class="page-container">
    <div class="card-modern">
      <div class="card-header-modern">
        <h5 class="m-0 text-dark">
          <i class="bi bi-plus-circle me-2"></i>Add Stock via QR
        </h5>
        <div class="d-flex align-items-center">
          <span class="badge bg-success me-2">
            <i class="bi bi-check-circle me-1"></i>QR Verified
          </span>
          {% if app_username %}
          <span class="badge bg-primary">
            <i class="bi bi-person me-1"></i>{{ app_username }} ({{ app_role }})
          </span>
          {% endif %}
        </div>
      </div>

      <div class="p-3">
        <!-- Product Information -->
        <div class="product-info">
          <div class="info-row">
            <span class="info-label">Product:</span>
            <span class="info-value">{{ product.name }}</span>
          </div>
          {% if product.size %}
          <div class="info-row">
            <span class="info-label">Size:</span>
            <span class="info-value">{{ product.size }}</span>
          </div>
          {% endif %}
          <div class="info-row">
            <span class="info-label">Date Arrived:</span>
            <span class="info-value">{{ delivery_date|date:"M. d, Y" }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Batch ID:</span>
            <span class="info-value">
              <code class="batch-id" id="batchIdDisplay">{{ batch_id }}</code>
            </span>
          </div>
        </div>

        <!-- Form -->
        <form id="addStockForm" method="post">
          {% csrf_token %}
          
          <!-- Quantity Input -->
          <div class="mb-3">
            <label for="quantity" class="form-label">
              <i class="bi bi-box-seam me-1"></i>Quantity to Add
            </label>
            <input 
              type="number" 
              id="quantity" 
              name="quantity" 
              class="form-control" 
              min="1" 
              required 
              placeholder="Enter number of boxes"
            >
          </div>

          <!-- Supplier Input -->
          <div class="mb-4">
            <label for="supplier" class="form-label">
              <i class="bi bi-building me-1"></i>Supplier Name 
              <span class="text-muted">(optional)</span>
            </label>
            <input 
              type="text" 
              id="supplier" 
              name="supplier" 
              class="form-control" 
              placeholder="Enter supplier name if available"
            >
          </div>

          <!-- Submit Button -->
          <div class="d-grid">
            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
              <span class="loading-spinner"></span>
              <i class="bi bi-plus-circle me-2"></i>
              <span class="btn-text">Add Stock</span>
            </button>
          </div>
        </form>

        <!-- Message Area -->
        <div id="messageArea"></div>

        <!-- Instruction Text -->
        <div class="instruction-text">
          <i class="bi bi-info-circle me-1"></i>
          This will add stock to the specific batch using FIFO inventory management.
        </div>
      </div>
    </div>
  </div>

  <script>
    // Dynamic batch ID generation with proper sequence continuation
    const batchIdDisplay = document.getElementById('batchIdDisplay');
    const quantityInput = document.getElementById('quantity');

    async function updateBatchId() {
      const quantity = parseInt(quantityInput.value) || 0;
      if (quantity > 0) {
        try {
          // Get the actual next sequence from the server
          const response = await fetch('/qr/next-batch-sequence/{{ product.product_id }}/', {
            method: 'GET',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
            }
          });
          const data = await response.json();
          if (data.success) {
            const nextSeq = data.next_sequence;
            const baseBatchId = data.base_batch_id;
            
            if (quantity === 1) {
              // Single box: AF125-1380923202516
              const batchId = baseBatchId + nextSeq.toString().padStart(2, '0');
              batchIdDisplay.textContent = batchId;
            } else {
              // Multiple boxes: AF125-1380923202516 to AF125-1380923202525
              const startBatchId = baseBatchId + nextSeq.toString().padStart(2, '0');
              const endSeq = nextSeq + quantity - 1;
              const endBatchId = baseBatchId + endSeq.toString().padStart(2, '0');
              batchIdDisplay.textContent = startBatchId + ' to ' + endBatchId;
            }
          } else {
            batchIdDisplay.textContent = 'Error calculating batch ID';
          }
        } catch (error) {
          console.error('Error fetching batch sequence:', error);
          batchIdDisplay.textContent = 'Error calculating batch ID';
        }
      } else {
        // Show default with XX placeholder when no quantity
        batchIdDisplay.textContent = '{{ batch_id }}';
      }
    }

    // Update batch ID when quantity changes
    quantityInput.addEventListener('input', updateBatchId);

    async function handleAddStock(e) {
      e.preventDefault();
      
      const form = document.getElementById('addStockForm');
      const button = document.getElementById('submitBtn');
      const messageArea = document.getElementById('messageArea');
      const btnText = button.querySelector('.btn-text');
      
      // Clear previous messages
      messageArea.innerHTML = '';
      
      // Show loading state
      button.classList.add('loading');
      button.disabled = true;
      btnText.textContent = 'Adding Stock...';
      
      try {
        const formData = new FormData(form);
        
        // Get CSRF token from cookie
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        const response = await fetch(window.location.href, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': csrftoken,
          },
        });
        
        const data = await response.json();
        
        if (data.success) {
          messageArea.innerHTML = `
            <div class="alert alert-success">
              <i class="bi bi-check-circle me-2"></i>
              <strong>Success!</strong> Stock added successfully to inventory.
              <br><small>Batch ID: ${data.batch_id}</small>
            </div>
          `;
          
          // Reset form after success
          form.reset();
          
          // Change button to show success
          btnText.innerHTML = '<i class="bi bi-check-circle me-2"></i>Stock Added!';
          button.classList.remove('btn-success');
          button.classList.add('btn-outline-success');
          
        } else {
          messageArea.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Error:</strong> ${data.message || 'Failed to add stock. Please try again.'}
            </div>
          `;
          
          // Reset button state
          button.classList.remove('loading');
          button.disabled = false;
          btnText.textContent = 'Add Stock';
        }
        
      } catch (error) {
        messageArea.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Network Error:</strong> Please check your connection and try again.
          </div>
        `;
        
        // Reset button state
        button.classList.remove('loading');
        button.disabled = false;
        btnText.textContent = 'Add Stock';
      }
    }

    // Add event listener
    document.getElementById('addStockForm').addEventListener('submit', handleAddStock);
    
    // Focus on quantity input when page loads
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('quantity').focus();
    });
  </script>
</body>
</html>
