{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockWise - Reports & Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/modern-inventory.css' %}">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #f8fafc;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --sidebar-width: 280px;
            --header-height: 80px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Same as other pages */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            color: white;
        }

        .sidebar-brand i {
            font-size: 2rem;
            margin-right: 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            border-radius: 12px;
        }

        .sidebar-nav {
            padding: 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-400);
            padding: 0 1.5rem;
            margin-bottom: 0.75rem;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: 0;
            font-weight: 500;
            position: relative;
        }

        .nav-link:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-link.active {
            color: var(--primary);
            background: var(--primary-light);
            border-right: 3px solid var(--primary);
        }

        .nav-link i {
            font-size: 1.25rem;
            margin-right: 0.75rem;
            width: 1.5rem;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: var(--gray-50);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            height: var(--header-height);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-left h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        .header-subtitle {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            border: 2px solid var(--primary-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-avatar:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        /* Content Area */
        .content-area {
            padding: 2rem;
        }

        /* Report Filters */
        .filters-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            margin-bottom: 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control, .form-select {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        /* Inventory Reports Section */
        .inventory-reports-section {
            margin-bottom: 3rem;
            display: none; /* Hidden for now */
        }

        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .section-header h3 {
            color: var(--gray-800);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .section-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-item {
            background: white;
            border: 2px solid var(--gray-100);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .report-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .report-item.comprehensive {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%);
            border-color: var(--primary);
        }

        .report-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.75rem;
            color: white;
            box-shadow: var(--shadow-md);
        }

        .stock-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .movement-icon { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .batch-icon { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .turnover-icon { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .supplier-icon { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .comprehensive-icon { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }

        .report-content h6 {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .report-content p {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .report-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-report {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            flex: 1;
            justify-content: center;
            text-decoration: none;
        }

        .btn-report:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-report.view {
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn-report.view:hover {
            background: var(--primary);
            color: white;
        }

        .btn-report.pdf {
            color: var(--danger);
            border-color: var(--danger);
        }

        .btn-report.pdf:hover {
            background: var(--danger);
            color: white;
        }

        .btn-report.comprehensive-btn {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: 700;
        }

        .btn-report.comprehensive-btn:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-2px) scale(1.02);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.primary::before { background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .stat-card.success::before { background: linear-gradient(90deg, var(--success), #059669); }
        .stat-card.warning::before { background: linear-gradient(90deg, var(--warning), #d97706); }
        .stat-card.danger::before { background: linear-gradient(90deg, var(--danger), #dc2626); }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-icon.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .stat-icon.success { background: linear-gradient(135deg, var(--success), #059669); }
        .stat-icon.warning { background: linear-gradient(135deg, var(--warning), #d97706); }
        .stat-icon.danger { background: linear-gradient(135deg, var(--danger), #dc2626); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
        }

        .stat-label {
            color: var(--gray-500);
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        /* Enhanced Chart Styling */
        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .chart-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }

        .chart-subtitle {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            margin-bottom: 0;
        }

        /* Professional Stats Cards */
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 16px 16px 0 0;
        }

        .stat-card.primary::before { background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .stat-card.success::before { background: linear-gradient(90deg, var(--success), #059669); }
        .stat-card.warning::before { background: linear-gradient(90deg, var(--warning), #d97706); }
        .stat-card.danger::before { background: linear-gradient(90deg, var(--danger), #dc2626); }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-icon.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .stat-icon.success { background: linear-gradient(135deg, var(--success), #059669); }
        .stat-icon.warning { background: linear-gradient(135deg, var(--warning), #d97706); }
        .stat-icon.danger { background: linear-gradient(135deg, var(--danger), #dc2626); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
        }

        .stat-label {
            color: var(--gray-500);
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        /* Professional Filters */
        .filters-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            margin-bottom: 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control, .form-select {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        /* Professional Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-modern.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-modern.success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-modern.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-modern.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        /* Professional Tab Styling */
        .nav-tabs {
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 0;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 0;
            color: var(--gray-600);
            font-weight: 500;
            padding: 1rem 1.5rem;
            transition: all 0.2s ease;
            background: transparent;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            background: var(--primary-light);
            border-bottom-color: var(--primary-light);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background: var(--primary-light);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .nav-tabs .nav-link i {
            font-size: 1rem;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 16px 16px;
        }

        .tab-pane {
            padding: 0;
        }

        /* Enhanced Table Styling */
        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
            font-weight: 600;
            color: var(--gray-700);
            padding: 1rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .table tbody td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
            font-weight: 500;
        }

        .table tbody tr:hover {
            background: var(--gray-50);
        }

        /* Chart Preview Styling */
        .chart-previews {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chart-preview-item {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .chart-preview-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .preview-header h5 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .preview-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .preview-chart {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .preview-description {
            margin: 0;
            font-size: 0.8rem;
            color: var(--gray-600);
            text-align: center;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-modern.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-modern.success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-modern.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 0 1rem;
            }

            /* Mobile menu toggle button - SHOW ON MOBILE */
            #mobileMenuToggle {
                display: flex !important;
                background: #007bff !important;
                border: 2px solid #000000 !important;
                color: #ffffff !important;
                min-width: 44px !important;
                min-height: 44px !important;
                position: relative !important;
                z-index: 9999 !important;
            }

            .content-area {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Desktop - Hide mobile menu button */
        @media (min-width: 769px) {
            #mobileMenuToggle {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="{% url 'dashboard' %}" class="sidebar-brand">
                    <i class="bi bi-basket-fill"></i>
                    StockWise
                </a>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item">
                        <a href="{% url 'dashboard' %}" class="nav-link">
                            <i class="bi bi-speedometer2"></i>
                            Dashboard
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="{% url 'products_inventory' %}" class="nav-link">
                            <i class="bi bi-basket"></i>
                            Inventory
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="{% url 'sales' %}" class="nav-link">
                            <i class="bi bi-cart"></i>
                            Sales
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Analytics</div>
                    <div class="nav-item">
                        <a href="{% url 'reports' %}" class="nav-link active">
                            <i class="bi bi-graph-up"></i>
                            Reports
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <div class="nav-item">
                        <a href="{% url 'profile' %}" class="nav-link">
                            <i class="bi bi-person"></i>
                            Profile
                        </a>
                    </div>
                    {% if app_role == 'admin' %}
                    <div class="nav-item">
                        <a href="{% url 'sms_settings' %}" class="nav-link">
                            <i class="bi bi-chat-dots"></i>
                            SMS Settings
                        </a>
                    </div>
                    {% endif %}
                    <div class="nav-item">
                        <a href="{% url 'logout' %}" class="nav-link">
                            <i class="bi bi-box-arrow-right"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1>Reports & Analytics</h1>
                    <p class="header-subtitle">Comprehensive business insights and analytics</p>
                </div>
                <div class="header-right">
                    <!-- Mobile Menu Toggle Button -->
                    <button id="mobileMenuToggle" class="btn btn-outline-secondary btn-sm me-3 mobile-menu-btn" style="min-width: 44px; min-height: 44px; display: flex !important; align-items: center; justify-content: center; background: #007bff !important; border: 2px solid #000000 !important; color: #ffffff !important; position: relative; z-index: 9999;">
                        <i class="bi bi-list" style="font-size: 1.2rem;"></i>
                        <span class="ms-1">Menu</span>
                    </button>

                    <div class="dropdown">
                        <img src="https://via.placeholder.com/40" alt="User" class="user-avatar" data-bs-toggle="dropdown">
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Report Filters -->
                <div class="filters-card">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="dateRange">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group d-none">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="form-group d-none">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-modern primary" id="generateReport">
                                <i class="bi bi-bar-chart"></i>
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Export Actions -->
                <div class="action-buttons">
                    <button type="button" class="btn-modern success" id="exportPDF">
                        <i class="bi bi-file-earmark-pdf"></i>
                        Export PDF
                    </button>
                    <button type="button" class="btn-modern warning" id="exportExcel">
                        <i class="bi bi-file-earmark-excel"></i>
                        Export Excel
                    </button>
                    <button type="button" class="btn-modern primary" onclick="window.print()">
                        <i class="bi bi-printer"></i>
                        Print Report
                    </button>
                </div>

                <!-- Inventory Reports Section -->
                <div class="inventory-reports-section">
                    <div class="section-header">
                        <h3><i class="bi bi-file-earmark-bar-graph me-2"></i>Inventory Reports</h3>
                        <p class="section-subtitle">Comprehensive inventory analysis and insights</p>
                    </div>
                    
                    <div class="reports-grid">
                        <!-- Stock Snapshot Report -->
                        <div class="report-item">
                            <div class="report-icon stock-icon">
                                <i class="bi bi-clipboard-data"></i>
                            </div>
                            <div class="report-content">
                                <h6>Stock Snapshot</h6>
                                <p>Current stock levels, values, and low stock alerts</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('stock')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('stock')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Movement Report -->
                        <div class="report-item">
                            <div class="report-icon movement-icon">
                                <i class="bi bi-arrow-left-right"></i>
                            </div>
                            <div class="report-content">
                                <h6>Stock Movement</h6>
                                <p>Stock additions and sales history with FIFO tracking</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('movement')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('movement')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Batch Report -->
                        <div class="report-item">
                            <div class="report-icon batch-icon">
                                <i class="bi bi-layers"></i>
                            </div>
                            <div class="report-content">
                                <h6>Active Batches</h6>
                                <p>Individual batch tracking, aging analysis, and expiry alerts</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('batches')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('batches')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Turnover Report -->
                        <div class="report-item">
                            <div class="report-icon turnover-icon">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            <div class="report-content">
                                <h6>Inventory Turnover</h6>
                                <p>Sales velocity, days of cover, and stock optimization</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('turnover')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('turnover')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Supplier Report -->
                        <div class="report-item">
                            <div class="report-icon supplier-icon">
                                <i class="bi bi-truck"></i>
                            </div>
                            <div class="report-content">
                                <h6>Supplier Analysis</h6>
                                <p>Supplier performance, delivery frequency, and reliability</p>
                                <div class="report-actions">
                                    <button class="btn-report view" onclick="viewInventoryReport('suppliers')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn-report pdf" onclick="downloadInventoryPDF('suppliers')">
                                        <i class="bi bi-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Comprehensive PDF -->
                        <div class="report-item comprehensive">
                            <div class="report-icon comprehensive-icon">
                                <i class="bi bi-file-earmark-text"></i>
                            </div>
                            <div class="report-content">
                                <h6>Complete Inventory Report</h6>
                                <p>All reports combined in a comprehensive PDF document</p>
                                <div class="report-actions">
                                    <button class="btn-report pdf comprehensive-btn" onclick="downloadInventoryPDF('comprehensive')">
                                        <i class="bi bi-download"></i> Download Complete PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Stats -->
                <div class="stats-grid">
                    <div class="stat-card success">
                        <div class="stat-icon success">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div class="stat-value" id="statTotalRevenue">₱0.00</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-icon primary">
                            <i class="bi bi-cart-check"></i>
                        </div>
                        <div class="stat-value" id="statTransactions">0</div>
                        <div class="stat-label">Total Transactions</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon warning">
                            <i class="bi bi-boxes"></i>
                        </div>
                        <div class="stat-value" id="statItemsSold">0</div>
                        <div class="stat-label">Items Sold</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-icon danger">
                            <i class="bi bi-graph-up"></i>
                        </div>
                        <div class="stat-value" id="statAvgOrder">₱0.00</div>
                        <div class="stat-label">Average Sale</div>
                    </div>
                </div>

                <!-- Custom Date Range Modal -->
                <div class="modal fade" id="customRangeModal" tabindex="-1" aria-labelledby="customRangeModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="customRangeModalLabel">Select Custom Date Range</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customStart" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="customStart">
                                </div>
                                <div class="mb-3">
                                    <label for="customEnd" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="customEnd">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="applyCustomRange">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>

                

                <!-- Main Content Layout -->
                <div class="row">
                    <!-- Left Side - Tabbed Data Section -->
                    <div class="col-lg-8">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Detailed Reports</h3>
                                <p class="chart-subtitle">Comprehensive data analysis and insights</p>
                            </div>
                            
                            <!-- Tab Navigation -->
                            <ul class="nav nav-tabs" id="reportsTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab" aria-controls="sales" aria-selected="true">
                                        <i class="bi bi-graph-up me-2"></i>Sales Summary
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">
                                        <i class="bi bi-star me-2"></i>Top Products
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab" aria-controls="inventory" aria-selected="false">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Low Stock
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab" aria-controls="transactions" aria-selected="false">
                                        <i class="bi bi-receipt me-2"></i>Transactions
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab" aria-controls="analytics" aria-selected="false">
                                        <i class="bi bi-bar-chart me-2"></i>Product Analytics
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="inventory-analytics-tab" data-bs-toggle="tab" data-bs-target="#inventory-analytics" type="button" role="tab" aria-controls="inventory-analytics" aria-selected="false">
                                        <i class="bi bi-boxes me-2"></i>Inventory Insights
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="reportsTabContent">
                                <!-- Sales Summary Tab -->
                                <div class="tab-pane fade show active" id="sales" role="tabpanel" aria-labelledby="sales-tab">
                                    <div class="table-responsive mt-3">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Quantity Sold</th>
                                                    <th>Revenue</th>
                                                    <th>Profit</th>
                                                    <th>Growth</th>
                                                </tr>
                                            </thead>
                                            <tbody id="summaryBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Top Products Tab -->
                                <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                                    <div class="table-responsive mt-3">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Size</th>
                                                    <th>Boxes Sold</th>
                                                    <th>Revenue</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Low Stock Tab -->
                                <div class="tab-pane fade" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
                                    <div class="table-responsive mt-3">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Size</th>
                                                    <th>Stock</th>
                                                    <th>Price</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="lowBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Transactions Tab -->
                                <div class="tab-pane fade" id="transactions" role="tabpanel" aria-labelledby="transactions-tab">
                                    <div class="table-responsive mt-3">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Sale #</th>
                                                    <th>Date</th>
                                                    <th>Products</th>
                                                    <th>Sizes</th>
                                                    <th>Boxes</th>
                                                    <th>Total</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="txBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Product Analytics Tab -->
                                <div class="tab-pane fade" id="analytics" role="tabpanel" aria-labelledby="analytics-tab">
                                    <div class="table-responsive mt-3">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Period</th>
                                                    <th>Opening Qty</th>
                                                    <th>Added Qty</th>
                                                    <th>Sold Qty</th>
                                                    <th>Closing Qty</th>
                                                    <th>Revenue</th>
                                                    <th>COGS</th>
                                                    <th>Gross Profit</th>
                                                    <th>Margin %</th>
                                                    <th>Sell Through %</th>
                                                    <th>Avg Daily Sales</th>
                                                    <th>Days Cover</th>
                                                    <th>Low Stock</th>
                                                    <th>Price Action</th>
                                                    <th>Demand Level</th>
                                                </tr>
                                            </thead>
                                            <tbody id="summaryReportsBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Inventory Analytics Tab -->
                                <div class="tab-pane fade" id="inventory-analytics" role="tabpanel" aria-labelledby="inventory-analytics-tab">
                                    <div class="table-responsive mt-3">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Last Price</th>
                                                    <th>Suggested Price</th>
                                                    <th>Price Action</th>
                                                    <th>Demand Level</th>
                                                    <th>First Sale</th>
                                                    <th>Last Sale</th>
                                                    <th>SMS Alerts</th>
                                                    <th>Low Stock Flag</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inventoryAnalyticsBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side - Charts Overview -->
                    <div class="col-lg-4">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Visual Analytics</h3>
                                <p class="chart-subtitle">Interactive charts and graphs</p>
                            </div>
                            
                            <!-- Chart Previews -->
                            <div class="chart-previews">
                                <!-- Revenue Trend Preview -->
                                <div class="chart-preview-item">
                                    <div class="preview-header">
                                        <h5><i class="bi bi-graph-up text-primary me-2"></i>Revenue Trend</h5>
                                        <span class="preview-badge">Line Chart</span>
                                    </div>
                                    <div class="preview-chart">
                                        <canvas id="revenuePreview" width="200" height="120"></canvas>
                                    </div>
                                    <p class="preview-description">Daily revenue performance tracking</p>
                                </div>

                                <!-- Top Products Preview -->
                                <div class="chart-preview-item">
                                    <div class="preview-header">
                                        <h5><i class="bi bi-star text-warning me-2"></i>Top Products</h5>
                                        <span class="preview-badge">Bar Chart</span>
                                    </div>
                                    <div class="preview-chart">
                                        <canvas id="topProductsPreview" width="200" height="120"></canvas>
                                    </div>
                                    <p class="preview-description">Best performing products by sales</p>
                                </div>

                                <!-- Sales Distribution Preview -->
                                <div class="chart-preview-item">
                                    <div class="preview-header">
                                        <h5><i class="bi bi-pie-chart text-success me-2"></i>Sales Distribution</h5>
                                        <span class="preview-badge">Doughnut</span>
                                    </div>
                                    <div class="preview-chart">
                                        <canvas id="salesDistributionPreview" width="200" height="120"></canvas>
                                    </div>
                                    <p class="preview-description">Revenue breakdown by category</p>
                                </div>

                                <!-- Inventory Health Preview -->
                                <div class="chart-preview-item">
                                    <div class="preview-header">
                                        <h5><i class="bi bi-shield-check text-info me-2"></i>Inventory Health</h5>
                                        <span class="preview-badge">Pie Chart</span>
                                    </div>
                                    <div class="preview-chart">
                                        <canvas id="inventoryHealthPreview" width="200" height="120"></canvas>
                                    </div>
                                    <p class="preview-description">Stock levels and alerts overview</p>
                                </div>
                            </div>

                            <!-- View Charts Button -->
                            <div class="text-center mt-4">
                                <a href="{% url 'charts' %}" class="btn btn-modern primary">
                                    <i class="bi bi-bar-chart me-2"></i>View Full Charts
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/modern-inventory.js' %}"></script>
    <script>
        // High-DPI rendering for crisp charts
        if (window.Chart) {
            Chart.defaults.devicePixelRatio = Math.max(2, window.devicePixelRatio || 1);
        }
        // Initialize date inputs with current date
        const today = new Date().toISOString().split('T')[0];
        const startEl = document.getElementById('startDate');
        const endEl = document.getElementById('endDate');
        if (startEl) startEl.value = today;
        if (endEl) endEl.value = today;

        // Custom range state/labeling like Sales page
        let customStart = '';
        let customEnd = '';
        const dateRangeSelect = document.getElementById('dateRange');
        function updateRangeLabels(){
            const fmt = (d)=> new Date(d).toLocaleDateString(undefined,{month:'short',day:'numeric'});
            const todayDate = new Date();
            const weekStart = new Date(todayDate); weekStart.setDate(weekStart.getDate()-7);
            const monthStart = new Date(todayDate); monthStart.setDate(monthStart.getDate()-30);
            if(dateRangeSelect){
                const optW = dateRangeSelect.querySelector('option[value="week"]');
                const optM = dateRangeSelect.querySelector('option[value="month"]');
                const optT = dateRangeSelect.querySelector('option[value="today"]');
                const optC = dateRangeSelect.querySelector('option[value="custom"]');
                if(optT) optT.textContent = `Today (${todayDate.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'})})`;
                if(optW) optW.textContent = `This Week (${fmt(weekStart)} – ${fmt(todayDate)})`;
                if(optM) optM.textContent = `This Month (${fmt(monthStart)} – ${fmt(todayDate)})`;
                if(optC) optC.textContent = customStart ? `Custom (${fmt(customStart)} – ${fmt(customEnd||customStart)})` : 'Custom Range';
            }
        }
        updateRangeLabels();

        // Chart instances for previews only
        let revenuePreviewChart, topProductsPreviewChart, salesDistributionPreviewChart, inventoryHealthPreviewChart;

        async function loadReports() {
            const params = new URLSearchParams({
                filter: (document.getElementById('dateRange')?.value || 'today').toLowerCase(),
                start_date: startEl?.value || today,
                end_date: endEl?.value || startEl?.value || today
            });
            const res = await fetch("{% url 'fetch_reports' %}?"+params.toString());
            const json = await res.json();
            if (!json.success || !json.data) {
                // Clear UI to explicit empty state
                document.getElementById('statTotalRevenue').textContent = '₱0.00';
                document.getElementById('statTransactions').textContent = '0';
                document.getElementById('statItemsSold').textContent = '0';
                document.getElementById('statAvgOrder').textContent = '₱0.00';
                document.getElementById('summaryBody').innerHTML = '<tr><td colspan="5" class="text-center text-muted">No data for selected range.</td></tr>';
                document.getElementById('topBody').innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data for selected range.</td></tr>';
                document.getElementById('lowBody').innerHTML = '<tr><td colspan="5" class="text-center text-muted">No low stock items.</td></tr>';
                document.getElementById('txBody').innerHTML = '<tr><td colspan="7" class="text-center text-muted">No transactions found.</td></tr>';
                const srb = document.getElementById('summaryReportsBody'); if(srb) srb.innerHTML = '<tr><td colspan="16" class="text-center text-muted">No product analytics yet.</td></tr>';
                return;
            }
            const d = json.data || {};
            
            // Update stats cards
            const ss = d.sales_summary || {};
            document.getElementById('statTotalRevenue').textContent = '₱'+Number(ss.total_revenue||0).toFixed(2);
            document.getElementById('statTransactions').textContent = ss.transaction_count||0;
            document.getElementById('statItemsSold').textContent = ss.total_items_sold||0;
            document.getElementById('statAvgOrder').textContent = '₱'+Number(ss.avg_order_value||0).toFixed(2);

            // Create preview charts
            createRevenuePreviewChart(d);
            createTopProductsPreviewChart(d);
            createSalesDistributionPreviewChart(d);
            createInventoryHealthPreviewChart(d);

            // Populate data tables
            populateSummaryTable(d || {fruit_summary:[]});
            populateTopProductsTable(d || {top_fruits:[]});
            populateLowStockTable(d || {low_stock:[]});
            populateTransactionsTable(d || {transactions:[]});
            populateSummaryReportsTable(d || {summary_reports:[]});
            populateInventoryAnalyticsTable(d || {summary_reports:[]});
        }



        function populateSummaryTable(data) {
            const summaryBody = document.getElementById('summaryBody');
            const rows = (data.fruit_summary||[]);
            if(!rows.length){ summaryBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No data for selected range.</td></tr>'; return; }
            summaryBody.innerHTML = rows.map(r => `
                <tr>
                    <td><strong>${r.name}</strong></td>
                    <td><span class="badge bg-primary">${r.boxes_sold ?? 0}</span></td>
                    <td><strong class="text-success">₱${Number(r.revenue||0).toFixed(2)}</strong></td>
                    <td class="text-muted">—</td>
                    <td><span class="text-muted">N/A</span></td>
                </tr>
            `).join('');
        }

        function populateTopProductsTable(data) {
            const topBody = document.getElementById('topBody');
            const rows = (data.top_fruits||[]);
            if(!rows.length){ topBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data for selected range.</td></tr>'; return; }
            topBody.innerHTML = rows.map(t => `
                <tr>
                    <td><strong>${t.name}</strong></td>
                    <td><span class="badge bg-secondary">${t.size||''}</span></td>
                    <td><span class="badge bg-warning">${t.boxes_sold??0}</span></td>
                    <td><strong class="text-success">₱${Number(t.revenue||0).toFixed(2)}</strong></td>
                </tr>
            `).join('');
        }

        function populateLowStockTable(data) {
            const lowBody = document.getElementById('lowBody');
            const rows = (data.low_stock||[]);
            if(!rows.length){ lowBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No low stock items.</td></tr>'; return; }
            lowBody.innerHTML = rows.map(i => `
                <tr>
                    <td><strong>${i.name}</strong></td>
                    <td><span class="badge bg-secondary">${i.size||''}</span></td>
                    <td><span class="badge bg-danger">${i.stock??0}</span></td>
                    <td><strong>₱${Number(i.price||0).toFixed(2)}</strong></td>
                    <td><span class="badge bg-danger">Critical</span></td>
                </tr>
            `).join('');
        }

        function populateTransactionsTable(data) {
            const txBody = document.getElementById('txBody');
            const rows = (data.transactions||[]);
            if(!rows.length){ txBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No transactions found.</td></tr>'; return; }
            txBody.innerHTML = rows.map(x => `
                <tr>
                    <td><strong>#${x.sale_id}</strong></td>
                    <td><small class="text-muted">${x.recorded_at}</small></td>
                    <td>${x.fruits}</td>
                    <td><span class="badge bg-light text-dark">${x.sizes}</span></td>
                    <td><span class="badge bg-primary">${x.total_boxes}</span></td>
                    <td><strong class="text-success">₱${Number(x.total||0).toFixed(2)}</strong></td>
                    <td><span class="badge bg-success">${x.status}</span></td>
                </tr>
            `).join('');
        }

        function populateSummaryReportsTable(data) {
            const summaryReportsBody = document.getElementById('summaryReportsBody');
            const rows = (data.summary_reports||[]);
            if(!rows.length){ summaryReportsBody.innerHTML = '<tr><td colspan="16" class="text-center text-muted">No product analytics yet.</td></tr>'; return; }
            summaryReportsBody.innerHTML = rows.map(r => `
                <tr>
                    <td><strong>${r.product_name}</strong></td>
                    <td><small class="text-muted">${r.period_start} to ${r.period_end}<br>(${r.granularity})</small></td>
                    <td>${Number(r.opening_qty||0).toFixed(2)}</td>
                    <td><span class="badge bg-success">${Number(r.added_qty||0).toFixed(2)}</span></td>
                    <td><span class="badge bg-primary">${Number(r.sold_qty||0).toFixed(2)}</span></td>
                    <td>${Number(r.closing_qty||0).toFixed(2)}</td>
                    <td><strong class="text-success">₱${Number(r.revenue||0).toFixed(2)}</strong></td>
                    <td>₱${Number(r.cogs||0).toFixed(2)}</td>
                    <td><strong class="text-success">₱${Number(r.gross_profit||0).toFixed(2)}</strong></td>
                    <td><span class="badge ${r.gross_margin_pct >= 20 ? 'bg-success' : r.gross_margin_pct >= 10 ? 'bg-warning' : 'bg-danger'}">${r.gross_margin_pct ? Number(r.gross_margin_pct).toFixed(1)+'%' : 'N/A'}</span></td>
                    <td><span class="badge ${r.sell_through_pct >= 80 ? 'bg-success' : r.sell_through_pct >= 50 ? 'bg-warning' : 'bg-danger'}">${r.sell_through_pct ? Number(r.sell_through_pct).toFixed(1)+'%' : 'N/A'}</span></td>
                    <td>${r.avg_daily_sales ? Number(r.avg_daily_sales).toFixed(2) : 'N/A'}</td>
                    <td>${r.days_of_cover_end ? Number(r.days_of_cover_end).toFixed(1) : 'N/A'}</td>
                    <td><span class="badge ${r.low_stock_flag ? 'bg-danger' : 'bg-success'}">${r.low_stock_flag ? 'Yes' : 'No'}</span></td>
                    <td><span class="badge ${r.price_action === 'Increase' ? 'bg-success' : r.price_action === 'Decrease' ? 'bg-danger' : 'bg-secondary'}">${r.price_action || 'N/A'}</span></td>
                    <td><span class="badge ${r.demand_level === 'High' ? 'bg-success' : r.demand_level === 'Mid' ? 'bg-warning' : 'bg-secondary'}">${r.demand_level || 'N/A'}</span></td>
                </tr>
            `).join('');
        }

        function populateInventoryAnalyticsTable(data) {
            const inventoryAnalyticsBody = document.getElementById('inventoryAnalyticsBody');
            inventoryAnalyticsBody.innerHTML = (data.summary_reports||[]).map(r => `
                <tr>
                    <td><strong>${r.product_name}</strong></td>
                    <td><strong>₱${r.last_price ? Number(r.last_price).toFixed(2) : 'N/A'}</strong></td>
                    <td><strong class="text-primary">₱${r.suggested_price ? Number(r.suggested_price).toFixed(2) : 'N/A'}</strong></td>
                    <td><span class="badge ${r.price_action === 'Increase' ? 'bg-success' : r.price_action === 'Decrease' ? 'bg-danger' : 'bg-secondary'}">${r.price_action || 'N/A'}</span></td>
                    <td><span class="badge ${r.demand_level === 'High' ? 'bg-success' : r.demand_level === 'Mid' ? 'bg-warning' : 'bg-secondary'}">${r.demand_level || 'N/A'}</span></td>
                    <td><small class="text-muted">${r.first_sale_at || 'N/A'}</small></td>
                    <td><small class="text-muted">${r.last_sale_at || 'N/A'}</small></td>
                    <td><span class="badge bg-info">Low: ${r.sms_low_stock_count}</span> <span class="badge bg-warning">Expiry: ${r.sms_expiry_count}</span></td>
                    <td><span class="badge ${r.low_stock_flag ? 'bg-danger' : 'bg-success'}">${r.low_stock_flag ? 'Yes' : 'No'}</span></td>
                </tr>
            `).join('');
        }

        function createRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Generate sample daily data for the last 7 days
            const labels = [];
            const revenueData = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                revenueData.push(Math.random() * 5000 + 1000); // Sample data
            }

            if (revenueChart) revenueChart.destroy();
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Revenue',
                        data: revenueData,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(99, 102, 241)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₱' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createTopProductsChart(data) {
            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            const topProducts = data.top_fruits || [];
            const labels = topProducts.map(p => p.name);
            const revenueData = topProducts.map(p => p.revenue);

            if (topProductsChart) topProductsChart.destroy();
            
            topProductsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: revenueData,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)',
                            'rgb(99, 102, 241)',
                            'rgb(139, 92, 246)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₱' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createSalesDistributionChart(data) {
            const ctx = document.getElementById('salesDistributionChart').getContext('2d');
            
            const fruitSummary = data.fruit_summary || [];
            const labels = fruitSummary.map(f => f.name);
            const revenueData = fruitSummary.map(f => f.revenue);

            if (salesDistributionChart) salesDistributionChart.destroy();
            
            salesDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: revenueData,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(14, 165, 233, 0.8)'
                        ],
                        borderColor: '#fff',
                        borderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createInventoryHealthChart(data) {
            const ctx = document.getElementById('inventoryHealthChart').getContext('2d');
            
            const lowStock = data.low_stock || [];
            const healthyStock = data.fruit_summary || [];
            
            const healthyCount = healthyStock.length;
            const lowCount = lowStock.length;
            const totalCount = healthyCount + lowCount;

            if (inventoryHealthChart) inventoryHealthChart.destroy();
            
            inventoryHealthChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Healthy Stock', 'Low Stock'],
                    datasets: [{
                        data: [healthyCount, lowCount],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('generateReport').addEventListener('click', loadReports);
        dateRangeSelect?.addEventListener('change', ()=>{
            const sel = (dateRangeSelect.value||'today').toLowerCase();
            // daily/week/month set dates automatically; custom launches modal
            const todayIso = today;
            if(sel==='today'){
                startEl.value = todayIso; endEl.value = todayIso; loadReports(); updateRangeLabels();
            } else if(sel==='week'){
                const s = new Date(); s.setDate(s.getDate()-7);
                startEl.value = s.toISOString().slice(0,10); endEl.value = todayIso; loadReports(); updateRangeLabels();
            } else if(sel==='month'){
                const s = new Date(); s.setDate(s.getDate()-30);
                startEl.value = s.toISOString().slice(0,10); endEl.value = todayIso; loadReports(); updateRangeLabels();
            } else if(sel==='custom'){
                // open modal and wait for apply
                const modal = new bootstrap.Modal(document.getElementById('customRangeModal'));
                document.getElementById('customStart').value = customStart || todayIso;
                document.getElementById('customEnd').value = customEnd || (customStart || todayIso);
                modal.show();
            }
        });

        document.addEventListener('click', (e)=>{
            if(e.target && e.target.id==='applyCustomRange'){
                const s = document.getElementById('customStart').value;
                const eDate = document.getElementById('customEnd').value;
                if(!s || !eDate) return;
                const sNorm = s <= eDate ? s : eDate;
                const eNorm = eDate >= s ? eDate : s;
                customStart = sNorm; customEnd = eNorm;
                startEl.value = customStart; endEl.value = customEnd;
                updateRangeLabels();
                loadReports();
                const m = bootstrap.Modal.getInstance(document.getElementById('customRangeModal')); if(m) m.hide();
            }
        });

        document.getElementById('exportPDF').addEventListener('click', async function() {
            const form = new FormData();
            form.append('report_type','transactions');
            form.append('filter', dateRangeSelect?.value || 'today');
            form.append('start_date', startEl?.value || '');
            form.append('end_date', endEl?.value || '');
            try{
                const resp = await fetch("{% url 'export_report' %}", { method:'POST', body: form, headers: { 'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '' }});
                const blob = await resp.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'report.pdf'; a.click();
                window.URL.revokeObjectURL(url);
            }catch(e){ console.error('PDF export failed', e); }
        });

        document.getElementById('exportExcel').addEventListener('click', function() {
            const form = new FormData();
            form.append('report_type','transactions');
            form.append('filter', document.getElementById('dateRange')?.value || 'Daily');
            form.append('start_date', document.getElementById('startDate')?.value || '');
            form.append('end_date', document.getElementById('endDate')?.value || '');
            fetch("{% url 'export_report' %}", { method:'POST', body: form, headers: { 'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '' }})
                .then(resp => resp.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'transactions_report.csv'; a.click();
                    window.URL.revokeObjectURL(url);
                });
        });

        // Preview Chart Functions
        function createRevenuePreviewChart(data) {
            const ctx = document.getElementById('revenuePreview').getContext('2d');
            const tx = data.transactions || [];
            // Build continuous date range between selected start/end
            const s = (document.getElementById('startDate')?.value)||new Date().toISOString().slice(0,10);
            const e = (document.getElementById('endDate')?.value)||s;
            const start = new Date(s);
            const end = new Date(e);
            const labels = [];
            const keyDates = [];
            for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                labels.push(d.toLocaleDateString(undefined,{month:'short',day:'numeric'}));
                keyDates.push(d.toISOString().slice(0,10));
            }
            // Group revenue by date
            const byDate = {};
            tx.forEach(t => {
                const k = (t.recorded_at||'').slice(0,10);
                byDate[k] = (byDate[k]||0) + Number(t.total||0);
            });
            const series = keyDates.map(k => byDate[k]||0);
            if (revenuePreviewChart) revenuePreviewChart.destroy();
            revenuePreviewChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{
                    label: 'Revenue', data: series,
                    borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.12)',
                    tension: 0.35, pointRadius: 2, fill: true, borderWidth: 2
                }]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx)=>`₱${Number(ctx.parsed.y).toFixed(2)}` } } },
                    scales: { y: { beginAtZero: true, display:false }, x: { display:false } }
                }
            });
        }

        function createTopProductsPreviewChart(data) {
            const ctx = document.getElementById('topProductsPreview').getContext('2d');
            
            const topProducts = (data.top_fruits || []).slice(0,5);
            const labels = topProducts.map(p => (p.name || p.product_name || 'Unknown'));
            const salesData = topProducts.map(p => p.boxes_sold || p.total_boxes || 0);
            
            if (topProductsPreviewChart) topProductsPreviewChart.destroy();
            topProductsPreviewChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Boxes Sold',
                        data: salesData,
                        backgroundColor: '#10b981',
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display:false }, tooltip:{ callbacks:{ label:(c)=>`${c.parsed.y} boxes` } } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
        }

        function createSalesDistributionPreviewChart(data) {
            const ctx = document.getElementById('salesDistributionPreview').getContext('2d');
            
            // Distribution by product revenue share
            const rows = (data.fruit_summary || []).slice(0,6);
            const labels = rows.map(r => r.name);
            const values = rows.map(r => Number(r.revenue||0));
            const colors = ['#0ea5e9','#22c55e','#f59e0b','#ef4444','#6366f1','#14b8a6'];
            
            if (salesDistributionPreviewChart) salesDistributionPreviewChart.destroy();
            salesDistributionPreviewChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data: values, backgroundColor: colors.slice(0,labels.length), borderWidth: 0, cutout: '68%' }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display:false }, tooltip:{ callbacks:{ label:(c)=>`${c.label}: ₱${Number(c.parsed).toFixed(2)}` } } }
                }
            });
        }

        function createInventoryHealthPreviewChart(data) {
            const ctx = document.getElementById('inventoryHealthPreview').getContext('2d');
            
            const lowStockCount = (data.low_stock||[]).length;
            const totalProducts = (data.fruit_summary||[]).length;
            const healthyStockCount = Math.max(0, totalProducts - lowStockCount);
            
            if (inventoryHealthPreviewChart) inventoryHealthPreviewChart.destroy();
            inventoryHealthPreviewChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Healthy', 'Low'],
                    datasets: [{ data: [healthyStockCount, lowStockCount], backgroundColor: ['#10b981','#ef4444'], borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>`${c.label}: ${c.parsed} items` } } }
                }
            });
        }

        // Initial load
        loadReports();

        // Mobile sidebar toggle functionality
        const sidebar = document.querySelector('.sidebar');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');

        function toggleMobileMenu() {
            if (sidebar) {
                sidebar.classList.toggle('active');
                console.log('Mobile sidebar toggled:', sidebar.classList.contains('active'));
                // Prevent body scroll when sidebar is open on mobile
                if (sidebar.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }

        // Handle mobile menu toggle click
        if (mobileMenuToggle) {
            console.log('Mobile menu button found in reports_full');
            mobileMenuToggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Mobile menu button clicked in reports_full');
                toggleMobileMenu();
            });
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768 && sidebar && sidebar.classList.contains('active')) {
                if (!sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                    document.body.style.overflow = '';
                    console.log('Mobile sidebar closed from outside click');
                }
            }
        });

        // Close sidebar when clicking on navigation links
        if (sidebar) {
            const navLinks = sidebar.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                        document.body.style.overflow = '';
                        console.log('Mobile sidebar closed from nav link click');
                    }
                });
            });
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768 && sidebar) {
                sidebar.classList.remove('active');
                document.body.style.overflow = '';
                console.log('Mobile sidebar closed on resize');
            }
        });

        // Handle escape key to close sidebar
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                document.body.style.overflow = '';
                console.log('Mobile sidebar closed from escape key');
            }
        });

        // ============================================================================
        // INVENTORY REPORTS FUNCTIONALITY
        // ============================================================================
        
        // Global variables for inventory report modals
        let currentInventoryReportData = null;
        let currentInventoryReportType = null;

        // View inventory report in modal
        function viewInventoryReport(reportType) {
            showInventoryLoadingState();
            currentInventoryReportType = reportType;
            
            // Fetch report data
            const endpoints = {
                'stock': '/api/inventory/reports/stock/',
                'movement': '/api/inventory/reports/movement/',
                'batches': '/api/inventory/reports/batches/',
                'turnover': '/api/inventory/reports/turnover/',
                'suppliers': '/api/inventory/reports/suppliers/'
            };
            
            if (!endpoints[reportType]) {
                hideInventoryLoadingState();
                alert('Invalid report type');
                return;
            }
            
            fetch(endpoints[reportType])
                .then(response => response.json())
                .then(data => {
                    hideInventoryLoadingState();
                    if (data.success) {
                        currentInventoryReportData = data;
                        displayInventoryReportModal(reportType, data);
                    } else {
                        alert('Error loading report: ' + data.message);
                    }
                })
                .catch(error => {
                    hideInventoryLoadingState();
                    console.error('Error fetching inventory report:', error);
                    alert('Error loading report. Please try again.');
                });
        }

        // Download PDF inventory report
        function downloadInventoryPDF(reportType) {
            showInventoryLoadingState();
            
            const url = `/api/inventory/reports/pdf/?type=${reportType}`;
            
            // Create a temporary link to download the PDF
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory_report_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            hideInventoryLoadingState();
        }

        // Display inventory report in modal
        function displayInventoryReportModal(reportType, data) {
            const reportTitles = {
                'stock': 'Stock Snapshot Report',
                'movement': 'Stock Movement Report',
                'batches': 'Active Batches Report',
                'turnover': 'Inventory Turnover Report',
                'suppliers': 'Supplier Analysis Report'
            };
            
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="inventoryReportModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${reportTitles[reportType]}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="report-content">
                                    ${generateInventoryReportHTML(reportType, data)}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-danger" onclick="downloadInventoryPDF('${reportType}')">
                                    <i class="bi bi-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#inventoryReportModal').remove();
            
            // Add modal to body and show
            $('body').append(modalHtml);
            $('#inventoryReportModal').modal('show');
        }

        // Generate HTML for different inventory report types
        function generateInventoryReportHTML(reportType, data) {
            switch (reportType) {
                case 'stock':
                    return generateInventoryStockReportHTML(data);
                case 'movement':
                    return generateInventoryMovementReportHTML(data);
                case 'batches':
                    return generateInventoryBatchesReportHTML(data);
                case 'turnover':
                    return generateInventoryTurnoverReportHTML(data);
                case 'suppliers':
                    return generateInventorySuppliersReportHTML(data);
                default:
                    return '<p>Report type not supported</p>';
            }
        }

        // Generate Stock Report HTML
        function generateInventoryStockReportHTML(data) {
            const summary = data.summary;
            let html = `
                <div class="inventory-report-summary mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="inventory-summary-card">
                                <h6>Total Products</h6>
                                <div class="inventory-summary-value">${summary.total_products}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="inventory-summary-card">
                                <h6>Total Stock</h6>
                                <div class="inventory-summary-value">${summary.total_stock_boxes} boxes</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="inventory-summary-card">
                                <h6>Stock Value</h6>
                                <div class="inventory-summary-value">₱${summary.total_value_price.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="inventory-summary-card">
                                <h6>Low Stock Items</h6>
                                <div class="inventory-summary-value text-warning">${summary.low_stock_count}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Size</th>
                                <th>Stock</th>
                                <th>Unit Price</th>
                                <th>Stock Value</th>
                                <th>Margin %</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.data.forEach(item => {
                const statusClass = item.low_stock_flag ? 'text-warning' : 'text-success';
                const statusIcon = item.low_stock_flag ? '⚠️' : '✅';
                html += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.size || 'N/A'}</td>
                        <td>${item.current_stock}</td>
                        <td>₱${item.unit_price.toFixed(2)}</td>
                        <td>₱${item.stock_value_price.toLocaleString()}</td>
                        <td>${item.margin_pct.toFixed(1)}%</td>
                        <td class="${statusClass}">${statusIcon}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        // Generate Movement Report HTML
        function generateInventoryMovementReportHTML(data) {
            const summary = data.summary;
            let html = `
                <div class="inventory-report-summary mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="inventory-summary-card">
                                <h6>Total Movements</h6>
                                <div class="inventory-summary-value">${summary.total_movements}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="inventory-summary-card">
                                <h6>Net Movement</h6>
                                <div class="inventory-summary-value">${summary.net_movement} boxes</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="inventory-summary-card">
                                <h6>Period</h6>
                                <div class="inventory-summary-value small">${summary.date_range}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Product</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Batch/Reference</th>
                                <th>Supplier</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.data.forEach(item => {
                const typeClass = item.type === 'Addition' ? 'text-success' : 'text-danger';
                const quantityDisplay = item.type === 'Addition' ? `+${item.quantity}` : Math.abs(item.quantity);
                html += `
                    <tr>
                        <td>${item.date}</td>
                        <td>${item.time}</td>
                        <td>${item.product_name}</td>
                        <td class="${typeClass}">${item.type}</td>
                        <td class="${typeClass}">${quantityDisplay}</td>
                        <td><code>${item.batch_id}</code></td>
                        <td>${item.supplier}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        // Generate other inventory report HTML functions (simplified for brevity)
        function generateInventoryBatchesReportHTML(data) {
            return generateInventoryGenericTableReport(data, [
                { key: 'batch_id', title: 'Batch ID', format: 'code' },
                { key: 'product_name', title: 'Product' },
                { key: 'date_added', title: 'Date Added' },
                { key: 'remaining_quantity', title: 'Remaining' },
                { key: 'age_days', title: 'Age (Days)' },
                { key: 'age_category', title: 'Category', format: 'badge' }
            ]);
        }

        function generateInventoryTurnoverReportHTML(data) {
            return generateInventoryGenericTableReport(data, [
                { key: 'product_name', title: 'Product' },
                { key: 'current_stock', title: 'Stock' },
                { key: 'sales_qty_30d', title: '30d Sales' },
                { key: 'daily_sales_rate', title: 'Daily Rate' },
                { key: 'days_of_cover', title: 'Days Cover' },
                { key: 'velocity_category', title: 'Velocity', format: 'badge' }
            ]);
        }

        function generateInventorySuppliersReportHTML(data) {
            return generateInventoryGenericTableReport(data, [
                { key: 'supplier_name', title: 'Supplier' },
                { key: 'total_deliveries', title: 'Deliveries' },
                { key: 'total_boxes', title: 'Total Boxes' },
                { key: 'unique_products', title: 'Products' },
                { key: 'avg_delivery_size', title: 'Avg Size' },
                { key: 'days_since_last_delivery', title: 'Days Since Last' }
            ]);
        }

        // Generic table report generator for inventory
        function generateInventoryGenericTableReport(data, columns) {
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
            
            columns.forEach(col => {
                html += `<th>${col.title}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            data.data.forEach(item => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = item[col.key];
                    if (col.format === 'code') {
                        value = `<code>${value}</code>`;
                    } else if (col.format === 'badge') {
                        const badgeClass = getInventoryBadgeClass(value);
                        value = `<span class="badge ${badgeClass}">${value}</span>`;
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        // Helper function for inventory badge classes
        function getInventoryBadgeClass(value) {
            const badgeMap = {
                'Fresh': 'bg-success',
                'Aging': 'bg-warning',
                'Old': 'bg-danger',
                'Fast': 'bg-success',
                'Medium': 'bg-warning',
                'Slow': 'bg-danger',
                'Normal': 'bg-success',
                'Low Stock': 'bg-warning',
                'Overstocked': 'bg-info',
                'Out of Stock': 'bg-danger'
            };
            return badgeMap[value] || 'bg-secondary';
        }

        // Loading state functions for inventory reports
        function showInventoryLoadingState() {
            // Create loading overlay if it doesn't exist
            if (!$('#inventoryLoadingOverlay').length) {
                $('body').append(`
                    <div id="inventoryLoadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `);
            }
            $('#inventoryLoadingOverlay').show();
        }

        function hideInventoryLoadingState() {
            $('#inventoryLoadingOverlay').hide();
        }

        // Add custom CSS for inventory report modals
        $('<style>').text(`
            .inventory-report-summary {
                background: #f8f9fa;
                padding: 1.5rem;
                border-radius: 12px;
                margin-bottom: 1.5rem;
            }
            .inventory-summary-card {
                text-align: center;
                padding: 1.25rem;
                background: white;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 1rem;
            }
            .inventory-summary-card h6 {
                margin-bottom: 0.75rem;
                color: #6c757d;
                font-size: 0.85rem;
                text-transform: uppercase;
                font-weight: 600;
            }
            .inventory-summary-value {
                font-size: 1.75rem;
                font-weight: bold;
                color: #495057;
            }
            #inventoryReportModal .modal-dialog {
                max-width: 95%;
            }
            #inventoryReportModal .table {
                font-size: 0.9rem;
            }
            #inventoryReportModal .modal-header {
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border-radius: 0.5rem 0.5rem 0 0;
            }
            #inventoryReportModal .btn-close {
                filter: invert(1);
            }
        `).appendTo('head');
    </script>
</body>
</html> 